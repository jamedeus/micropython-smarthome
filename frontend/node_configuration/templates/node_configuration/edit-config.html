{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
    <title>Create new config file</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="{% static 'node_configuration/bootstrap.min.css' %}">
    <link rel="stylesheet" href="{% static 'node_configuration/style.css' %}">
    <script src="{% static 'node_configuration/bootstrap.min.js' %}"></script>
    <script src="{% static 'node_configuration/jquery.min.js' %}"></script>
    <script src="{% static 'node_configuration/smoothscroll.min.js' %}"></script>
    <style>
        /* Set table column to minimum width with class */
        td {
            width: auto;
        }

        td.min {
            width: 1%;
            white-space: nowrap;
        }
        /* ----- */

        /* Upload complete checkmark animation */
        .light {
            --success: #198754;
        }

        .dark {
            --success: #177a4c;
        }

        .checkmark__circle {
            stroke-dasharray: 166;
            stroke-dashoffset: 166;
            stroke-width: 2;
            stroke-miterlimit: 10;
            stroke: var(--success);
            fill: none;
            animation: stroke 0.6s cubic-bezier(0.65, 0, 0.45, 1) forwards;
        }

        .checkmark {
            width: 3rem;
            height: 3rem;
            border-radius: 50%;
            display: block;
            stroke-width: 2;
            stroke: #fff;
            stroke-miterlimit: 10;
            box-shadow: inset 0px 0px 0px var(--success);
            animation: fill .4s ease-in-out .4s forwards, scale .3s ease-in-out .9s both;
        }

        .checkmark__check {
            transform-origin: 50% 50%;
            stroke-dasharray: 48;
            stroke-dashoffset: 48;
            animation: stroke 0.3s cubic-bezier(0.65, 0, 0.45, 1) 0.8s forwards;
        }

        @keyframes stroke {
            100% {
                stroke-dashoffset: 0;
            }
        }

        @keyframes scale {
            0%, 100% {
                transform: none;
            }
            50% {
                transform: scale3d(1.1, 1.1, 1);
            }
        }

        @keyframes fill {
            100% {
                box-shadow: inset 0px 0px 0px 30px var(--success);
            }
        }
        /* ----- */

        /* Limit width for readability on large screen sizes */
        @media (min-width: 1200px) {
            .container {
                width: 960px;
            }
        }
        /* ----- */

        .modal-dropdown {
            background-color: #1b1e1f !important;
        }
    </style>
</head>

<body>
    <script>
        // Check if user is in dark mode, change theme (runs once on page load)
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.body.classList.add("dark");
            console.log("Dark mode");
        } else {
            document.body.classList.add("light");
        };
    </script>

    <div class="container d-flex flex-column vh-100">
        <h1 class="text-center pt-3 pb-4">{{ context.config.TITLE }}</h1>

        {% if context %}

            <form id="form" class="h-100" onkeydown="return event.key != 'Enter';">

                <div id="page1" class="d-flex flex-column h-100">

                    <div  class="mb-4">
                        <h2>Metadata</h2>

                        <div class="mb-2">
                            <label for="friendlyName"><b>Name:</b></label>
                            <input type="text" class="form-control" id="friendlyName" placeholder="" name="friendlyName" value="{{context.config.NAME}}" required>
                        </div>

                        <div class="mb-2">
                            <label for="location"><b>Location:</b></label>
                            <input type="text" class="form-control" id="location" placeholder="" name="location" value="{{context.config.metadata.location}}" required>
                        </div>

                        <div class="mb-2">
                            <label for="floor"><b>Floor:</b></label>
                            <input type="text" class="form-control" id="floor" placeholder="" name="floor" value="{{context.config.metadata.floor}}" required>
                        </div>
                    </div>

                    <div class="mb-4">
                        <h2>Wifi</h2>

                        <div class="mb-2">
                            <label for="ssid"><b>SSID:</b></label>
                            <input type="text" class="form-control" id="ssid" placeholder="" name="ssid" value="{{context.config.wifi.ssid}}" required>
                        </div>

                        <div class="mb-2">
                            <label for="password"><b>Password:</b></label>
                            <input type="password" class="form-control" id="password" placeholder="" name="password" value="{{context.config.wifi.password}}" required>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-sm">
                            <h2>Add Sensors</h2>

                            {% for sensor, params in context.config.sensors.items %}

                                {% if forloop.first %}
                                    <div id="addSensorDiv1">
                                {% else %}
                                    <div id="addSensorDiv{{ forloop.counter }}" class="mt-5">
                                {% endif %}
                                    <div class="card">
                                        <div class="card-body">
                                            <h4 class="card-title">sensor{{ forloop.counter }}</h4>
                                            <label for="sensorType{{ forloop.counter }}" class="form-label"><b>Type:</b></label>
                                            <div>
                                                <select onchange="load_sensor_section(this)" name="sensorType{{ forloop.counter }}" id="sensorType{{ forloop.counter }}" class="form-select sensorType" autocomplete="off" required>
                                                <option value="clear">Select sensor type</option>
                                                <option value="pir" {% if params.type == "pir" %} selected {% endif %}>Motion Sensor</option>
                                                <option value="switch" {% if params.type == "switch" %} selected {% endif %}>Switch</option>
                                                <option value="dummy" {% if params.type == "dummy" %} selected {% endif %}>Dummy</option>
                                                <option value="desktop" {% if params.type == "desktop" %} selected {% endif %}>Desktop</option>
                                                <option value="si7021" {% if params.type == "si7021" %} selected {% endif %}>Thermostat</option>
                                                </select>
                                            </div>

                                            <div id="addSensorOptions{{ forloop.counter }}" class="card-body">
                                                <div class="mb-2">
                                                    <label for="sensor{{forloop.counter}}-nickname"><b>Nickname:</b></label>
                                                    <input type="text" class="form-control" id="sensor{{forloop.counter}}-nickname" placeholder="" name="sensor{{forloop.counter}}-nickname" value="{{params.nickname}}" required>
                                                </div>

                                            {% if params.type == "pir" %}

                                                    <div class="mb-2">
                                                        <label for="sensor{{forloop.counter}}-pin"><b>Pin:</b></label>
                                                        <input type="text" class="form-control" id="sensor{{forloop.counter}}-pin" placeholder="" name="sensor{{forloop.counter}}-pin" value="{{params.pin}}" required>
                                                    </div>

                                                    <div class="mb-2">
                                                        <label for="sensor{{forloop.counter}}-default_rule"><b>Default Rule:</b></label>
                                                        <input type="default_rule" class="form-control" id="sensor{{forloop.counter}}-default_rule" placeholder="" name="sensor{{forloop.counter}}-default_rule" value="{{params.default_rule}}" required>
                                                    </div>

                                            {% elif params.type == "switch" %}

                                                    <div class="mb-2">
                                                        <label for="sensor{{forloop.counter}}-pin"><b>Pin:</b></label>
                                                        <input type="text" class="form-control" id="sensor{{forloop.counter}}-pin" placeholder="" name="sensor{{forloop.counter}}-pin" value="{{params.pin}}" required>
                                                    </div>

                                                    <div class="mb-2">
                                                        <label for="sensor{{forloop.counter}}-default_rule"><b>Default Rule:</b></label>
                                                        <input type="default_rule" class="form-control" id="sensor{{forloop.counter}}-default_rule" placeholder="" name="sensor{{forloop.counter}}-default_rule" value="{{params.default_rule}}" required>
                                                    </div>

                                            {% elif params.type == "dummy" %}

                                                    <div class="mb-2">
                                                        <label for="sensor{{forloop.counter}}-default_rule"><b>Default Rule:</b></label>
                                                        <input type="default_rule" class="form-control" id="sensor{{forloop.counter}}-default_rule" placeholder="" name="sensor{{forloop.counter}}-default_rule" value="{{params.default_rule}}" required>
                                                    </div>

                                            {% elif params.type == "desktop" %}

                                                    <div class="mb-2">
                                                        <label for="sensor{{forloop.counter}}-ip"><b>IP:</b></label>
                                                        <input type="text" class="form-control" id="sensor{{forloop.counter}}-ip" placeholder="" name="sensor{{forloop.counter}}-ip" value="{{params.ip}}" required>
                                                    </div>

                                                    <div class="mb-2">
                                                        <label for="sensor{{forloop.counter}}-default_rule"><b>Default Rule:</b></label>
                                                        <input type="text" class="form-control" id="sensor{{forloop.counter}}-default_rule" placeholder="" name="sensor{{forloop.counter}}-default_rule" value="{{params.default_rule}}" required>
                                                    </div>

                                            {% elif params.type == "si7021" %}

                                                    <div class="mb-2">
                                                        <label for="sensor{{forloop.counter}}-default_rule"><b>Default Rule:</b></label>
                                                        <input type="default_rule" class="form-control" id="sensor{{forloop.counter}}-default_rule" placeholder="" name="sensor{{forloop.counter}}-default_rule" value="{{params.default_rule}}" required>
                                                    </div>

                                                    <div class="mb-2">
                                                        <label class="form-label" for="sensor{{forloop.counter}}-mode"><b>Mode:</b></label>
                                                        <select name="sensor{{forloop.counter}}-mode" id="sensor{{forloop.counter}}-mode" class="form-select mb-3" required>
                                                            {% if params.mode == "cool" %}
                                                                <option value="cool" id="cool" selected>Cool</option>
                                                                <option value="heat" id="heat">Heat</option>
                                                            {% elif params.mode == "heat" %}
                                                                <option value="cool" id="cool">Cool</option>
                                                                <option value="heat" id="heat" selected>Heat</option>
                                                            {% else %}
                                                                <option value="cool" id="cool">Cool</option>
                                                                <option value="heat" id="heat">Heat</option>
                                                            {% endif %}
                                                        </select>
                                                    </div>

                                                    <div class="mb-2">
                                                        <label for="sensor{{forloop.counter}}-tolerance"><b>Tolerance:</b></label>
                                                        <input type="text" class="form-control" id="sensor{{forloop.counter}}-tolerance" placeholder="" name="sensor{{forloop.counter}}-tolerance" value="{{params.tolerance}}" required>
                                                    </div>

                                            {% endif %}
                                            </div>
                                        </div>
                                    </div>

                                    {% if forloop.last %}
                                        <div class="text-center">
                                            <button onclick="load_next_sensor(this)" type="button" id="addSensorButton{{ forloop.counter }}" class="btn-secondary btn my-3">Add another</button>
                                        </div>
                                        <div id="addSensorDiv{{ forloop.counter|add:1 }}"></div>
                                    {% endif  %}

                                </div>
                            {% endfor %}

                            {% if context.config.sensors|length == 0 %}
                                <div class="text-center">
                                    <button onclick="load_next_sensor(this)" type="button" id="addSensorButton0" class="btn-secondary btn my-3">Add another</button>
                                </div>
                                <div id="addSensorDiv1"></div>
                            {% endif %}

                        </div>

                        <div class="col-sm">
                            <h2>Add Devices</h2>

                            {% for device, params in context.config.devices.items %}

                                {% if forloop.first %}
                                    <div id="addDeviceDiv1">
                                {% else %}
                                    <div id="addDeviceDiv{{ forloop.counter }}" class="mt-5">
                                {% endif %}
                                    <div class="card">
                                        <div class="card-body">
                                            <h4 class="card-title">device{{ forloop.counter }}</h4>
                                            <label for="deviceType{{ forloop.counter }}" class="form-label"><b>Type:</b></label>
                                            <div>
                                                <select onchange="load_device_section(this)" name="deviceType{{ forloop.counter }}" id="deviceType{{ forloop.counter }}" class="form-select deviceType" autocomplete="off" required>
                                                <option value="clear">Select device type</option>
                                                <option value="dimmer" {% if params.type == "dimmer" %} selected {% endif %}>TP-Link Dimmer</option>
                                                <option value="bulb" {% if params.type == "bulb" %} selected {% endif %}>TP-Link Bulb</option>
                                                <option value="relay" {% if params.type == "relay" %} selected {% endif %}>Smart Relay</option>
                                                <option value="dumb-relay" {% if params.type == "dumb-relay" %} selected {% endif %}>Relay</option>
                                                <option value="desktop" {% if params.type == "desktop" %} selected {% endif %}>Desktop</option>
                                                <option value="pwm" {% if params.type == "pwm" %} selected {% endif %}>LED Strip</option>
                                                <option value="mosfet" {% if params.type == "mosfet" %} selected {% endif %}>Mosfet</option>
                                                <option value="api-target" {% if params.type == "api-target" %} selected {% endif %}>Api Command</option>
                                                <option value="ir-blaster">IR Blaster</option>
                                                </select>
                                            </div>

                                            <div id="addDeviceOptions{{ forloop.counter }}" class="card-body">
                                                <div class="mb-2">
                                                    <label for="device{{forloop.counter}}-nickname"><b>Nickname:</b></label>
                                                    <input type="text" class="form-control" id="device{{forloop.counter}}-nickname" placeholder="" name="device{{forloop.counter}}-nickname" value="{{params.nickname}}" required>
                                                </div>

                                            {% if params.type == "dimmer" %}
                                                    <div class="mb-2">
                                                        <label for="device{{ forloop.counter }}-ip"><b>IP:</b></label>
                                                        <input type="text" class="form-control" id="device{{ forloop.counter }}-ip" placeholder="" name="device{{ forloop.counter }}-ip" value="{{params.ip}}" required>
                                                    </div>

                                                    <div class="mb-2">
                                                        <label for="device{{ forloop.counter }}-default_rule"><b>Default Rule:</b></label>
                                                        <input type="default_rule" class="form-control" id="device{{ forloop.counter }}-default_rule" placeholder="" name="device{{ forloop.counter }}-default_rule" value="{{params.default_rule}}" required>
                                                    </div>

                                            {% elif params.type == "bulb" %}
                                                    <div class="mb-2">
                                                        <label for="device{{ forloop.counter }}-ip"><b>IP:</b></label>
                                                        <input type="text" class="form-control" id="device{{ forloop.counter }}-ip" placeholder="" name="device{{ forloop.counter }}-ip" value="{{params.ip}}" required>
                                                    </div>

                                                    <div class="mb-2">
                                                        <label for="device{{ forloop.counter }}-default_rule"><b>Default Rule:</b></label>
                                                        <input type="default_rule" class="form-control" id="device{{ forloop.counter }}-default_rule" placeholder="" name="device{{ forloop.counter }}-default_rule" value="{{params.default_rule}}" required>
                                                    </div>

                                            {% elif params.type == "relay" %}
                                                    <div class="mb-2">
                                                        <label for="device{{ forloop.counter }}-ip"><b>IP:</b></label>
                                                        <input type="text" class="form-control" id="device{{ forloop.counter }}-ip" placeholder="" name="device{{ forloop.counter }}-ip" value="{{params.ip}}" required>
                                                    </div>

                                                    <div class="mb-2">
                                                        <label for="device{{ forloop.counter }}-default_rule"><b>Default Rule:</b></label>
                                                        <input type="default_rule" class="form-control" id="device{{ forloop.counter }}-default_rule" placeholder="" name="device{{ forloop.counter }}-default_rule" value="{{params.default_rule}}" required>
                                                    </div>

                                            {% elif params.type == "dumb-relay" %}
                                                    <div class="mb-2">
                                                        <label for="device{{ forloop.counter }}-pin"><b>Pin:</b></label>
                                                        <input type="text" class="form-control" id="device{{ forloop.counter }}-pin" placeholder="" name="device{{ forloop.counter }}-pin" value="{{params.pin}}" required>
                                                    </div>

                                                    <div class="mb-2">
                                                        <label for="device{{ forloop.counter }}-default_rule"><b>Default Rule:</b></label>
                                                        <input type="default_rule" class="form-control" id="device{{ forloop.counter }}-default_rule" placeholder="" name="device{{ forloop.counter }}-default_rule" value="{{params.default_rule}}" required>
                                                    </div>

                                            {% elif params.type == "desktop" %}
                                                    <div class="mb-2">
                                                        <label for="device{{ forloop.counter }}-ip"><b>IP:</b></label>
                                                        <input type="text" class="form-control" id="device{{ forloop.counter }}-ip" placeholder="" name="device{{ forloop.counter }}-ip" value="{{params.ip}}" required>
                                                    </div>

                                                    <div class="mb-2">
                                                        <label for="device{{ forloop.counter }}-default_rule"><b>Default Rule:</b></label>
                                                        <input type="default_rule" class="form-control" id="device{{ forloop.counter }}-default_rule" placeholder="" name="device{{ forloop.counter }}-default_rule" value="{{params.default_rule}}" required>
                                                    </div>

                                            {% elif params.type == "pwm" %}
                                                    <div class="mb-2">
                                                        <label for="device{{ forloop.counter }}-pin"><b>Pin:</b></label>
                                                        <input type="text" class="form-control" id="device{{ forloop.counter }}-pin" placeholder="" name="device{{ forloop.counter }}-pin" value="{{params.pin}}" required>
                                                    </div>

                                                    <div class="mb-2">
                                                        <label for="device{{ forloop.counter }}-min"><b>Min brightness:</b></label>
                                                        <input type="min" class="form-control" id="device{{ forloop.counter }}-min" placeholder="0" name="device{{ forloop.counter }}-min" value="{{params.min}}" required>
                                                    </div>

                                                    <div class="mb-2">
                                                        <label for="device{{ forloop.counter }}-max"><b>Max brightness:</b></label>
                                                        <input type="text" class="form-control" id="device{{ forloop.counter }}-max" placeholder="1023" name="device{{ forloop.counter }}-max" value="{{params.max}}" required>
                                                    </div>

                                                    <div class="mb-2">
                                                        <label for="device{{ forloop.counter }}-default_rule"><b>Default Rule:</b></label>
                                                        <input type="default_rule" class="form-control" id="device{{ forloop.counter }}-default_rule" placeholder="" name="device{{ forloop.counter }}-default_rule" value="{{params.default_rule}}" required>
                                                    </div>

                                            {% elif params.type == "mosfet" %}
                                                    <div class="mb-2">
                                                        <label for="device{{ forloop.counter }}-pin"><b>Pin:</b></label>
                                                        <input type="text" class="form-control" id="device{{ forloop.counter }}-pin" placeholder="" name="device{{ forloop.counter }}-pin" value="{{params.pin}}" required>
                                                    </div>

                                                    <div class="mb-2">
                                                        <label for="device{{ forloop.counter }}-default_rule"><b>Default Rule:</b></label>
                                                        <input type="default_rule" class="form-control" id="device{{ forloop.counter }}-default_rule" placeholder="" name="device{{ forloop.counter }}-default_rule" value="{{params.default_rule}}" required>
                                                    </div>

                                            {% elif params.type == "api-target" %}
                                                    <label for="device{{ forloop.counter }}-ip"><b>Target:</b></label>
                                                    <select name="device{{ forloop.counter }}-ip" id="device{{ forloop.counter }}-ip" class="form-select mb-3" onchange="api_target_selected(this)">
                                                        <option value="" selected="selected"></option>
                                                        {% for node in context.api_target_options %}
                                                            <option value="{{node}}" {% if params.ip in node %}selected{% endif %}>{{node}}</option>
                                                        {% endfor %}
                                                    </select>

                                                    <div class="mb-2 text-center">
                                                        <button id="device{{ forloop.counter }}-set-rule" class="btn btn-secondary mt-3" onclick="open_rule_modal(this);" type="button">Set rule</button>
                                                    </div>

                                                    <div class="mb-2 text-center">
                                                        <label for="device{{ forloop.counter }}-default_rule" style="display:none;"><b>Default Rule:</b></label>
                                                        <input type="default_rule" class="form-control" id="device{{ forloop.counter }}-default_rule" placeholder="" name="device{{ forloop.counter }}-default_rule" style="display:none;" value="{{params.default_rule}}" required>
                                                    </div>

                                            {% endif %}
                                            </div>
                                        </div>
                                    </div>

                                    {% if forloop.last %}
                                        <div class="text-center">
                                            <button onclick="load_next_device(this)" type="button" id="addDeviceButton{{ forloop.counter }}" class="btn-secondary btn my-3">Add another</button>
                                        </div>
                                        <div id="addDeviceDiv{{ forloop.counter|add:1 }}"></div>
                                    {% endif  %}

                                </div>
                            {% endfor %}

                            {% if context.config.ir_blaster %}

                                <div id="addDeviceDiv{{ context.config.devices|length|add:1 }}" {% if context.config.devices|length %}class="mt-5"{% endif %}>
                                    <div class="card">
                                        <div class="card-body">
                                            <h4 class="card-title">device{{ context.config.devices|length|add:1 }}</h4>
                                            <label for="deviceType{{ context.config.devices|length|add:1 }}" class="form-label"><b>Type:</b></label>
                                            <div>
                                                <select onchange="load_device_section(this)" name="deviceType{{ context.config.devices|length|add:1 }}" id="deviceType{{ context.config.devices|length|add:1 }}" class="form-select deviceType" required>
                                                <option value="clear">Select device type</option>
                                                <option value="dimmer">TP-Link Dimmer</option>
                                                <option value="bulb">TP-Link Bulb</option>
                                                <option value="relay">Smart Relay</option>
                                                <option value="dumb-relay">Relay</option>
                                                <option value="desktop">Desktop</option>
                                                <option value="pwm">LED Strip</option>
                                                <option value="mosfet">Mosfet</option>
                                                <option value="api-target">Api Command</option>
                                                <option value="ir-blaster" selected>IR Blaster</option>
                                                </select>
                                            </div>

                                            <div id="addDeviceOptions{{ context.config.devices|length|add:1 }}" class="card-body">
                                                <div class="mb-2">
                                                    <label for="device{{ context.config.devices|length|add:1 }}-pin"><b>Pin:</b></label>
                                                    <input type="text" class="form-control" id="device{{ context.config.devices|length|add:1 }}-pin" value="{{ context.config.ir_blaster.pin }}" name="device{{ context.config.devices|length|add:1 }}-pin" required>
                                                </div>

                                                <div class="mb-2">
                                                    <label for="device{{ context.config.devices|length|add:1 }}-min"><b>Virtual remotes:</b></label>
                                                    <div class="form-check">
                                                        <input class="form-check-input" type="checkbox" name="irblaster-tv" value="irblaster-tv" id="irblaster-tv" {% if "tv" in context.config.ir_blaster.target %}checked{% endif %}>
                                                        <label class="form-check-label" for="checkbox-tv">TV (Samsung)</label></br>
                                                        <input class="form-check-input" type="checkbox" name="irblaster-ac" value="irblaster-ac" id="irblaster-ac" {% if "ac" in context.config.ir_blaster.target %}checked{% endif %}>
                                                        <label class="form-check-label" for="checkbox-ac">AC (Whynter)</label>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                            {% endif %}

                            {% if context.config.devices|length == 0 %}
                                {% if context.config.ir_blaster %}
                                    <div class="text-center">
                                        <button onclick="load_next_device(this)" type="button" id="addDeviceButton1" class="btn-secondary btn my-3">Add another</button>
                                    </div>
                                    <div id="addDeviceDiv2"></div>
                                {% else %}
                                    <div class="text-center">
                                        <button onclick="load_next_device(this)" type="button" id="addDeviceButton0" class="btn-secondary btn my-3">Add another</button>
                                    </div>
                                    <div id="addDeviceDiv1"></div>
                                {% endif %}
                            {% endif %}

                        </div>
                    </div>

                    <div class="d-flex justify-content-between mx-3 mt-auto">
                        <button id="page1-back-button" type="button" class="btn btn-secondary mb-3">Back</button>
                        <button type="button" class="btn btn-primary mb-3" style="visibility: hidden;">Submit</button>
                        <button id="page1-button" type="button" class="btn btn-primary mb-3">Next</button>
                    </div>
                </div>

                <div id="page2" class="flex-column h-100">
                    <div id="page2-cards">
                        <h3>Select targets for each sensor</h3>

                        {% for sensor, params in context.config.sensors.items %}

                            <div class="card mb-4">
                                <div class="card-body">
                                    <label for="{{sensor}}-targets" class="card-title sensor-targets-label"><b>{{ sensor }} ({{ params.type }}) targets:</b></label>
                                    <div id="{{sensor}}-targets" class="form-check sensor-targets">

                                        {% for device, dparams in context.config.devices.items %}

                                            <input type="checkbox" class="form-check-input" id="target-{{sensor}}-{{device}}" name="target-{{sensor}}-{{device}}" value="target-{{sensor}}-{{device}}" {% if device in params.targets %}checked{% endif %}>
                                            <label for="target-{{sensor}}-{{device}}" class="form-check-label">{{ device }} ({{ dparams.type }})</label><br>

                                        {% endfor %}
                                    </div>
                                </div>
                            </div>

                        {% endfor %}
                    </div>

                    <div class="d-flex justify-content-between mx-3 mt-auto">
                        <button id="page2-back-button" type="button" class="btn btn-primary mb-3">Back</button>
                        <button type="button" class="btn btn-primary mb-3" style="visibility: hidden;">Submit</button>
                        <button id="page2-button" type="button" class="btn btn-primary mb-3">Next</button>
                    </div>
                </div>

                <div id="page3" class="flex-column h-100">
                    <h3>Add schedule rules (optional)</h3>
                        <div id="page3-cards">
                        {% for instance, params in context.config.instances.items %}

                            <div class="card mb-4">
                                <div class="card-body">
                                    <label class="card-title schedule-rule-card"><b>{{ instance }} ({{ params.type }}):</b></label>
                                    <table id="{{instance}}-rules" class="table table-borderless">
                                        <tr>
                                            <th style="text-align: left;">Time</th>
                                            <th style="text-align: left;">Rule</th>
                                        </tr>

                                        {% if params.schedule.items|length > 0 %}
                                            {% for time, rule in params.schedule.items %}
                                                <tr id="{{instance}}-row-{{forloop.counter}}">
                                                    <td><input type="text" class="form-control" id="schedule-{{instance}}-rule{{forloop.counter}}-time" placeholder="HH:MM" name="schedule-{{instance}}-rule{{forloop.counter}}-time" value="{{ time }}"></td>

                                                    {% if not params.type == "api-target" %}
                                                        <td><input type="text" class="form-control" id="schedule-{{instance}}-rule{{forloop.counter}}-value" placeholder="" name="schedule-{{instance}}-rule{{forloop.counter}}-value" value="{{ rule }}"></td>
                                                    {% else %}
                                                        <td style="width: 50%">
                                                            <button id="schedule-{{instance}}-rule{{forloop.counter}}-button" class="form-control" onclick="open_rule_modal(this);" type="button">Set rule</button>
                                                            <input type="text" class="form-control" id="schedule-{{instance}}-rule{{forloop.counter}}-value" name="schedule-{{instance}}-rule{{forloop.counter}}-value" value="{{ rule }}" style="display:none;">
                                                        </td>
                                                    {% endif %}
                                                    <td class="min"><button type="button" class="remove btn btn-danger" id="{{instance}}-remove{{forloop.counter}}"  onclick="remove(this)">X</button></td>
                                                </tr>
                                            {% endfor %}
                                        {% else %}
                                            <tr id="{{instance}}-row-1">
                                                <td><input type="text" class="form-control" id="schedule-{{instance}}-rule1-time" placeholder="HH:MM" name="schedule-{{instance}}-rule1-time"></td>

                                                {% if not params.type == "api-target" %}
                                                    <td><input type="text" class="form-control" id="schedule-{{instance}}-rule1-value" placeholder="HH:MM" name="schedule-{{instance}}-rule1-value"></td>
                                                {% else %}
                                                    <td style="width: 50%">
                                                        {# Show button that opens api rule modal containing dropdowns used to set rule. Selection from modal added to hidden text box, read by form #}
                                                        <button id="schedule-{{instance}}-rule1-button" class="form-control" onclick="open_rule_modal(this);" type="button">Set rule</button>
                                                        <input type="text" class="form-control" id="schedule-{{instance}}-rule1-value" name="schedule-{{instance}}-rule1-value" style="display:none;">
                                                    </td>
                                                {% endif %}

                                                <td class="min"><button type="button" class="remove btn btn-danger" id="{{instance}}-remove1"  onclick="remove(this)">X</button></td>
                                            </tr>
                                        {% endif %}
                                    </table>
                                </div>

                                <div class="text-left mx-3 mb-3">
                                    <button type="button" class="btn btn-secondary" id="{{instance}}-add-rule" onclick="add(this)">Add another</button>
                                </div>

                            </div>

                        {% endfor %}
                        </div>

                    <div class="d-flex justify-content-between mx-3 mt-auto">
                        <button id="page3-back-button" type="button" class="btn btn-primary mb-3">Back</button>
                        <button id="submit-button" type="submit" class="btn btn-primary mb-3">Submit</button>
                        <button type="button" class="btn btn-secondary mb-3" disabled>Next</button>
                    </div>
                </div>

            </form>

            <!-- Loading modal displayed while waiting on upload -->

            <div class="modal fade" id="upload-modal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1">
                <div class="modal-dialog modal-dialog-centered" >
                    <div class="modal-content">
                        <div class="modal-header" style="border-bottom: 0px;">
                            <h3 class="mx-auto" id="upload-modal-title">Uploading...</h3>
                        </div>
                        <div class="modal-body d-flex justify-content-center mb-4" id="upload-modal-body">
                            <div class="spinner-border" style="width: 3rem; height: 3rem;" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Error modal displayed when upload fails -->

            <div class="modal fade" id="error-modal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1">
                <div class="modal-dialog modal-dialog-centered" >
                    <div class="modal-content">
                        <div class="modal-header" style="border-bottom: 0px;">
                            <h3 class="mx-auto" id="error-modal-title">Error</h3>
                        </div>
                        <div class="modal-body d-flex justify-content-center" id="error-modal-body">
                        </div>
                        <div class="modal-footer d-flex justify-content-center" id="error-modal-footer">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Overwrite duplicate modal dialog -->

            <div class="modal fade" id="duplicate-modal" tabindex="-1">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content">
                        <div class="modal-body" id="duplicate-modal-body">
                        </div>
                        <div class="modal-footer">
                            <button type="button" id="cancel-overwrite" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="button" id="confirm-overwrite" class="btn btn-danger" data-bs-dismiss="modal">Overwrite</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Api-target set rule modal -->

            <div class="modal fade" id="api-rule-modal" tabindex="-1">
                <div class="modal-dialog modal-dialog-centered" style="max-width:750px">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Api Target Rule</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body text-center">

                            <p>Explain what this does here</p>

                            <form name="api_rule_form" id="api_rule_form">
                                <div id="on-action">
                                    <select name="instance-on" id="instance-on" class="form-select mb-3 modal-dropdown api-instance">
                                        <option value="" selected="selected">Select target instance</option>
                                    </select>

                                    <select name="command-on" id="command-on" class="form-select mb-3 modal-dropdown api-command">
                                        <option value="" selected="selected">Please select instance first</option>
                                    </select>

                                    <select name="sub-command-on" id="sub-command-on" class="form-select mb-3 modal-dropdown api-command" style="display:none" disabled>
                                        <option value="" selected="selected">Please select command first</option>
                                    </select>

                                    <input name="command-arg-on" id="command-arg-on" class="form-control mb-3 modal-dropdown api-command-arg" style="display:none" disabled>
                                </div>

                                <div id="off-action" style="display:none;">
                                    <select name="instance-off" id="instance-off" class="form-select mb-3 modal-dropdown api-instance">
                                        <option value="" selected="selected">Select target instance</option>
                                    </select>

                                    <select name="command-off" id="command-off" class="form-select mb-3 modal-dropdown api-command">
                                        <option value="" selected="selected">Please select instance first</option>
                                    </select>

                                    <select name="sub-command-off" id="sub-command-off" class="form-select mb-3 modal-dropdown api-command" style="display:none" disabled>
                                        <option value="" selected="selected">Please select command first</option>
                                    </select>

                                    <input name="command-arg-off" id="command-arg-off" class="form-control mb-3 modal-dropdown api-command-arg" style="display:none" disabled>
                                </div>
                            </form>

                            <div class="btn-group" role="group" aria-label="Basic radio toggle button group">
                                <input type="radio" class="btn-check" name="btnradio" id="on-button" autocomplete="off" onclick="switch_page(this)" checked>
                                <label class="btn btn-outline-dark" for="on-button">On Action</label>

                                <input type="radio" class="btn-check" name="btnradio" id="off-button" autocomplete="off" onclick="switch_page(this)">
                                <label class="btn btn-outline-dark" for="off-button">Off Action</label>
                            </div>

                        </div>
                        <div class="modal-footer">
                            <button type="button" id="submit-api-rule" class="btn btn-success mx-auto" data-bs-dismiss="modal" onclick="submit_api_rule(this)">Submit</button>
                        </div>
                    </div>
                </div>
            </div>

        {% else %}
            <p>FATAL ERROR</p>
        {% endif %}
    </div>

    {{ context.api_target_options|json_script:"context" }}

    <script>
        $('#page2').hide();
        $('#page3').hide();

        var ApiTargetOptions = JSON.parse(document.getElementById("context").textContent);

        const base_url = window.location.href.split("edit_config")[0];

        // Store parameters used to re-upload config after editing
        const target_ip = "{{ context.config.IP }}"
        const target_filename = "{{ context.config.FILENAME }}"

        // Track if an IrBlaster is configured (cannot have multiple)
        ir_blaster_configured = false;
        for (device of document.getElementsByClassName("deviceType")) {
            if (device.value == "ir-blaster") {
                ir_blaster_configured = true;
            };
        };

        {# Set var passed to submit_form function, controls whether config is re-uploaded or not #}
        {% if context.config|length == 1 %}
        const edit_existing = false;
        {% else %}
        const edit_existing = true;
        {% endif %}

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        // Show the modal with id modal, optionally change title/body/footer
        function show_modal(modal, title=false, body=false, footer=false) {
            if (title) {
                document.getElementById(modal + "-title").innerHTML = title;
            };

            if (body) {
                document.getElementById(modal + "-body").innerHTML = body;
            };

            if (footer) {
                document.getElementById(modal + "-footer").innerHTML = footer;
            };

            $('#' + modal).modal('show');
        };

        document.getElementById('form').addEventListener("submit", function(e) {
            e.preventDefault();

            // Disable submit button, prevent submitting multiple times
            document.getElementById("submit-button").disabled = true;

            // Create config from form contents
            submit_form(edit_existing);
        });

        // Listen for system theme changes, switch to dark/light mode to reflect (responsive)
        window.matchMedia('(prefers-color-scheme: dark)').addListener(function (e) {
            if (e.matches) { // Returns True for dark mode, False otherwise
                document.body.classList.add("dark");
                document.body.classList.remove("light");
            } else {
                document.body.classList.remove("dark");
                document.body.classList.add("light");
            }
        });
    </script>
    <script src="{% static 'node_configuration/apiTargetOptions.js' %}"></script>
    <script src="{% static 'node_configuration/submit.js' %}"></script>
    <script src="{% static 'node_configuration/add-instance.js' %}"></script>
    <script src="{% static 'node_configuration/page-buttons.js' %}"></script>
    <script src="{% static 'node_configuration/schedule-rules.js' %}"></script>

</body>


</html>
