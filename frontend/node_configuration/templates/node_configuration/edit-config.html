{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
    <title>Create new config file</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="{% static 'node_configuration/bootstrap.min.css' %}">
    <link rel="stylesheet" href="{% static 'node_configuration/style.css' %}">
    <script src="{% static 'node_configuration/bootstrap.min.js' %}"></script>
    <script src="{% static 'node_configuration/jquery.min.js' %}"></script>
    <script>

        function getCookie(name) {
            var cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                var cookies = document.cookie.split(';');
                for (var i = 0; i < cookies.length; i++) {
                    var cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        };

        async function readForm(url) {
            var value = Object.fromEntries(new FormData(document.getElementById("form")).entries());

            console.log({ value });

            let csrftoken = getCookie('csrftoken');

            const result = await fetch(url, {
                method: 'POST',
                body: JSON.stringify(value),
                headers: { 'Accept': 'application/json, text/plain, */*',
                    'Content-Type': 'application/json',
                    "X-CSRFToken": csrftoken }
            });

            return result
        };

    </script>
    <style>
        td {
            width: auto;
        }

        td.min {
            width: 1%;
            white-space: nowrap;
        }
    </style>
</head>

<body>
    <div class="container">
        <div>
            <h1 class="text-center mt-3">Create New Config</h1>
        <div><br>

        {% if context %}

            <form id="form" onkeydown="return event.key != 'Enter';">

                <div id="page1">

                    <div>
                        <h2>Metadata</h2>

                        <div class="mb-2">
                            <label for="friendlyName"><b>Name:</b></label>
                            <input type="text" class="form-control" id="friendlyName" placeholder="" name="friendlyName" value="{{context.NAME}}" required>
                        </div>

                        <div class="mb-2">
                            <label for="location"><b>Location:</b></label>
                            <input type="text" class="form-control" id="location" placeholder="" name="location" value="{{context.metadata.location}}" required>
                        </div>

                        <div class="mb-2">
                            <label for="floor"><b>Floor:</b></label>
                            <input type="text" class="form-control" id="floor" placeholder="" name="floor" value="{{context.metadata.floor}}" required>
                        </div>
                    </div></br>

                    <div class="mb-3">
                        <h2>Wifi</h2>

                        <div class="mb-2">
                            <label for="ssid"><b>SSID:</b></label>
                            <input type="text" class="form-control" id="ssid" placeholder="" name="ssid" value="{{context.wifi.ssid}}" required>
                        </div>

                        <div class="mb-2">
                            <label for="password"><b>Password:</b></label>
                            <input type="password" class="form-control" id="password" placeholder="" name="password" value="{{context.wifi.password}}" required>
                        </div>
                    </div></br>

                    <div>
                        <h2>Add Sensors</h2>

                        {% for sensor, params in context.sensors.items %}

                            {% if forloop.first %}
                                <div id="addSensorDiv1">
                            {% else %}
                                <div id="addSensorDiv{{ forloop.counter }}" class="mt-5">
                            {% endif %}
                                <div class="card">
                                    <div class="card-body">
                                        <h4 class="card-title">sensor{{ forloop.counter }}</h4>
                                        <label for="sensorType{{ forloop.counter }}" class="form-label"><b>Type:</b></label>
                                        <div>
                                            <select onchange="load_sensor_section(this)" name="sensorType{{ forloop.counter }}" id="sensorType{{ forloop.counter }}" class="form-select" required>
                                            <option value="clear">Select sensor type</option>
                                            <option value="pir" {% if params.type == "pir" %} selected {% endif %}>Motion Sensor</option>
                                            <option value="switch" {% if params.type == "switch" %} selected {% endif %}>Switch</option>
                                            <option value="dummy" {% if params.type == "dummy" %} selected {% endif %}>Dummy</option>
                                            <option value="desktop-trigger" {% if params.type == "desktop" %} selected {% endif %}>Desktop</option>
                                            <option value="si7021" {% if params.type == "si7021" %} selected {% endif %}>Thermostat</option>
                                            </select>
                                        </div>

                                        {% if params.type == "pir" %}

                                            <div id="addSensorOptions{{ forloop.counter }}" class="mt-3">
                                                <div class="mb-2">
                                                    <label for="sensor{{forloop.counter}}-pin"><b>Pin:</b></label>
                                                    <input type="text" class="form-control" id="sensor{{forloop.counter}}-pin" placeholder="" name="sensor{{forloop.counter}}-pin" value="{{params.pin}}" required>
                                                </div>

                                                <div class="mb-2">
                                                    <label for="sensor{{forloop.counter}}-default_rule"><b>Default Rule:</b></label>
                                                    <input type="default_rule" class="form-control" id="sensor{{forloop.counter}}-default_rule" placeholder="" name="sensor{{forloop.counter}}-default_rule" value="{{params.default_rule}}" required>
                                                </div>
                                            </div>

                                        {% elif params.type == "switch" %}

                                            <div id="addSensorOptions{{ forloop.counter }}" class="mt-3">
                                                <div class="mb-2">
                                                    <label for="sensor{{forloop.counter}}-pin"><b>Pin:</b></label>
                                                    <input type="text" class="form-control" id="sensor{{forloop.counter}}-pin" placeholder="" name="sensor{{forloop.counter}}-pin" value="{{params.pin}}" required>
                                                </div>

                                                <div class="mb-2">
                                                    <label for="sensor{{forloop.counter}}-default_rule"><b>Default Rule:</b></label>
                                                    <input type="default_rule" class="form-control" id="sensor{{forloop.counter}}-default_rule" placeholder="" name="sensor{{forloop.counter}}-default_rule" value="{{params.default_rule}}" required>
                                                </div>

                                            </div>

                                        {% elif params.type == "dummy" %}

                                            <div id="addSensorOptions{{ forloop.counter }}" class="mt-3">
                                                <div class="mb-2">
                                                    <label for="sensor{{forloop.counter}}-default_rule"><b>Default Rule:</b></label>
                                                    <input type="default_rule" class="form-control" id="sensor{{forloop.counter}}-default_rule" placeholder="" name="sensor{{forloop.counter}}-default_rule" value="{{params.default_rule}}" required>
                                                </div>

                                            </div>

                                        {% elif params.type == "desktop" %}

                                            <div id="addSensorOptions{{ forloop.counter }}" class="mt-3">
                                                <div class="mb-2">
                                                    <label for="sensor{{forloop.counter}}-ip"><b>IP:</b></label>
                                                    <input type="text" class="form-control" id="sensor{{forloop.counter}}-ip" placeholder="" name="sensor{{forloop.counter}}-ip" value="{{params.ip}}" required>
                                                </div>

                                                <div class="mb-2">
                                                    <label for="sensor{{forloop.counter}}-default_rule"><b>Default Rule:</b></label>
                                                    <input type="text" class="form-control" id="sensor{{forloop.counter}}-default_rule" placeholder="" name="sensor{{forloop.counter}}-default_rule" value="{{params.default_rule}}" required>
                                                </div>

                                            </div>

                                        {% elif params.type == "si7021" %}

                                            <div id="addSensorOptions{{ forloop.counter }}" class="mt-3">
                                                <div class="mb-2">
                                                    <label for="sensor{{forloop.counter}}-default_rule"><b>Default Rule:</b></label>
                                                    <input type="default_rule" class="form-control" id="sensor{{forloop.counter}}-default_rule" placeholder="" name="sensor{{forloop.counter}}-default_rule" value="{{params.default_rule}}" required>
                                                </div>
                                            </div>

                                        {% endif %}
                                    </div>
                                </div>

                                {% if forloop.last %}
                                    <div class="text-center">
                                        <button onclick="load_next_sensor(this)" type="button" id="addSensorButton{{ forloop.counter }}" class="btn-secondary btn mt-3" disabled>Add another (not yet implemented)</button>
                                    </div>
                                    <div id="addSensorDiv{{ forloop.counter|add:1 }}"></div>
                                {% endif  %}

                            </div>
                        {% endfor %}
                    </div></br>

                    <div>
                        <h2>Add Devices</h2>

                        {% for device, params in context.devices.items %}

                            {% if forloop.first %}
                                <div id="addDeviceDiv1">
                            {% else %}
                                <div id="addDeviceDiv{{ forloop.counter }}" class="mt-5">
                            {% endif %}
                                <div class="card">
                                    <div class="card-body">
                                        <h4 class="card-title">device{{ forloop.counter }}</h4>
                                        <label for="deviceType{{ forloop.counter }}" class="form-label"><b>Type:</b></label>
                                        <div>
                                            <select onchange="load_device_section(this)" name="deviceType{{ forloop.counter }}" id="deviceType{{ forloop.counter }}" class="form-select" required>
                                            <option value="clear">Select device type</option>
                                            <option value="dimmer" {% if params.type == "dimmer" %} selected {% endif %}>TP-Link Dimmer</option>
                                            <option value="bulb" {% if params.type == "bulb" %} selected {% endif %}>TP-Link Bulb</option>
                                            <option value="relay" {% if params.type == "relay" %} selected {% endif %}>Smart Relay</option>
                                            <option value="dumb-relay" {% if params.type == "dumb-relay" %} selected {% endif %}>Relay</option>
                                            <option value="desktop-target" {% if params.type == "desktop" %} selected {% endif %}>Desktop</option>
                                            <option value="pwm" {% if params.type == "pwm" %} selected {% endif %}>LED Strip</option>
                                            <option value="mosfet" {% if params.type == "mosfet" %} selected {% endif %}>Mosfet</option>
                                            <option value="api-target" {% if params.type == "api-target" %} selected {% endif %}>Api Command</option>
                                            </select>
                                        </div>

                                        {% if params.type == "dimmer" %}
                                            <div id="addDeviceOptions{{ forloop.counter }}" class="mt-3">
                                                <div class="mb-2">
                                                    <label for="device{{ forloop.counter }}-ip"><b>IP:</b></label>
                                                    <input type="text" class="form-control" id="device{{ forloop.counter }}-ip" placeholder="" name="device{{ forloop.counter }}-ip" value="{{params.ip}}" required>
                                                </div>

                                                <div class="mb-2">
                                                    <label for="device{{ forloop.counter }}-default_rule"><b>Default Rule:</b></label>
                                                    <input type="default_rule" class="form-control" id="device{{ forloop.counter }}-default_rule" placeholder="" name="device{{ forloop.counter }}-default_rule" value="{{params.default_rule}}" required>
                                                </div>
                                            </div>

                                        {% elif params.type == "bulb" %}
                                            <div id="addDeviceOptions{{ forloop.counter }}" class="mt-3">
                                                <div class="mb-2">
                                                    <label for="device{{ forloop.counter }}-ip"><b>IP:</b></label>
                                                    <input type="text" class="form-control" id="device{{ forloop.counter }}-ip" placeholder="" name="device{{ forloop.counter }}-ip" value="{{params.ip}}" required>
                                                </div>

                                                <div class="mb-2">
                                                    <label for="device{{ forloop.counter }}-default_rule"><b>Default Rule:</b></label>
                                                    <input type="default_rule" class="form-control" id="device{{ forloop.counter }}-default_rule" placeholder="" name="device{{ forloop.counter }}-default_rule" value="{{params.default_rule}}" required>
                                                </div>
                                            </div>

                                        {% elif params.type == "relay" %}
                                            <div id="addDeviceOptions{{ forloop.counter }}" class="mt-3">
                                                <div class="mb-2">
                                                    <label for="device{{ forloop.counter }}-ip"><b>IP:</b></label>
                                                    <input type="text" class="form-control" id="device{{ forloop.counter }}-ip" placeholder="" name="device{{ forloop.counter }}-ip" value="{{params.ip}}" required>
                                                </div>

                                                <div class="mb-2">
                                                    <label for="device{{ forloop.counter }}-default_rule"><b>Default Rule:</b></label>
                                                    <input type="default_rule" class="form-control" id="device{{ forloop.counter }}-default_rule" placeholder="" name="device{{ forloop.counter }}-default_rule" value="{{params.default_rule}}" required>
                                                </div>
                                            </div>

                                        {% elif params.type == "dumb-relay" %}
                                            <div id="addDeviceOptions{{ forloop.counter }}" class="mt-3">
                                                <div class="mb-2">
                                                    <label for="device{{ forloop.counter }}-pin"><b>Pin:</b></label>
                                                    <input type="text" class="form-control" id="device{{ forloop.counter }}-pin" placeholder="" name="device{{ forloop.counter }}-pin" value="{{params.pin}}" required>
                                                </div>

                                                <div class="mb-2">
                                                    <label for="device{{ forloop.counter }}-default_rule"><b>Default Rule:</b></label>
                                                    <input type="default_rule" class="form-control" id="device{{ forloop.counter }}-default_rule" placeholder="" name="device{{ forloop.counter }}-default_rule" value="{{params.default_rule}}" required>
                                                </div>
                                            </div>

                                        {% elif params.type == "desktop" %}
                                            <div id="addDeviceOptions{{ forloop.counter }}" class="mt-3">
                                                <div class="mb-2">
                                                    <label for="device{{ forloop.counter }}-ip"><b>IP:</b></label>
                                                    <input type="text" class="form-control" id="device{{ forloop.counter }}-ip" placeholder="" name="device{{ forloop.counter }}-ip" value="{{params.ip}}" required>
                                                </div>

                                                <div class="mb-2">
                                                    <label for="device{{ forloop.counter }}-default_rule"><b>Default Rule:</b></label>
                                                    <input type="default_rule" class="form-control" id="device{{ forloop.counter }}-default_rule" placeholder="" name="device{{ forloop.counter }}-default_rule" value="{{params.default_rule}}" required>
                                                </div>
                                            </div>

                                        {% elif params.type == "pwm" %}
                                            <div id="addDeviceOptions{{ forloop.counter }}" class="mt-3">
                                                <div class="mb-2">
                                                    <label for="device{{ forloop.counter }}-pin"><b>Pin:</b></label>
                                                    <input type="text" class="form-control" id="device{{ forloop.counter }}-pin" placeholder="" name="device{{ forloop.counter }}-pin" value="{{params.pin}}" required>
                                                </div>

                                                <div class="mb-2">
                                                    <label for="device{{ forloop.counter }}-min"><b>Min brightness:</b></label>
                                                    <input type="min" class="form-control" id="device{{ forloop.counter }}-min" placeholder="0" name="device{{ forloop.counter }}-min" value="{{params.min}}" required>
                                                </div>

                                                <div class="mb-2">
                                                    <label for="device{{ forloop.counter }}-max"><b>Max brightness:</b></label>
                                                    <input type="text" class="form-control" id="device{{ forloop.counter }}-max" placeholder="1023" name="device{{ forloop.counter }}-max" value="{{params.max}}" required>
                                                </div>

                                                <div class="mb-2">
                                                    <label for="device{{ forloop.counter }}-default_rule"><b>Default Rule:</b></label>
                                                    <input type="default_rule" class="form-control" id="device{{ forloop.counter }}-default_rule" placeholder="" name="device{{ forloop.counter }}-default_rule" value="{{params.default_rule}}" required>
                                                </div>
                                            </div>

                                        {% elif params.type == "mosfet" %}
                                            <div id="addDeviceOptions{{ forloop.counter }}" class="mt-3">
                                                <div class="mb-2">
                                                    <label for="device{{ forloop.counter }}-pin"><b>Pin:</b></label>
                                                    <input type="text" class="form-control" id="device{{ forloop.counter }}-pin" placeholder="" name="device{{ forloop.counter }}-pin" value="{{params.pin}}" required>
                                                </div>

                                                <div class="mb-2">
                                                    <label for="device{{ forloop.counter }}-default_rule"><b>Default Rule:</b></label>
                                                    <input type="default_rule" class="form-control" id="device{{ forloop.counter }}-default_rule" placeholder="" name="device{{ forloop.counter }}-default_rule" value="{{params.default_rule}}" required>
                                                </div>
                                            </div>

                                        {% elif params.type == "api-target" %}
                                            <div id="addDeviceOptions{{ forloop.counter }}" class="mt-3">
                                                <div class="mb-2">
                                                    <label for="device{{ forloop.counter }}-ip"><b>IP:</b></label>
                                                    <input type="text" class="form-control" id="device{{ forloop.counter }}-ip" placeholder="" name="device{{ forloop.counter }}-ip" value="{{params.ip}}" required>
                                                </div>

                                                <div class="mb-2">
                                                    <label for="device{{ forloop.counter }}-default_rule"><b>Default Rule:</b></label>
                                                    <input type="default_rule" class="form-control" id="device{{ forloop.counter }}-default_rule" placeholder="" name="device{{ forloop.counter }}-default_rule" value="{{params.default_rule}}" required>
                                                </div>
                                            </div>

                                        {% endif %}
                                    </div>
                                </div>

                                {% if forloop.last %}
                                    <div class="text-center">
                                        <button onclick="load_next_device(this)" type="button" id="addDeviceButton{{ forloop.counter }}" class="btn-secondary btn mt-3" disabled>Add another (not yet implemented)</button>
                                    </div>
                                    <div id="addDeviceDiv{{ forloop.counter|add:1 }}"></div>
                                {% endif  %}

                            </div>
                        {% endfor %}
                    </div></br>

                    <div class="d-flex justify-content-between mx-3 mb-3">
                        <button id="page1-back-button" type="button" class="btn btn-secondary">Back</button>
                        <button type="button" class="btn btn-primary" style="visibility: hidden;">Submit</button>
                        <button id="page1-button" type="button" class="btn btn-primary">Next</button>
                    </div>
                </div>

                <div id="page2">
                    <h3>Select targets for each sensor</h3>

                    {% for sensor, params in context.sensors.items %}

                        <div class="card">
                            <div class="card-body">
                                <label for="{{sensor}}-targets" class="card-title"><b>{{ sensor }} ({{ params.type }}) targets:</b></label>
                                <div class="form-check">

                                    {% for device, dparams in context.devices.items %}

                                        <input type="checkbox" class="form-check-input" id="target-{{sensor}}-{{device}}" name="target-{{sensor}}-{{device}}" value="target-{{sensor}}-{{device}}" {% if device in params.targets %}checked{% endif %}>
                                        <label for="target-{{sensor}}-{{device}}" class="form-check-label">{{ device }} ({{ dparams.type }})</label><br>

                                    {% endfor %}
                                    </select>
                                </div>
                            </div>
                        </div></br>


                    {% endfor %}

                    <div class="d-flex justify-content-between mx-3 mb-3">
                        <button id="page2-back-button" type="button" class="btn btn-primary">Back</button>
                        <button type="button" class="btn btn-primary" style="visibility: hidden;">Submit</button>
                        <button id="page2-button" type="button" class="btn btn-primary">Next</button>
                    </div>
                </div>

                <div id="page3">
                    <h3>Add schedule rules (optional)</h3>

                    {% for instance, params in context.instances.items %}

                        <div class="card">
                            <div class="card-body">
                                <label class="card-title"><b>{{ instance }} ({{ params.type }}):</b></label>
                                <table id="{{instance}}-rules" class="table table-borderless">
                                    <tr>
                                        <th style="text-align: left;">Time</th>
                                        <th style="text-align: left;">Rule</th>
                                    </tr>

                                    {% for time, rule in params.schedule.items %}
                                        <tr id="{{instance}}-row-{{forloop.counter}}">
                                            <td><input type="text" class="form-control" id="schedule-{{instance}}-rule{{forloop.counter}}-time" placeholder="HH:MM" name="schedule-{{instance}}-rule{{forloop.counter}}-time" value="{{ time }}"></td>
                                            <td><input type="text" class="form-control" id="schedule-{{instance}}-rule{{forloop.counter}}-value" placeholder="" name="schedule-{{instance}}-rule{{forloop.counter}}-value" value="{{ rule }}"></td>
                                            <td class="min"><button type="button" class="remove btn btn-danger" id="{{instance}}-remove{{forloop.counter}}"  onclick="remove(this)">X</button></td>
                                        </tr>
                                    {% endfor %}
                                </table>
                            </div>

                            <div class="text-left mx-3 mb-3">
                                <button type="button" class="btn btn-secondary add" id="{{instance}}-add-rule">Add another</button>
                            </div>

                        </div></br>

                    {% endfor %}

                    <div class="d-flex justify-content-between mx-3 mb-3">
                        <button id="page3-back-button" type="button" class="btn btn-primary">Back</button>
                        <button type="submit" class="btn btn-primary">Submit</button>
                        <button type="button" class="btn btn-secondary" disabled>Next</button>
                    </div>
                </div>

            </form>

        {% else %}
            <p>FATAL ERROR</p>
        {% endif %}
    </div>

    <script>
        // Check if user is in dark mode, change theme (runs once on page load)
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.body.classList.add("dark");
            for (el of document.getElementsByClassName("table")) {
                el.classList.add("table-dark")
            };
            console.log("Dark mode");
        };

        $('#page2').hide();
        $('#page3').hide();

        const base_url = window.location.href.split("edit_config")[0];

        async function load_sensor_section(select) {
            // Get index of sensor
            const index = parseInt(select.id.replace("sensorType", ""));

            // Get user selection
            const selected = document.getElementById(select.id).value

            // Load form for the selected sensor type
            if (selected == "clear") {
                document.getElementById("addSensorOptions" + index).innerHTML = "";
                return
            } else if (selected == "pir") {
                var div_contents = await fetch("/sensorOptionsPir/" + index);
            } else if (selected == "switch") {
                var div_contents = await fetch("/sensorOptionsSwitch/" + index);
            } else if (selected == "dummy") {
                var div_contents = await fetch("/sensorOptionsDummy/" + index);
            } else if (selected == "desktop-trigger") {
                var div_contents = await fetch("/sensorOptionsDesktop/" + index);
            } else if (selected == "si7021") {
                var div_contents = await fetch("/sensorOptionsSi7021/" + index);
            };

            // Render div, scroll down until visible
            document.getElementById("addSensorOptions" + index).innerHTML = await div_contents.text();
            document.getElementById("addSensorOptions" + index).scrollIntoView();
        };

        async function load_device_section(select) {
            // Get index of device
            const index = parseInt(select.id.replace("deviceType", ""));

            // Get user selection
            const selected = document.getElementById(select.id).value

            // Load form for the selected device type
            if (selected == "clear") {
                document.getElementById("addDeviceOptions" + index).innerHTML = "";
                return
            } else if (selected == "dimmer") {
                var div_contents = await fetch("/deviceOptionsDimmer/" + index);
            } else if (selected == "bulb") {
                var div_contents = await fetch("/deviceOptionsBulb/" + index);
            } else if (selected == "relay") {
                var div_contents = await fetch("/deviceOptionsRelay/" + index);
            } else if (selected == "dumb-relay") {
                var div_contents = await fetch("/deviceOptionsDumbRelay/" + index);
            } else if (selected == "desktop-target") {
                var div_contents = await fetch("/deviceOptionsDesktop/" + index);
            } else if (selected == "pwm") {
                var div_contents = await fetch("/deviceOptionsPwm/" + index);
            } else if (selected == "mosfet") {
                var div_contents = await fetch("/deviceOptionsMosfet/" + index);
            } else if (selected == "api-target") {
                var div_contents = await fetch("/deviceOptionsApi/" + index);
            };

            // Render div, scroll down until visible
            document.getElementById("addDeviceOptions" + index).innerHTML = await div_contents.text();
            document.getElementById("addDeviceOptions" + index).scrollIntoView();
        };

        async function load_next_device(button) {
            // Get index of clicked button
            const index = parseInt(button.id.replace("addDeviceButton", ""));

            // Hide clicked button
            document.getElementById("addDeviceButton" + index).style.display = "none";

            // Load contents for next addDevice div
            var div_contents = await fetch("addDevice/" + (index + 1));
            div_contents = await div_contents.text();

            // Render div, scroll down until visible
            document.getElementById("addDeviceDiv" + (index + 1)).innerHTML = div_contents;
            document.getElementById("addDeviceDiv" + (index + 1)).scrollIntoView();
        };

        async function load_next_sensor(button) {
            // Get index of clicked button
            const index = parseInt(button.id.replace("addSensorButton", ""));

            // Hide clicked button
            document.getElementById("addSensorButton" + index).style.display = "none";

            // Load contents for next addSensor div
            var div_contents = await fetch("addSensor/" + (index + 1));
            div_contents = await div_contents.text();

            // Render div, scroll down until visible
            document.getElementById("addSensorDiv" + (index + 1)).innerHTML = div_contents;
            document.getElementById("addSensorDiv" + (index + 1)).scrollIntoView();
        };

        document.getElementById('page1-button').addEventListener("click", function(e) {
            e.preventDefault();

            $('#page2').show();
            $('#page1').hide();
        });

        document.getElementById('page2-button').addEventListener("click", function(e) {
            e.preventDefault();

            $('#page3').show();
            $('#page2').hide();
        });

        document.getElementById('page1-back-button').addEventListener("click", function(e) {
            window.location.replace("/node_configuration");
        });

        document.getElementById('page2-back-button').addEventListener("click", function(e) {
            e.preventDefault();

            $('#page1').show();
            $('#page2').hide();
        });

        document.getElementById('page3-back-button').addEventListener("click", function(e) {
            e.preventDefault();

            $('#page2').show();
            $('#page3').hide();
        });

        function add(e) {
            var instance = e.target.id.split("-", 1)[0];

            table = document.getElementById(instance + "-rules")

            // Rows are numbered sequentially. Get number of last row and increment
            var next_row = parseInt($('#' + instance + '-rules tr:last').attr('id').split("-").pop()) + 1;

            var row = table.insertRow();
            row.setAttribute("id", instance + "-row-" + next_row)

            var cell_time = row.insertCell(0);
            var cell_value = row.insertCell(1);
            var cell_del = row.insertCell(2);

            cell_time.innerHTML = "<input type='text' class='form-control' id='" + instance + "-rule" + next_row + "-time' placeholder='HH:MM' name='schedule-" + instance + "-rule" + next_row + "-time'>";
            cell_value.innerHTML = "<input type='text' class='form-control' id='" + instance + "-rule" + next_row + "-value' placeholder='' name='schedule-" + instance + "-rule" + next_row + "-value'>";
            cell_del.innerHTML = "<button type='button' class='remove btn btn-danger' id='" + instance + "-remove" + next_row + "' onclick='remove(this)'>X</button>";

        };

        function remove(e) {
            var instance = e.id;
            var index = e.parentElement.parentElement.rowIndex

            table = document.getElementById(instance.split("-", 1) + "-rules")
            table.deleteRow(index)
        };

        $('.add').on('click', add);

        document.getElementById('form').addEventListener("submit", function(e) {
            e.preventDefault();

            submit_form();
        });

        async function submit_form() {
            let csrftoken = getCookie('csrftoken');

            var value = Object.fromEntries(new FormData(document.getElementById("form")).entries());

            // Overwrite the existing config file using new form data
            const response = await fetch(base_url + "generateConfigFile/True", {
                method: 'POST',
                body: JSON.stringify(value),
                headers: { 'Accept': 'application/json, text/plain, */*',
                    'Content-Type': 'application/json',
                    "X-CSRFToken": csrftoken }
            });

            // If successful, redirect back to overview (otherwise display error in alert)
            if (response.ok) {
                window.location.replace("/node_configuration");
            } else {
                alert(await response.text());
                return false;
            };
        };

        // Listen for system theme changes, switch to dark/light mode to reflect (responsive)
        window.matchMedia('(prefers-color-scheme: dark)').addListener(function (e) {
            if (e.matches) { // Returns True for dark mode, False otherwise
                document.body.classList.add("dark");
                for (el of document.getElementsByClassName("table")) {
                    el.classList.add("table-dark")
                };
            } else {
                document.body.classList.remove("dark");
                for (el of document.getElementsByClassName("table")) {
                    el.classList.remove("table-dark")
                };
            }
        });
    </script>

</body>


</html>
