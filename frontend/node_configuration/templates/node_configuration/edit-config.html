{% load static %}
{% load pwa %}
{% load is_device %}
{% load is_sensor %}
{% load only_digits %}
{% load get_metadata %}

<!DOCTYPE html>
<html lang="en">
<head>
    <title>{{ TITLE }}</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    {% progressive_web_app_meta %}
    <link rel="stylesheet" href="{% static 'bootstrap.min.css' %}">
    <link rel="stylesheet" href="{% static 'bootstrap-icons.css' %}">
    <link rel="stylesheet" href="{% static 'node_configuration/style.css' %}">
    <script src="{% static 'bootstrap.min.js' %}"></script>
    <script src="{% static 'smoothscroll.min.js' %}"></script>
    <script src="{% static 'react.production.min.js' %}"></script>
    <script src="{% static 'react-dom.production.min.js' %}"></script>
    <script src="{% static 'react-transition-group.min.js' %}"></script>
    <script src="{% static 'react-bootstrap.min.js' %}"></script>
    <style>
        /* Force equal width for schedule rule fields */
        td {
            width: 50%;
        }

        /* Delete card animation */
        :root {
            --animation-height: 25rem;
        }

        @keyframes slide-up {
            0% {
                bottom: 0rem;
            }
            100% {
                bottom: var(--animation-height);
            }
        }

        .slide-up {
            animation-name: slide-up;
            animation-duration: 0.8s;
            animation-timing-function: ease;
            animation-fill-mode: forwards;
        }

        @keyframes fade-out {
            0% {
                opacity: 100%;
            }
            100% {
                opacity: 0%;
            }
        }

        .fade-out {
            animation-name: fade-out;
            animation-duration: 0.4s;
            animation-timing-function: ease;
            animation-fill-mode: forwards;
        }

        /* Popup div for setting timestamp and rule on page 3 */
        .schedule-rule-param-popup {
            position: absolute;
            border: 3px solid #1B1E1F;
            border-radius: 8px;
            padding: 20px;
            background-color: #212529;
            z-index: 99;
            margin-left: 20px;
            margin-right: 20px;
            min-width: fit-content;
        }

        /* Mobile: Full width instead of aligning to parent element */
        @media screen and (max-width: 768px) {
            .schedule-rule-param-popup {
                min-width: calc(100% - 40px);
                margin-left: 20px;
                left: 0;
            }
        }
    </style>
</head>

<body>
    <script>
        // Check if user is in dark mode, change theme (runs once on page load)
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.body.classList.add("dark");
            console.log("Dark mode");
        } else {
            document.body.classList.add("light");
        };
    </script>

    <div id="root" class="container" data-config="{{config}}"></div>
    {{ metadata|json_script:"instance_metadata" }}
    {{ edit_existing|json_script:"edit_existing" }}
    {{ schedule_keywords|json_script:"schedule_keywords" }}
    {{ api_target_options|json_script:"api_target_options" }}
    {{ config|json_script:"config" }}
    <script>
        // Get var passed to submit_form function, controls whether config is re-uploaded
        const edit_existing = JSON.parse(document.getElementById("edit_existing").textContent);
        // If editing get original name (prevents rejecting existing name as duplicate)
        if (edit_existing) {
            var orig_name = JSON.parse(document.getElementById("config").textContent).metadata.id.toLowerCase();
        };

        // Listen for system theme changes, switch to dark/light mode to reflect (responsive)
        window.matchMedia('(prefers-color-scheme: dark)').addListener(function (e) {
            if (e.matches) { // Returns True for dark mode, False otherwise
                document.body.classList.add("dark");
                document.body.classList.remove("light");

                // Modal close buttons
                document.querySelectorAll('.btn-close').forEach(button => button.classList.add("btn-close-white"));
            } else {
                document.body.classList.remove("dark");
                document.body.classList.add("light");

                // Modal close buttons
                document.querySelectorAll('.btn-close').forEach(button => button.classList.remove("btn-close-white"));
            };
        });

        // Set modal close button color (runs once on load)
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.querySelectorAll('.btn-close').forEach(button => button.classList.add("btn-close-white"));
        };
    </script>
    <script src="{% static 'node_configuration/edit_config.js' %}"></script>
</body>
</html>
