{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
    <title>Create new config file</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="{% static 'node_configuration/bootstrap.min.css' %}">
    <link rel="stylesheet" href="{% static 'node_configuration/style.css' %}">
    <script src="{% static 'node_configuration/bootstrap.min.js' %}"></script>
    <script src="{% static 'node_configuration/jquery.min.js' %}"></script>
    <script src="{% static 'node_configuration/smoothscroll.min.js' %}"></script>
    <script>

        function getCookie(name) {
            var cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                var cookies = document.cookie.split(';');
                for (var i = 0; i < cookies.length; i++) {
                    var cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        };

        async function readForm(url) {
            var value = Object.fromEntries(new FormData(document.getElementById("form")).entries());

            console.log({ value });

            let csrftoken = getCookie('csrftoken');

            const result = await fetch(url, {
                method: 'POST',
                body: JSON.stringify(value),
                headers: { 'Accept': 'application/json, text/plain, */*',
                    'Content-Type': 'application/json',
                    "X-CSRFToken": csrftoken }
            });

            return result
        };

    </script>
    <style>
        /* Set table column to minimum width with class */
        td {
            width: auto;
        }

        td.min {
            width: 1%;
            white-space: nowrap;
        }
        /* ----- */

        /* Upload complete checkmark animation */
        .light {
            --success: #198754;
        }

        .dark {
            --success: #177a4c;
        }

        .checkmark__circle {
            stroke-dasharray: 166;
            stroke-dashoffset: 166;
            stroke-width: 2;
            stroke-miterlimit: 10;
            stroke: var(--success);
            fill: none;
            animation: stroke 0.6s cubic-bezier(0.65, 0, 0.45, 1) forwards;
        }

        .checkmark {
            width: 3rem;
            height: 3rem;
            border-radius: 50%;
            display: block;
            stroke-width: 2;
            stroke: #fff;
            stroke-miterlimit: 10;
            box-shadow: inset 0px 0px 0px var(--success);
            animation: fill .4s ease-in-out .4s forwards, scale .3s ease-in-out .9s both;
        }

        .checkmark__check {
            transform-origin: 50% 50%;
            stroke-dasharray: 48;
            stroke-dashoffset: 48;
            animation: stroke 0.3s cubic-bezier(0.65, 0, 0.45, 1) 0.8s forwards;
        }

        @keyframes stroke {
            100% {
                stroke-dashoffset: 0;
            }
        }

        @keyframes scale {
            0%, 100% {
                transform: none;
            }
            50% {
                transform: scale3d(1.1, 1.1, 1);
            }
        }

        @keyframes fill {
            100% {
                box-shadow: inset 0px 0px 0px 30px var(--success);
            }
        }
        /* ----- */

        /* Limit width for readability on large screen sizes */
        @media (min-width: 1200px) {
            .container {
                width: 960px;
            }
        }
        /* ----- */
    </style>
</head>

<body>
    <script>
        // Check if user is in dark mode, change theme (runs once on page load)
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.body.classList.add("dark");
            console.log("Dark mode");
        } else {
            document.body.classList.add("light");
        };
    </script>

    <div class="container d-flex flex-column vh-100">
        <h1 class="text-center pt-3 pb-4">Editing {{ context.NAME }}</h1>

        {% if context %}

            <form id="form" class="h-100" onkeydown="return event.key != 'Enter';">

                <div id="page1" class="d-flex flex-column h-100">

                    <div  class="mb-4">
                        <h2>Metadata</h2>

                        <div class="mb-2">
                            <label for="friendlyName"><b>Name:</b></label>
                            <input type="text" class="form-control" id="friendlyName" placeholder="" name="friendlyName" value="{{context.NAME}}" required>
                        </div>

                        <div class="mb-2">
                            <label for="location"><b>Location:</b></label>
                            <input type="text" class="form-control" id="location" placeholder="" name="location" value="{{context.metadata.location}}" required>
                        </div>

                        <div class="mb-2">
                            <label for="floor"><b>Floor:</b></label>
                            <input type="text" class="form-control" id="floor" placeholder="" name="floor" value="{{context.metadata.floor}}" required>
                        </div>
                    </div>

                    <div class="mb-4">
                        <h2>Wifi</h2>

                        <div class="mb-2">
                            <label for="ssid"><b>SSID:</b></label>
                            <input type="text" class="form-control" id="ssid" placeholder="" name="ssid" value="{{context.wifi.ssid}}" required>
                        </div>

                        <div class="mb-2">
                            <label for="password"><b>Password:</b></label>
                            <input type="password" class="form-control" id="password" placeholder="" name="password" value="{{context.wifi.password}}" required>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-sm">
                            <h2>Add Sensors</h2>

                            {% for sensor, params in context.sensors.items %}

                                {% if forloop.first %}
                                    <div id="addSensorDiv1">
                                {% else %}
                                    <div id="addSensorDiv{{ forloop.counter }}" class="mt-5">
                                {% endif %}
                                    <div class="card">
                                        <div class="card-body">
                                            <h4 class="card-title">sensor{{ forloop.counter }}</h4>
                                            <label for="sensorType{{ forloop.counter }}" class="form-label"><b>Type:</b></label>
                                            <div>
                                                <select onchange="load_sensor_section(this)" name="sensorType{{ forloop.counter }}" id="sensorType{{ forloop.counter }}" class="form-select sensorType" required>
                                                <option value="clear">Select sensor type</option>
                                                <option value="pir" {% if params.type == "pir" %} selected {% endif %}>Motion Sensor</option>
                                                <option value="switch" {% if params.type == "switch" %} selected {% endif %}>Switch</option>
                                                <option value="dummy" {% if params.type == "dummy" %} selected {% endif %}>Dummy</option>
                                                <option value="desktop" {% if params.type == "desktop" %} selected {% endif %}>Desktop</option>
                                                <option value="si7021" {% if params.type == "si7021" %} selected {% endif %}>Thermostat</option>
                                                </select>
                                            </div>

                                            <div id="addSensorOptions{{ forloop.counter }}" class="card-body">
                                                <div class="mb-2">
                                                    <label for="sensor{{forloop.counter}}-nickname"><b>Nickname:</b></label>
                                                    <input type="text" class="form-control" id="sensor{{forloop.counter}}-nickname" placeholder="" name="sensor{{forloop.counter}}-nickname" value="{{params.nickname}}" required>
                                                </div>

                                            {% if params.type == "pir" %}

                                                    <div class="mb-2">
                                                        <label for="sensor{{forloop.counter}}-pin"><b>Pin:</b></label>
                                                        <input type="text" class="form-control" id="sensor{{forloop.counter}}-pin" placeholder="" name="sensor{{forloop.counter}}-pin" value="{{params.pin}}" required>
                                                    </div>

                                                    <div class="mb-2">
                                                        <label for="sensor{{forloop.counter}}-default_rule"><b>Default Rule:</b></label>
                                                        <input type="default_rule" class="form-control" id="sensor{{forloop.counter}}-default_rule" placeholder="" name="sensor{{forloop.counter}}-default_rule" value="{{params.default_rule}}" required>
                                                    </div>

                                            {% elif params.type == "switch" %}

                                                    <div class="mb-2">
                                                        <label for="sensor{{forloop.counter}}-pin"><b>Pin:</b></label>
                                                        <input type="text" class="form-control" id="sensor{{forloop.counter}}-pin" placeholder="" name="sensor{{forloop.counter}}-pin" value="{{params.pin}}" required>
                                                    </div>

                                                    <div class="mb-2">
                                                        <label for="sensor{{forloop.counter}}-default_rule"><b>Default Rule:</b></label>
                                                        <input type="default_rule" class="form-control" id="sensor{{forloop.counter}}-default_rule" placeholder="" name="sensor{{forloop.counter}}-default_rule" value="{{params.default_rule}}" required>
                                                    </div>

                                            {% elif params.type == "dummy" %}

                                                    <div class="mb-2">
                                                        <label for="sensor{{forloop.counter}}-default_rule"><b>Default Rule:</b></label>
                                                        <input type="default_rule" class="form-control" id="sensor{{forloop.counter}}-default_rule" placeholder="" name="sensor{{forloop.counter}}-default_rule" value="{{params.default_rule}}" required>
                                                    </div>

                                            {% elif params.type == "desktop" %}

                                                    <div class="mb-2">
                                                        <label for="sensor{{forloop.counter}}-ip"><b>IP:</b></label>
                                                        <input type="text" class="form-control" id="sensor{{forloop.counter}}-ip" placeholder="" name="sensor{{forloop.counter}}-ip" value="{{params.ip}}" required>
                                                    </div>

                                                    <div class="mb-2">
                                                        <label for="sensor{{forloop.counter}}-default_rule"><b>Default Rule:</b></label>
                                                        <input type="text" class="form-control" id="sensor{{forloop.counter}}-default_rule" placeholder="" name="sensor{{forloop.counter}}-default_rule" value="{{params.default_rule}}" required>
                                                    </div>

                                            {% elif params.type == "si7021" %}

                                                    <div class="mb-2">
                                                        <label for="sensor{{forloop.counter}}-default_rule"><b>Default Rule:</b></label>
                                                        <input type="default_rule" class="form-control" id="sensor{{forloop.counter}}-default_rule" placeholder="" name="sensor{{forloop.counter}}-default_rule" value="{{params.default_rule}}" required>
                                                    </div>

                                                    <div class="mb-2">
                                                        <label class="form-label" for="sensor{{forloop.counter}}-mode"><b>Mode:</b></label>
                                                        <select name="sensor{{forloop.counter}}-mode" id="sensor{{forloop.counter}}-mode" class="form-select mb-3" required>
                                                            {% if params.mode == "cool" %}
                                                                <option value="cool" id="cool" selected>Cool</option>
                                                                <option value="heat" id="heat">Heat</option>
                                                            {% elif params.mode == "heat" %}
                                                                <option value="cool" id="cool">Cool</option>
                                                                <option value="heat" id="heat" selected>Heat</option>
                                                            {% else %}
                                                                <option value="cool" id="cool">Cool</option>
                                                                <option value="heat" id="heat">Heat</option>
                                                            {% endif %}
                                                        </select>
                                                    </div>

                                                    <div class="mb-2">
                                                        <label for="sensor{{forloop.counter}}-tolerance"><b>Tolerance:</b></label>
                                                        <input type="text" class="form-control" id="sensor{{forloop.counter}}-tolerance" placeholder="" name="sensor{{forloop.counter}}-tolerance" value="{{params.tolerance}}" required>
                                                    </div>

                                            {% endif %}
                                            </div>
                                        </div>
                                    </div>

                                    {% if forloop.last %}
                                        <div class="text-center">
                                            <button onclick="load_next_sensor(this)" type="button" id="addSensorButton{{ forloop.counter }}" class="btn-secondary btn my-3">Add another</button>
                                        </div>
                                        <div id="addSensorDiv{{ forloop.counter|add:1 }}"></div>
                                    {% endif  %}

                                </div>
                            {% endfor %}

                            {% if context.sensors|length == 0 %}
                                <div class="text-center">
                                    <button onclick="load_next_sensor(this)" type="button" id="addSensorButton0" class="btn-secondary btn my-3">Add another</button>
                                </div>
                                <div id="addSensorDiv1"></div>
                            {% endif %}

                        </div>

                        <div class="col-sm">
                            <h2>Add Devices</h2>

                            {% for device, params in context.devices.items %}

                                {% if forloop.first %}
                                    <div id="addDeviceDiv1">
                                {% else %}
                                    <div id="addDeviceDiv{{ forloop.counter }}" class="mt-5">
                                {% endif %}
                                    <div class="card">
                                        <div class="card-body">
                                            <h4 class="card-title">device{{ forloop.counter }}</h4>
                                            <label for="deviceType{{ forloop.counter }}" class="form-label"><b>Type:</b></label>
                                            <div>
                                                <select onchange="load_device_section(this)" name="deviceType{{ forloop.counter }}" id="deviceType{{ forloop.counter }}" class="form-select deviceType" required>
                                                <option value="clear">Select device type</option>
                                                <option value="dimmer" {% if params.type == "dimmer" %} selected {% endif %}>TP-Link Dimmer</option>
                                                <option value="bulb" {% if params.type == "bulb" %} selected {% endif %}>TP-Link Bulb</option>
                                                <option value="relay" {% if params.type == "relay" %} selected {% endif %}>Smart Relay</option>
                                                <option value="dumb-relay" {% if params.type == "dumb-relay" %} selected {% endif %}>Relay</option>
                                                <option value="desktop" {% if params.type == "desktop" %} selected {% endif %}>Desktop</option>
                                                <option value="pwm" {% if params.type == "pwm" %} selected {% endif %}>LED Strip</option>
                                                <option value="mosfet" {% if params.type == "mosfet" %} selected {% endif %}>Mosfet</option>
                                                <option value="api-target" {% if params.type == "api-target" %} selected {% endif %}>Api Command</option>
                                                <option value="ir-blaster">IR Blaster</option>
                                                </select>
                                            </div>

                                            <div id="addDeviceOptions{{ forloop.counter }}" class="card-body">
                                                <div class="mb-2">
                                                    <label for="device{{forloop.counter}}-nickname"><b>Nickname:</b></label>
                                                    <input type="text" class="form-control" id="device{{forloop.counter}}-nickname" placeholder="" name="device{{forloop.counter}}-nickname" value="{{params.nickname}}" required>
                                                </div>

                                            {% if params.type == "dimmer" %}
                                                    <div class="mb-2">
                                                        <label for="device{{ forloop.counter }}-ip"><b>IP:</b></label>
                                                        <input type="text" class="form-control" id="device{{ forloop.counter }}-ip" placeholder="" name="device{{ forloop.counter }}-ip" value="{{params.ip}}" required>
                                                    </div>

                                                    <div class="mb-2">
                                                        <label for="device{{ forloop.counter }}-default_rule"><b>Default Rule:</b></label>
                                                        <input type="default_rule" class="form-control" id="device{{ forloop.counter }}-default_rule" placeholder="" name="device{{ forloop.counter }}-default_rule" value="{{params.default_rule}}" required>
                                                    </div>

                                            {% elif params.type == "bulb" %}
                                                    <div class="mb-2">
                                                        <label for="device{{ forloop.counter }}-ip"><b>IP:</b></label>
                                                        <input type="text" class="form-control" id="device{{ forloop.counter }}-ip" placeholder="" name="device{{ forloop.counter }}-ip" value="{{params.ip}}" required>
                                                    </div>

                                                    <div class="mb-2">
                                                        <label for="device{{ forloop.counter }}-default_rule"><b>Default Rule:</b></label>
                                                        <input type="default_rule" class="form-control" id="device{{ forloop.counter }}-default_rule" placeholder="" name="device{{ forloop.counter }}-default_rule" value="{{params.default_rule}}" required>
                                                    </div>

                                            {% elif params.type == "relay" %}
                                                    <div class="mb-2">
                                                        <label for="device{{ forloop.counter }}-ip"><b>IP:</b></label>
                                                        <input type="text" class="form-control" id="device{{ forloop.counter }}-ip" placeholder="" name="device{{ forloop.counter }}-ip" value="{{params.ip}}" required>
                                                    </div>

                                                    <div class="mb-2">
                                                        <label for="device{{ forloop.counter }}-default_rule"><b>Default Rule:</b></label>
                                                        <input type="default_rule" class="form-control" id="device{{ forloop.counter }}-default_rule" placeholder="" name="device{{ forloop.counter }}-default_rule" value="{{params.default_rule}}" required>
                                                    </div>

                                            {% elif params.type == "dumb-relay" %}
                                                    <div class="mb-2">
                                                        <label for="device{{ forloop.counter }}-pin"><b>Pin:</b></label>
                                                        <input type="text" class="form-control" id="device{{ forloop.counter }}-pin" placeholder="" name="device{{ forloop.counter }}-pin" value="{{params.pin}}" required>
                                                    </div>

                                                    <div class="mb-2">
                                                        <label for="device{{ forloop.counter }}-default_rule"><b>Default Rule:</b></label>
                                                        <input type="default_rule" class="form-control" id="device{{ forloop.counter }}-default_rule" placeholder="" name="device{{ forloop.counter }}-default_rule" value="{{params.default_rule}}" required>
                                                    </div>

                                            {% elif params.type == "desktop" %}
                                                    <div class="mb-2">
                                                        <label for="device{{ forloop.counter }}-ip"><b>IP:</b></label>
                                                        <input type="text" class="form-control" id="device{{ forloop.counter }}-ip" placeholder="" name="device{{ forloop.counter }}-ip" value="{{params.ip}}" required>
                                                    </div>

                                                    <div class="mb-2">
                                                        <label for="device{{ forloop.counter }}-default_rule"><b>Default Rule:</b></label>
                                                        <input type="default_rule" class="form-control" id="device{{ forloop.counter }}-default_rule" placeholder="" name="device{{ forloop.counter }}-default_rule" value="{{params.default_rule}}" required>
                                                    </div>

                                            {% elif params.type == "pwm" %}
                                                    <div class="mb-2">
                                                        <label for="device{{ forloop.counter }}-pin"><b>Pin:</b></label>
                                                        <input type="text" class="form-control" id="device{{ forloop.counter }}-pin" placeholder="" name="device{{ forloop.counter }}-pin" value="{{params.pin}}" required>
                                                    </div>

                                                    <div class="mb-2">
                                                        <label for="device{{ forloop.counter }}-min"><b>Min brightness:</b></label>
                                                        <input type="min" class="form-control" id="device{{ forloop.counter }}-min" placeholder="0" name="device{{ forloop.counter }}-min" value="{{params.min}}" required>
                                                    </div>

                                                    <div class="mb-2">
                                                        <label for="device{{ forloop.counter }}-max"><b>Max brightness:</b></label>
                                                        <input type="text" class="form-control" id="device{{ forloop.counter }}-max" placeholder="1023" name="device{{ forloop.counter }}-max" value="{{params.max}}" required>
                                                    </div>

                                                    <div class="mb-2">
                                                        <label for="device{{ forloop.counter }}-default_rule"><b>Default Rule:</b></label>
                                                        <input type="default_rule" class="form-control" id="device{{ forloop.counter }}-default_rule" placeholder="" name="device{{ forloop.counter }}-default_rule" value="{{params.default_rule}}" required>
                                                    </div>

                                            {% elif params.type == "mosfet" %}
                                                    <div class="mb-2">
                                                        <label for="device{{ forloop.counter }}-pin"><b>Pin:</b></label>
                                                        <input type="text" class="form-control" id="device{{ forloop.counter }}-pin" placeholder="" name="device{{ forloop.counter }}-pin" value="{{params.pin}}" required>
                                                    </div>

                                                    <div class="mb-2">
                                                        <label for="device{{ forloop.counter }}-default_rule"><b>Default Rule:</b></label>
                                                        <input type="default_rule" class="form-control" id="device{{ forloop.counter }}-default_rule" placeholder="" name="device{{ forloop.counter }}-default_rule" value="{{params.default_rule}}" required>
                                                    </div>

                                            {% elif params.type == "api-target" %}
                                                    <div class="mb-2">
                                                        <label for="device{{ forloop.counter }}-ip"><b>IP:</b></label>
                                                        <input type="text" class="form-control" id="device{{ forloop.counter }}-ip" placeholder="" name="device{{ forloop.counter }}-ip" value="{{params.ip}}" required>
                                                    </div>

                                                    <div class="mb-2">
                                                        <label for="device{{ forloop.counter }}-default_rule"><b>Default Rule:</b></label>
                                                        <input type="default_rule" class="form-control" id="device{{ forloop.counter }}-default_rule" placeholder="" name="device{{ forloop.counter }}-default_rule" value="{{params.default_rule}}" required>
                                                    </div>

                                            {% endif %}
                                            </div>
                                        </div>
                                    </div>

                                    {% if forloop.last %}
                                        <div class="text-center">
                                            <button onclick="load_next_device(this)" type="button" id="addDeviceButton{{ forloop.counter }}" class="btn-secondary btn my-3">Add another</button>
                                        </div>
                                        <div id="addDeviceDiv{{ forloop.counter|add:1 }}"></div>
                                    {% endif  %}

                                </div>
                            {% endfor %}


                            {% if context.ir_blaster %}

                                <div id="addDeviceDiv{{ context.devices|length|add:1 }}" {% if context.devices|length %}class="mt-5"{% endif %}>
                                    <div class="card">
                                        <div class="card-body">
                                            <h4 class="card-title">device{{ context.devices|length|add:1 }}</h4>
                                            <label for="deviceType{{ context.devices|length|add:1 }}" class="form-label"><b>Type:</b></label>
                                            <div>
                                                <select onchange="load_device_section(this)" name="deviceType{{ context.devices|length|add:1 }}" id="deviceType{{ context.devices|length|add:1 }}" class="form-select deviceType" required>
                                                <option value="clear">Select device type</option>
                                                <option value="dimmer">TP-Link Dimmer</option>
                                                <option value="bulb">TP-Link Bulb</option>
                                                <option value="relay">Smart Relay</option>
                                                <option value="dumb-relay">Relay</option>
                                                <option value="desktop">Desktop</option>
                                                <option value="pwm">LED Strip</option>
                                                <option value="mosfet">Mosfet</option>
                                                <option value="api-target">Api Command</option>
                                                <option value="ir-blaster" selected>IR Blaster</option>
                                                </select>
                                            </div>

                                            <div id="addDeviceOptions{{ context.devices|length|add:1 }}" class="card-body">
                                                <div class="mb-2">
                                                    <label for="device{{ context.devices|length|add:1 }}-pin"><b>Pin:</b></label>
                                                    <input type="text" class="form-control" id="device{{ context.devices|length|add:1 }}-pin" value="{{ context.ir_blaster.pin }}" name="device{{ context.devices|length|add:1 }}-pin" required>
                                                </div>

                                                <div class="mb-2">
                                                    <label for="device{{ context.devices|length|add:1 }}-min"><b>Virtual remotes:</b></label>
                                                    <div class="form-check">
                                                        <input class="form-check-input" type="checkbox" name="irblaster-tv" value="irblaster-tv" id="irblaster-tv" {% if "tv" in context.ir_blaster.target %}checked{% endif %}>
                                                        <label class="form-check-label" for="checkbox-tv">TV (Samsung)</label></br>
                                                        <input class="form-check-input" type="checkbox" name="irblaster-ac" value="irblaster-ac" id="irblaster-ac" {% if "ac" in context.ir_blaster.target %}checked{% endif %}>
                                                        <label class="form-check-label" for="checkbox-ac">AC (Whynter)</label>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                            {% endif %}

                            {% if context.devices|length == 0 %}
                                {% if context.ir_blaster %}
                                    <div class="text-center">
                                        <button onclick="load_next_device(this)" type="button" id="addDeviceButton1" class="btn-secondary btn my-3">Add another</button>
                                    </div>
                                    <div id="addDeviceDiv2"></div>
                                {% else %}
                                    <div class="text-center">
                                        <button onclick="load_next_device(this)" type="button" id="addDeviceButton0" class="btn-secondary btn my-3">Add another</button>
                                    </div>
                                    <div id="addDeviceDiv1"></div>
                                {% endif %}
                            {% endif %}


                        </div>
                    </div>

                    <div class="d-flex justify-content-between mx-3 mt-auto">
                        <button id="page1-back-button" type="button" class="btn btn-secondary mb-3">Back</button>
                        <button type="button" class="btn btn-primary mb-3" style="visibility: hidden;">Submit</button>
                        <button id="page1-button" type="button" class="btn btn-primary mb-3">Next</button>
                    </div>
                </div>

                <div id="page2" class="flex-column h-100">
                    <div id="page2-cards">
                        <h3>Select targets for each sensor</h3>

                        {% for sensor, params in context.sensors.items %}

                            <div class="card mb-4">
                                <div class="card-body">
                                    <label for="{{sensor}}-targets" class="card-title sensor-targets-label"><b>{{ sensor }} ({{ params.type }}) targets:</b></label>
                                    <div id="{{sensor}}-targets" class="form-check sensor-targets">

                                        {% for device, dparams in context.devices.items %}

                                            <input type="checkbox" class="form-check-input" id="target-{{sensor}}-{{device}}" name="target-{{sensor}}-{{device}}" value="target-{{sensor}}-{{device}}" {% if device in params.targets %}checked{% endif %}>
                                            <label for="target-{{sensor}}-{{device}}" class="form-check-label">{{ device }} ({{ dparams.type }})</label><br>

                                        {% endfor %}
                                    </div>
                                </div>
                            </div>

                        {% endfor %}
                    </div>

                    <div class="d-flex justify-content-between mx-3 mt-auto">
                        <button id="page2-back-button" type="button" class="btn btn-primary mb-3">Back</button>
                        <button type="button" class="btn btn-primary mb-3" style="visibility: hidden;">Submit</button>
                        <button id="page2-button" type="button" class="btn btn-primary mb-3">Next</button>
                    </div>
                </div>

                <div id="page3" class="flex-column h-100">
                    <h3>Add schedule rules (optional)</h3>
                        <div id="page3-cards">
                        {% for instance, params in context.instances.items %}

                            <div class="card mb-4">
                                <div class="card-body">
                                    <label class="card-title schedule-rule-card"><b>{{ instance }} ({{ params.type }}):</b></label>
                                    <table id="{{instance}}-rules" class="table table-borderless">
                                        <tr>
                                            <th style="text-align: left;">Time</th>
                                            <th style="text-align: left;">Rule</th>
                                        </tr>

                                        {% if params.schedule.items|length > 0 %}
                                            {% for time, rule in params.schedule.items %}
                                                <tr id="{{instance}}-row-{{forloop.counter}}">
                                                    <td><input type="text" class="form-control" id="schedule-{{instance}}-rule{{forloop.counter}}-time" placeholder="HH:MM" name="schedule-{{instance}}-rule{{forloop.counter}}-time" value="{{ time }}"></td>
                                                    <td><input type="text" class="form-control" id="schedule-{{instance}}-rule{{forloop.counter}}-value" placeholder="" name="schedule-{{instance}}-rule{{forloop.counter}}-value" value="{{ rule }}"></td>
                                                    <td class="min"><button type="button" class="remove btn btn-danger" id="{{instance}}-remove{{forloop.counter}}"  onclick="remove(this)">X</button></td>
                                                </tr>
                                            {% endfor %}
                                        {% else %}
                                            <tr id="{{instance}}-row-1">
                                                <td><input type="text" class="form-control" id="schedule-{{instance}}-rule1-time" placeholder="HH:MM" name="schedule-{{instance}}-rule1-time"></td>
                                                <td><input type="text" class="form-control" id="schedule-{{instance}}-rule1-value" placeholder="" name="schedule-{{instance}}-rule1-value"></td>
                                                <td class="min"><button type="button" class="remove btn btn-danger" id="{{instance}}-remove1"  onclick="remove(this)">X</button></td>
                                            </tr>
                                        {% endif %}
                                    </table>
                                </div>

                                <div class="text-left mx-3 mb-3">
                                    <button type="button" class="btn btn-secondary add" id="{{instance}}-add-rule">Add another</button>
                                </div>

                            </div>

                        {% endfor %}
                        </div>

                    <div class="d-flex justify-content-between mx-3 mt-auto">
                        <button id="page3-back-button" type="button" class="btn btn-primary mb-3">Back</button>
                        <button id="submit-button" type="submit" class="btn btn-primary mb-3">Submit</button>
                        <button type="button" class="btn btn-secondary mb-3" disabled>Next</button>
                    </div>
                </div>

            </form>

            <!-- Loading modal displayed while waiting on upload -->

            <div class="modal fade" id="upload-modal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1">
                <div class="modal-dialog modal-dialog-centered" >
                    <div class="modal-content">
                        <div class="modal-header" style="border-bottom: 0px;">
                            <h3 class="mx-auto" id="upload-modal-title">Uploading...</h3>
                        </div>
                        <div class="modal-body d-flex justify-content-center mb-4" id="upload-modal-body">
                            <div class="spinner-border" style="width: 3rem; height: 3rem;" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Error modal displayed when upload fails -->

            <div class="modal fade" id="error-modal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1">
                <div class="modal-dialog modal-dialog-centered" >
                    <div class="modal-content">
                        <div class="modal-header" style="border-bottom: 0px;">
                            <h3 class="mx-auto" id="error-modal-title">Error</h3>
                        </div>
                        <div class="modal-body d-flex justify-content-center" id="error-modal-body">
                        </div>
                        <div class="modal-footer d-flex justify-content-center" id="error-modal-footer">
                        </div>
                    </div>
                </div>
            </div>

        {% else %}
            <p>FATAL ERROR</p>
        {% endif %}
    </div>

    <script>

        $('#page2').hide();
        $('#page3').hide();

        const base_url = window.location.href.split("edit_config")[0];

        // Store parameters used to re-upload config after editing
        const target_ip = "{{ context.IP }}"
        const target_filename = "{{ context.FILENAME }}"

        async function load_sensor_section(select) {
            // Get index of sensor
            const index = parseInt(select.id.replace("sensorType", ""));

            // Get user selection
            const selected = document.getElementById(select.id).value

            // Add nickname section to template, other sections added below as needed
            var template = `<div class="mb-2">
                                <label for="sensor${index}-nickname"><b>Nickname:</b></label>
                                <input type="text" class="form-control" id="sensor${index}-nickname" placeholder="" name="sensor${index}-nickname" required>
                            </div>`

            // Get template for sensor type selected by user
            if (selected == "pir" || selected == "switch") {
                template += `<div class="mb-2">
                                <label for="sensor${index}-pin"><b>Pin:</b></label>
                                <input type="text" class="form-control" id="sensor${index}-pin" placeholder="" name="sensor${index}-pin" required>
                            </div>

                            <div class="mb-2">
                                <label for="sensor${index}-default_rule"><b>Default Rule:</b></label>
                                <input type="default_rule" class="form-control" id="sensor${index}-default_rule" placeholder="" name="sensor${index}-default_rule" required>
                            </div>`

            } else if (selected == "desktop") {
                template += `<div class="mb-2">
                                <label for="sensor${index}-ip"><b>IP:</b></label>
                                <input type="text" class="form-control" id="sensor${index}-ip" placeholder="" name="sensor${index}-ip" required>
                            </div>

                            <div class="mb-2">
                                <label for="sensor${index}-default_rule"><b>Default Rule:</b></label>
                                <input type="text" class="form-control" id="sensor${index}-default_rule" placeholder="" name="sensor${index}-default_rule" required>
                            </div>`

            } else if (selected == "dummy") {
                template += `<div class="mb-2">
                                <label for="sensor${index}-default_rule"><b>Default Rule:</b></label>
                                <input type="default_rule" class="form-control" id="sensor${index}-default_rule" placeholder="" name="sensor${index}-default_rule" required>
                            </div>`
            } else if (selected == "si7021") {
                template += `<div class="mb-2">
                                <label for="sensor${index}-default_rule"><b>Default Rule:</b></label>
                                <input type="default_rule" class="form-control" id="sensor${index}-default_rule" placeholder="" name="sensor${index}-default_rule" required>
                            </div>

                            <div class="mb-2">
                                <label class="form-label" for="sensor${index}-mode"><b>Mode:</b></label>
                                <select name="sensor${index}-mode" id="sensor${index}-mode" class="form-select mb-3" required>
                                    <option value="cool" id="cool">Cool</option>
                                    <option value="heat" id="heat">Heat</option>
                                </select>
                            </div>

                            <div class="mb-2">
                                <label for="sensor${index}-tolerance"><b>Tolerance:</b></label>
                                <input type="text" class="form-control" id="sensor${index}-tolerance" placeholder="" name="sensor${index}-tolerance" required>
                            </div>`
            } else {
                // User selected first option ("Select sensor type"), clear form
                template = "";
            };

            // Render div, scroll down until visible
            document.getElementById("addSensorOptions" + index).innerHTML = template;
            document.getElementById("addSensorOptions" + index).scrollIntoView({behavior: "smooth"});
        };

        async function load_device_section(select) {
            // Get index of device
            const index = parseInt(select.id.replace("deviceType", ""));

            // Get user selection
            const selected = document.getElementById(select.id).value

            // Add nickname section to template, other sections added below as needed
            var template = `<div class="mb-2">
                                <label for="device${index}-nickname"><b>Nickname:</b></label>
                                <input type="text" class="form-control" id="device${index}-nickname" placeholder="" name="device${index}-nickname" required>
                            </div>`

            // Get template for device type selected by user
            if (selected == "dimmer" || selected == "bulb" || selected == "desktop" || selected == "api-target" || selected == "relay") {
                template += `<div class="mb-2">
                                <label for="device${index}-ip"><b>IP:</b></label>
                                <input type="text" class="form-control" id="device${index}-ip" placeholder="" name="device${index}-ip" required>
                            </div>

                            <div class="mb-2">
                                <label for="device${index}-default_rule"><b>Default Rule:</b></label>
                                <input type="default_rule" class="form-control" id="device${index}-default_rule" placeholder="" name="device${index}-default_rule" required>
                            </div>`

            } else if (selected == "mosfet" || selected == "dumb-relay") {
                template += `<div class="mb-2">
                                <label for="device${index}-pin"><b>Pin:</b></label>
                                <input type="text" class="form-control" id="device${index}-pin" placeholder="" name="device${index}-pin" required>
                            </div>

                            <div class="mb-2">
                                <label for="device${index}-default_rule"><b>Default Rule:</b></label>
                                <input type="default_rule" class="form-control" id="device${index}-default_rule" placeholder="" name="device${index}-default_rule" required>
                            </div>`

            } else if (selected == "pwm") {
                template += `<div class="mb-2">
                                <label for="device${index}-pin"><b>Pin:</b></label>
                                <input type="text" class="form-control" id="device${index}-pin" placeholder="" name="device${index}-pin" required>
                            </div>

                            <div class="mb-2">
                                <label for="device${index}-min"><b>Min brightness:</b></label>
                                <input type="min" class="form-control" id="device${index}-min" placeholder="0" name="device${index}-min" required>
                            </div>

                            <div class="mb-2">
                                <label for="device${index}-max"><b>Max brightness:</b></label>
                                <input type="text" class="form-control" id="device${index}-max" placeholder="1023" name="device${index}-max" required>
                            </div>

                            <div class="mb-2">
                                <label for="device${index}-default_rule"><b>Default Rule:</b></label>
                                <input type="default_rule" class="form-control" id="device${index}-default_rule" placeholder="" name="device${index}-default_rule" required>
                            </div>`

            } else if (selected == "ir-blaster") {
                template += `<div class="mb-2">
                                <label for="device${index}-pin"><b>Pin:</b></label>
                                <input type="text" class="form-control" id="device${index}-pin" placeholder="" name="device${index}-pin" required>
                            </div>

                            <div class="mb-2">
                                <label for="device${index}-min"><b>Virtual remotes:</b></label>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="irblaster-tv" value="irblaster-tv" id="irblaster-tv">
                                    <label class="form-check-label" for="checkbox-tv">TV (Samsung)</label></br>
                                    <input class="form-check-input" type="checkbox" name="irblaster-ac" value="irblaster-ac" id="irblaster-ac">
                                    <label class="form-check-label" for="checkbox-ac">AC (Whynter)</label>
                                </div>
                            </div>`

            } else {
                // User selected first option ("Select device type"), clear form
                template = "";
            };

            // Render div, scroll down until visible
            document.getElementById("addDeviceOptions" + index).innerHTML = template;
            document.getElementById("addDeviceOptions" + index).scrollIntoView({behavior: "smooth"});
        };

        // Store sensors added on first page, use to populate later pages
        var new_devices = []

        async function load_next_device(button) {
            // Get index of clicked button
            const index = parseInt(button.id.replace("addDeviceButton", ""));

            var template = `<div ${ index ? 'class="mt-5"' : "" }>
                                <div class="card">
                                    <div class="card-body">
                                        <h4 class="card-title">device${index + 1}</h4>
                                        <label for="deviceType${index + 1}" class="form-label"><b>Type:</b></label>
                                        <div>
                                            <select onchange="load_device_section(this)" name="deviceType${index + 1}" id="deviceType${index + 1}" class="form-select deviceType" required>
                                            <option value="clear">Select device type</option>
                                            <option value="dimmer">TP-Link Dimmer</option>
                                            <option value="bulb">TP-Link Bulb</option>
                                            <option value="relay">Smart Relay</option>
                                            <option value="dumb-relay">Relay</option>
                                            <option value="desktop">Desktop</option>
                                            <option value="pwm">LED Strip</option>
                                            <option value="mosfet">Mosfet</option>
                                            <option value="api-target">Api Command</option>
                                            <option value="ir-blaster">IR Blaster</option>
                                            </select>
                                        </div>

                                        <div id="addDeviceOptions${index + 1}" class="card-body"></div>
                                    </div>
                                </div>

                                <div class="text-center">
                                    <button onclick="load_next_device(this)" type="button" id="addDeviceButton${index + 1}" class="btn-secondary btn my-3">Add another</button>
                                </div>

                                <div id="addDeviceDiv${index + 2}">
                                </div>
                            </div>`

            // Hide clicked button
            document.getElementById("addDeviceButton" + index).style.display = "none";

            // Render div, scroll down until visible
            document.getElementById("addDeviceDiv" + (index + 1)).innerHTML = template;
            document.getElementById("addDeviceDiv" + (index + 1)).scrollIntoView({behavior: "smooth"});

            new_devices.push("device" + (index + 1));
        };

        // Store sensors added on first page, use to populate later pages
        var new_sensors = []

        async function load_next_sensor(button) {
            // Get index of clicked button
            const index = parseInt(button.id.replace("addSensorButton", ""));

            var template = `<div ${ index ? 'class="mt-5"' : "" }>
                                <div class="card">
                                    <div class="card-body">
                                        <h4 class="card-title">sensor${index + 1}</h4>
                                        <label for="sensorType${index + 1}" class="form-label"><b>Type:</b></label>
                                        <div>
                                            <select onchange="load_sensor_section(this)" name="sensorType${index + 1}" id="sensorType${index + 1}" class="form-select sensorType" required>
                                            <option value="clear">Select sensor type</option>
                                            <option value="pir">Motion Sensor</option>
                                            <option value="switch">Switch</option>
                                            <option value="dummy">Dummy</option>
                                            <option value="desktop">Desktop</option>
                                            <option value="si7021">Thermostat</option>
                                            </select>
                                        </div>

                                        <div id="addSensorOptions${index + 1}" class="card-body"></div>
                                    </div>
                                </div>

                                <div class="text-center">
                                    <button onclick="load_next_sensor(this)" type="button" id="addSensorButton${index + 1}" class="btn-secondary btn my-3">Add another</button>
                                </div>

                                <div id="addSensorDiv${index + 2}">
                                </div>
                            </div>`

            // Hide clicked button
            document.getElementById("addSensorButton" + index).style.display = "none";

            // Render div, scroll down until visible
            document.getElementById("addSensorDiv" + (index + 1)).innerHTML = template;
            document.getElementById("addSensorDiv" + (index + 1)).scrollIntoView({behavior: "smooth"});

            // Add sensor to list used to populate page 2 and 3
            new_sensors.push("sensor" + (index + 1));
        };

        document.getElementById('page1-button').addEventListener("click", function(e) {
            e.preventDefault();

            // If user added new sensors, create card for each on page2 (sensor target selection) and page3 (schedule rules)
            if (new_sensors.length > 0) {
                // Get array of all device type dropdowns
                devices = document.getElementsByClassName("deviceType");

                // Add card for each sensor that was added on first page
                for (let i = 0; i < new_sensors.length; i++) {
                    // Get type of sensor
                    const type = document.getElementById(new_sensors[i].replace("sensor", "sensorType")).value;

                    // Append card opening div to page2
                    document.getElementById("page2-cards").innerHTML +=  "<div class='card'>\
                                                                        <div class='card-body'>\
                                                                            <label for='" + new_sensors[i] + "-targets' class='card-title sensor-targets-label'><b>" + new_sensors[i] + " (" + type + ") targets:</b></label>\
                                                                            <div id='" + new_sensors[i] + "-targets' class='form-check sensor-targets'>"

                     // Iterate devices, add checkbox for each to new sensor card
                    for (let j = 0; j < devices.length; j++) {
                        // Do not add if device is IrBlaster (cannot be targeted)
                        if (devices[j].value == "ir-blaster") { continue };

                        document.getElementById(new_sensors[i] + "-targets").innerHTML += "<input type='checkbox' class='form-check-input' id='target-" + new_sensors[i] + "-" + devices[j].id.replace("deviceType", "device") + "' name='target-" + new_sensors[i] + "-" + devices[j].id.replace("deviceType", "device") + "' value='target-" + new_sensors[i] + "-" + devices[j].id.replace("deviceType", "device") + "'><label for='target-" + new_sensors[i] + "-" + devices[j].id.replace("deviceType", "device") + "' class='form-check-label'>" + devices[j].id.replace("deviceType", "device") + " (" + devices[j].value + ")</label><br>";
                    };

                    // Close div
                    document.getElementById("page2-cards").innerHTML += "</div></div></div></br>"

                    // Add schedule rule section for the new sensor to page3
                    document.getElementById("page3-cards").innerHTML += "<div class='card'>\
                                                                            <div class='card-body'>\
                                                                                <label class='card-title schedule-rule-card'><b>" + new_sensors[i] + " (" + type + "):</b></label>\
                                                                                <table id='" + new_sensors[i] + "-rules' class='table table-borderless'>\
                                                                                    <tr>\
                                                                                        <th style='text-align: left;'>Time</th>\
                                                                                        <th style='text-align: left;'>Rule</th>\
                                                                                    </tr>\
                                                                                        <tr id='" + new_sensors[i] + "-row-1'>\
                                                                                            <td><input type='text' class='form-control' id='schedule-" + new_sensors[i] + "-rule1-time' placeholder='HH:MM' name='schedule-" + new_sensors[i] + "-rule1-time' value='{{ time }}'></td>\
                                                                                            <td><input type='text' class='form-control' id='schedule-" + new_sensors[i] + "-rule1-value' placeholder='' name='schedule-" + new_sensors[i] + "-rule1-value' value='{{ rule }}'></td>\
                                                                                            <td class='min'><button type='button' class='remove btn btn-danger' id='" + new_sensors[i] + "-remove1'  onclick='remove(this)'>X</button></td>\
                                                                                        </tr>\
                                                                                </table>\
                                                                            </div>\
                                                                            <div class='text-left mx-3 mb-3'>\
                                                                                <button type='button' class='btn btn-secondary add' id='" + new_sensors[i] + "-add-rule'>Add another</button>\
                                                                            </div>\
                                                                        </div></br>"
                };
            };

            // Clear new_sensors (prevent adding duplicates if user goes back and forth between pages without adding anything)
            new_sensors = []

            // If user changed a sensor's type, update type listed on page2 to reflect
            sensors = document.getElementsByClassName("sensor-targets-label")
            for (let sen = 0; sen < sensors.length; sen++) {
                id = sensors[sen].innerHTML.split(" ")[0].split(">")[1];

                old_type = sensors[sen].innerHTML.split(" ")[1].replace("(", "").replace(")", "");
                new_type = document.getElementById(id.replace("sensor", "sensorType")).value;

                if (old_type != new_type) {
                    sensors[sen].innerHTML = sensors[sen].innerHTML.replace(old_type, new_type);

                    // Uncheck all target boxes
                    for (el of document.getElementById(id + "-targets").children) {
                        // Children contains inputs, their labels, and line breaks - only process inputs
                        if (el.classList.contains("form-check-input")) {
                            el.checked = false;
                        }
                    }
                };
            };

            // Get array of all device type dropdowns on page1
            devices = document.getElementsByClassName("deviceType");

            // Get array of all sensor-target cards on page2
            sensors = document.getElementsByClassName("sensor-targets");

            // Iterate device dropdowns
            for (let dev = 0; dev < devices.length; dev++) {

                const dev_id = devices[dev].id.replace("deviceType", "device");
                const dev_type = devices[dev].value;

                // Iterate sensor sections
                for (let sen = 0; sen < sensors.length; sen++) {

                    const sen_id = sensors[sen].id.replace("-targets", "");

                    var found = false;

                    // Iterate options within current sensor section
                    for (let opt = 0; opt < sensors[sen].childElementCount; opt++) {
                        // Children contains inputs, their labels, and line breaks - only process inputs (first of every 3)
                        if (opt % 3) { continue };

                        // Check if option is for device from outer loop
                        if (sensors[sen].children[opt].id.split("-")[2] == dev_id) {
                            found = true;

                            // If so, check if type has changed
                            if (sensors[sen].children[opt+1].innerHTML.replace(dev_id + " (", "").replace(")", "") == dev_type) {
                                // If type hasn't changed, go to next sensor section
                                break
                            } else if (dev_type == "ir-blaster") {
                                // If device type changed to IrBlaster, remove checkbox (cannot be targeted, API only)
                                sensors[sen].children[opt+2].remove();
                                sensors[sen].children[opt+1].remove();
                                sensors[sen].children[opt].remove();
                            } else {
                                // If type HAS changed, replace and uncheck box
                                sensors[sen].children[opt+1].innerHTML = dev_id + " (" + dev_type + ")"
                                sensors[sen].children[opt].checked = false;

                                // Go to next sensor section
                                break
                            };
                        };
                    };

                    // If no match was found, add the device as an option (unless device is IrBlaster)
                    if (!found && dev_type != "ir-blaster") {
                        sensors[sen].innerHTML += "<input type='checkbox' class='form-check-input' id='target-" + sen_id + "-" + dev_id + "' name='target-" + sen_id + "-" + dev_id + "' value='target-" + sen_id + "-" + dev_id + "'><label for='target-" + sen_id + "-" + dev_id + "' class='form-check-label'>" + dev_id + " (" + dev_type + ")</label><br>";
                    };
                };
            };

            document.getElementById("page2").classList.add("d-flex");
            document.getElementById("page1").classList.remove("d-flex");
            document.getElementById("page1").style.display = "none";
        });

        document.getElementById('page2-button').addEventListener("click", function(e) {
            e.preventDefault();

            // If user added new devices, create card for each on page3 (schedule rules)
            if (new_devices.length > 0) {
                // Get array of all device type dropdowns
                devices = document.getElementsByClassName("deviceType");

                // Add card for each device that was added on first page
                for (let i = 0; i < new_devices.length; i++) {
                    // Get type of device
                    const type = document.getElementById(new_devices[i].replace("device", "deviceType")).value;

                    // Do not add IrBlaster (doesn't support schedule rules)
                    if (type == "ir-blaster") { continue };

                    // Add schedule rule section for the new device to page3
                    document.getElementById("page3-cards").innerHTML += "<div class='card'>\
                                                                            <div class='card-body'>\
                                                                                <label class='card-title schedule-rule-card'><b>" + new_devices[i] + " (" + type + "):</b></label>\
                                                                                <table id='" + new_devices[i] + "-rules' class='table table-borderless'>\
                                                                                    <tr>\
                                                                                        <th style='text-align: left;'>Time</th>\
                                                                                        <th style='text-align: left;'>Rule</th>\
                                                                                    </tr>\
                                                                                        <tr id='" + new_devices[i] + "-row-1'>\
                                                                                            <td><input type='text' class='form-control' id='schedule-" + new_devices[i] + "-rule1-time' placeholder='HH:MM' name='schedule-" + new_devices[i] + "-rule1-time' value='{{ time }}'></td>\
                                                                                            <td><input type='text' class='form-control' id='schedule-" + new_devices[i] + "-rule1-value' placeholder='' name='schedule-" + new_devices[i] + "-rule1-value' value='{{ rule }}'></td>\
                                                                                            <td class='min'><button type='button' class='remove btn btn-danger' id='" + new_devices[i] + "-remove1'  onclick='remove(this)'>X</button></td>\
                                                                                        </tr>\
                                                                                </table>\
                                                                            </div>\
                                                                            <div class='text-left mx-3 mb-3'>\
                                                                                <button type='button' class='btn btn-secondary add' id='" + new_devices[i] + "-add-rule'>Add another</button>\
                                                                            </div>\
                                                                        </div></br>"
                };
            };

            // Clear new_devices (prevent adding duplicates if user goes back and forth between pages without adding anything)
            new_devices = []

            // If user changed a sensor or device's type, update type listed on page3 to reflect
            instances = document.getElementsByClassName("schedule-rule-card");
            for (let i = 0; i < instances.length; i++) {
                id = instances[i].innerHTML.split(" ")[0].split(">")[1];

                old_type = instances[i].innerHTML.split(" ")[1].replace("(", "").replace(")", "").split(":")[0];

                if (id.startsWith("device")) {
                    new_type = document.getElementById(id.replace("device", "deviceType")).value;
                } else if (id.startsWith("sensor")) {
                    new_type = document.getElementById(id.replace("sensor", "sensorType")).value;
                } else {
                    // Should not be possible, prevent error if somehow happens
                    continue
                };

                if (old_type != new_type) {
                    // If changed to IrBlaster, remove card (doesn't support schedule rules)
                    if (new_type == "ir-blaster") {
                        instances[i].parentElement.parentElement.remove();
                        continue;
                    }

                    instances[i].innerHTML = instances[i].innerHTML.replace(old_type, new_type);

                    // Clear all existing schedule rules (likely invalid for new type)
                    document.getElementById(id + "-rules").innerHTML = "<tr>\
                                                                            <th style='text-align: left;'>Time</th>\
                                                                            <th style='text-align: left;'>Rule</th>\
                                                                        </tr>\
                                                                        <tr id='" + id + "-row-1'>\
                                                                            <td><input type='text' class='form-control' id='schedule-" + id + "-rule1-time' placeholder='HH:MM' name='schedule-" + id + "-rule1-time'></td>\
                                                                            <td><input type='text' class='form-control' id='schedule-" + id + "-rule1-value' placeholder='' name='schedule-" + id + "-rule1-value'></td>\
                                                                            <td class='min'><button type='button' class='btn btn-danger' id='placeholder_button' style='visibility: hidden;'>X</button></td>\
                                                                        </tr>"
                };
            };

            document.getElementById("page3").classList.add("d-flex");
            document.getElementById("page2").classList.remove("d-flex");
            document.getElementById("page2").style.display = "none";
        });

        document.getElementById('page1-back-button').addEventListener("click", function(e) {
            window.location.replace("/node_configuration");
        });

        document.getElementById('page2-back-button').addEventListener("click", function(e) {
            e.preventDefault();

            document.getElementById("page1").classList.add("d-flex");
            document.getElementById("page2").classList.remove("d-flex");
            document.getElementById("page2").style.display = "none";
        });

        document.getElementById('page3-back-button').addEventListener("click", function(e) {
            e.preventDefault();

            document.getElementById("page2").classList.add("d-flex");
            document.getElementById("page3").classList.remove("d-flex");
            document.getElementById("page3").style.display = "none";
        });

        function add(e) {
            var instance = e.target.id.split("-", 1)[0];

            table = document.getElementById(instance + "-rules")

            // Rows are numbered sequentially. Get number of last row and increment
            var next_row = parseInt($('#' + instance + '-rules tr:last').attr('id').split("-").pop()) + 1;

            var row = table.insertRow();
            row.setAttribute("id", instance + "-row-" + next_row)

            var cell_time = row.insertCell(0);
            var cell_value = row.insertCell(1);
            var cell_del = row.insertCell(2);

            cell_time.innerHTML = "<input type='text' class='form-control' id='schedule-" + instance + "-rule" + next_row + "-time' placeholder='HH:MM' name='schedule-" + instance + "-rule" + next_row + "-time'>";
            cell_value.innerHTML = "<input type='text' class='form-control' id='schedule-" + instance + "-rule" + next_row + "-value' placeholder='' name='schedule-" + instance + "-rule" + next_row + "-value'>";
            cell_del.innerHTML = "<button type='button' class='remove btn btn-danger' id='" + instance + "-remove" + next_row + "' onclick='remove(this)'>X</button>";

        };

        function remove(e) {
            var instance = e.id;
            var index = e.parentElement.parentElement.rowIndex

            table = document.getElementById(instance.split("-", 1) + "-rules")
            table.deleteRow(index)
        };

        $('.add').on('click', add);

        document.getElementById('form').addEventListener("submit", function(e) {
            e.preventDefault();

            // Disable submit button, prevent submitting multiple times
            document.getElementById("submit-button").disabled = true;

            submit_form();
        });

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        async function send_post_request(url, body) {
            let csrftoken = getCookie('csrftoken');

            var response = await fetch(url, {
                method: 'POST',
                body: JSON.stringify(body),
                headers: { 'Accept': 'application/json, text/plain, */*',
                    'Content-Type': 'application/json',
                    "X-CSRFToken": csrftoken }
            });

            return response
        };

        // Show the modal with id modal, optionally change title/body/footer
        function show_modal(modal, title=false, body=false, footer=false) {
            if (title) {
                document.getElementById(modal + "-title").innerHTML = title;
            };

            if (body) {
                document.getElementById(modal + "-body").innerHTML = body;
            };

            if (footer) {
                document.getElementById(modal + "-footer").innerHTML = footer;
            };

            $('#' + modal).modal('show');
        };

        async function submit_form() {
            let csrftoken = getCookie('csrftoken');

            const value = Object.fromEntries(new FormData(document.getElementById("form")).entries());

            // Generate config file from form data
            var response = await send_post_request(base_url + "generateConfigFile/True", value);

            // If successful, re-upload config file to node
            if (response.ok) {
                // Show loading screen
                show_modal("upload-modal");

                // Reupload config file
                var result = await send_post_request(base_url + "upload/True", {config: target_filename, ip: target_ip});

                // If reupload successful, redirect back to overview (otherwise display error in alert)
                if (result.ok) {
                    // Change title, show success animation
                    const title = "Upload Complete"
                    const body = `<svg class="checkmark" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 52 52">
                                      <circle class="checkmark__circle" cx="26" cy="26" r="25" fill="none"/>
                                      <path class="checkmark__check" fill="none" d="M14.1 27.2l7.1 7.2 16.7-16.8"/>
                                  </svg>`
                    show_modal("upload-modal", title, body);

                    // Wait for animation to complete before redirect
                    await sleep(1200);
                    window.location.replace("/node_configuration");

                // If reupload failed, display error
                } else {
                    handle_error(result);
                };
            } else {
                alert(await response.text());

                // Re-enable submit button so user can try again
                document.getElementById("submit-button").disabled = false;

                return false;
            };
        };

        $('#no-button').click(function() {
            // Remove listeners (prevent stacking)
            $('#yes-button').off('click');
            $('#error-modal').modal('hide');
        });

        async function handle_error(result) {
            // Unable to upload because node has not run setup
            if (result.status == 409) {
                const error = await result.text();
                const footer = `<button type="button" id="yes-button" class="btn btn-secondary" data-bs-dismiss="modal">Yes</button><button type="button" id="no-button" class="btn btn-secondary" data-bs-dismiss="modal">No</button>`

                // Replace loading modal with error modal
                $('#upload-modal').modal('hide');
                show_modal("error-modal", "Error", `${error}`, footer);

                $('#yes-button').click(async function() {
                    // Remove listeners (prevent stacking)
                    $('#yes-button').off('click');

                    // Show loading again, upload setup file
                    $("#error-modal").modal("hide");
                    show_modal("upload-modal");
                    var result = await send_post_request(base_url + "upload/True", {config: "setup.json", ip: target_ip});

                    if (result.ok) {
                        // After uploading config, tell user to reboot node then click OK
                        $("#upload-modal").modal("hide");
                        const footer = `<button type="button" id="ok-button" class="btn btn-success" data-bs-dismiss="modal">OK</button>`
                        show_modal("error-modal", "Success", "Please reboot node, then press OK to resume upload", footer);

                        // When user clicks OK, resubmit form (setup has finished running, should now be able to upload)
                        $('#ok-button').click(function() {
                            $("#error-modal").modal("hide");
                            $('#ok-button').off('click');
                            submit_form();
                        });
                    } else {
                        alert(await result.text());

                        // Re-enable submit button so user can try again
                        document.getElementById("submit-button").disabled = false;
                    };
                });
            } else if (result.status == 404) {
                $('#upload-modal').modal('hide');

                const footer = `<button type="button" id="ok-button" class="btn btn-success" data-bs-dismiss="modal">OK</button>`
                show_modal("error-modal", "Connection Error", `Unable to connect to ${target_ip} - please make sure node is connected to wifi and try again`, footer);

                // When user clicks OK, re-enable submit button so user can try again
                $('#ok-button').click(function() {
                    $("#error-modal").modal("hide");
                    $('#ok-button').off('click');
                    document.getElementById("submit-button").disabled = false;
                });
            } else {
                alert(await result.text());

                // Re-enable submit button so user can try again
                document.getElementById("submit-button").disabled = false;
            };
        };

        // Listen for system theme changes, switch to dark/light mode to reflect (responsive)
        window.matchMedia('(prefers-color-scheme: dark)').addListener(function (e) {
            if (e.matches) { // Returns True for dark mode, False otherwise
                document.body.classList.add("dark");
                document.body.classList.remove("light");
            } else {
                document.body.classList.remove("dark");
                document.body.classList.add("light");
            }
        });
    </script>

</body>


</html>
