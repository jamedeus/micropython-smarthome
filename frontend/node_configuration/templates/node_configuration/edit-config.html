{% load static %}
{% load pwa %}

<!DOCTYPE html>
<html lang="en">
<head>
    {% if config|length == 2 %}
    <title>Create new config file</title>
    {% else %}
    <title>{{ config.TITLE }}</title>
    {% endif %}
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    {% progressive_web_app_meta %}
    <link rel="stylesheet" href="{% static 'bootstrap.min.css' %}">
    <link rel="stylesheet" href="{% static 'bootstrap-icons.css' %}">
    <link rel="stylesheet" href="{% static 'node_configuration/style.css' %}">
    <link rel="stylesheet" href="{% static 'api/sliders.css' %}">
    <script src="{% static 'bootstrap.min.js' %}"></script>
    <script src="{% static 'jquery.min.js' %}"></script>
    <script src="{% static 'rangeslider.min.js' %}"></script>
    <script src="{% static 'smoothscroll.min.js' %}"></script>
    <script src="{% static 'node_configuration/classes.js' %}"></script>
    <style>
        /* Force equal width for schedule rule fields */
        td {
            width: 50%;
        }

        /* Delete card animation */
        :root {
            --animation-height: 25rem;
        }

        @keyframes slide-up {
            0% {
                bottom: 0rem;
            }
            100% {
                bottom: var(--animation-height);
            }
        }

        .slide-up {
            animation-name: slide-up;
            animation-duration: 0.8s;
            animation-timing-function: ease;
            animation-fill-mode: forwards;
        }

        @keyframes fade-out {
            0% {
                opacity: 100%;
            }
            100% {
                opacity: 0%;
            }
        }

        .fade-out {
            animation-name: fade-out;
            animation-duration: 0.4s;
            animation-timing-function: ease;
            animation-fill-mode: forwards;
        }

        .fade-in {
            animation-name: fade-out;
            animation-direction: reverse;
            animation-duration: 0.4s;
            animation-timing-function: ease;
            animation-fill-mode: forwards;
        }
    </style>
</head>

<body>
    <script>
        // Check if user is in dark mode, change theme (runs once on page load)
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.body.classList.add("dark");
            console.log("Dark mode");
        } else {
            document.body.classList.add("light");
        };
    </script>

    <div class="container d-flex flex-column vh-100">
        <h1 class="text-center pt-3 pb-4">{{ config.TITLE }}</h1>

        <div id="page1" class="d-flex flex-column h-100">
            <form id="form" onkeydown="return event.key != 'Enter';">
                <div  class="mb-4">
                    <h2>Metadata</h2>
                    <div class="mb-2">
                        <label for="friendlyName"><b>Name:</b></label>
                        <input type="text" class="form-control" id="friendlyName" placeholder="" name="friendlyName" value="{{config.NAME}}" oninput="prevent_duplicate_friendly_name(this)" aria-describedby="friendlyName-feedback" required>
                        <div id="friendlyName-feedback" class="invalid-feedback">
                            Name must be unique
                        </div>
                    </div>
                    <div class="mb-2">
                        <label for="location"><b>Location:</b></label>
                        <input type="text" class="form-control" id="location" placeholder="" name="location" value="{{config.metadata.location}}" required>
                    </div>
                    <div class="mb-2">
                        <label for="floor"><b>Floor:</b></label>
                        <input type="text" class="form-control" id="floor" placeholder="" name="floor" value="{{config.metadata.floor}}" required>
                    </div>
                </div>
                <div class="mb-4">
                    <h2>Wifi</h2>
                    <div class="mb-2">
                        <label for="ssid"><b>SSID:</b></label>
                        <input type="text" class="form-control" id="ssid" placeholder="" name="ssid" value="{{config.wifi.ssid}}" onchange="open_toast()" required>
                    </div>
                    <div class="mb-2">
                        <label for="password"><b>Password:</b></label>
                        <input type="password" class="form-control" id="password" placeholder="" name="password" value="{{config.wifi.password}}" onchange="open_toast()" required>
                    </div>
                </div>
            </form>

            <div class="row">
                <div id="sensors" class="col-sm">
                    <h2 class="text-center">Add Sensors</h2>

                    {% for sensor, params in config.sensors.items %}

                        {% if forloop.first %}
                        <div id="addSensorDiv1" class="sensor{{forloop.counter}}">
                        {% else %}
                        <div id="addSensorDiv{{ forloop.counter }}" class="mt-5 sensor{{forloop.counter}}">
                        {% endif %}
                        <div class="card">
                            <div class="card-body">
                                <div class="d-flex justify-content-between">
                                    <button class="btn ps-2" style="visibility:hidden;"><i class="bi-x-lg"></i></button>
                                    <h4 class="card-title mx-auto my-auto sensor{{forloop.counter}}">sensor{{ forloop.counter }}</h4>
                                    <button class="btn my-auto pe-2 sensor{{forloop.counter}} delete" id="sensor{{ forloop.counter }}-remove" onclick="remove_instance(this)"><i class="bi-x-lg"></i></button>
                                </div>

                                {% include "node_configuration/sensor_type_dropdown.html" with index=forloop.counter selected=params.type %}

                                <div class="card-body sensor{{forloop.counter}} configParams">
                                    <div class="mb-2">
                                        <label for="sensor{{forloop.counter}}-nickname" class="sensor{{forloop.counter}}"><b>Nickname:</b></label>
                                        <input type="text" class="form-control sensor{{forloop.counter}} nickname" id="sensor{{forloop.counter}}-nickname" placeholder="" value="{{params.nickname}}" onchange="update_nickname(this)" oninput="prevent_duplicate_nickname(event)" required>
                                        <div id="sensor-nickname-feedback" class="invalid-feedback">Name already in use</div>
                                    </div>

                                {# Add non-rule parameter inputs #}
                                {% if "pin" in params %}
                                    {% include "node_configuration/sensor_pin_select.html" with index=forloop.counter %}
                                {% endif %}

                                {% if "ip" in params %}
                                    {% include "node_configuration/ip_address_input.html" with category="sensor" %}
                                {% endif %}

                                {# Add default rule input #}
                                {% if params.metadata.prompt == "float_range" %}
                                    {% include "node_configuration/default_rule_float_range.html" with step="0.5" category="sensor" %}

                                {% elif params.metadata.prompt == "standard" %}
                                    {% include "node_configuration/default_rule_standard.html" with category="sensor" %}

                                {% elif params.metadata.prompt == "on_off" %}
                                    {% include "node_configuration/default_rule_on_off.html" with category="sensor" %}
                                {% endif %}

                                {# Add Thermostat-specific inputs #}
                                {% if params.type == "si7021" %}

                                    <div class="mb-2">
                                        <label class="form-label sensor{{forloop.counter}}" for="sensor{{forloop.counter}}-mode"><b>Mode:</b></label>
                                        <select id="sensor{{forloop.counter}}-mode" class="form-select mb-3 sensor{{forloop.counter}}" required>
                                            {% if params.mode == "cool" %}
                                                <option value="cool" id="cool" selected>Cool</option>
                                                <option value="heat" id="heat">Heat</option>
                                            {% elif params.mode == "heat" %}
                                                <option value="cool" id="cool">Cool</option>
                                                <option value="heat" id="heat" selected>Heat</option>
                                            {% else %}
                                                <option value="cool" id="cool">Cool</option>
                                                <option value="heat" id="heat">Heat</option>
                                            {% endif %}
                                        </select>
                                    </div>

                                    <div class="mb-2">
                                        <label for="sensor{{forloop.counter}}-tolerance" class="sensor{{forloop.counter}}"><b>Tolerance:</b></label>
                                        <input type="text" class="form-control sensor{{forloop.counter}} thermostat" id="sensor{{forloop.counter}}-tolerance" placeholder="" value="{{params.tolerance}}" required>
                                    </div>

                                {% endif %}
                                </div>
                            </div>
                        </div>

                        {% if forloop.last %}
                        <div class="text-center position-relative">
                            <button onclick="load_next_sensor(this)" type="button" id="addSensorButton{{ forloop.counter }}" class="btn-secondary btn my-3 sensor{{forloop.counter}}">Add another</button>
                        </div>
                        {% else %}
                        <div class="text-center position-relative">
                            <button onclick="load_next_sensor(this)" type="button" id="addSensorButton{{ forloop.counter }}" class="btn-secondary btn my-3 sensor{{forloop.counter}}" style="display:none">Add another</button>
                        </div>
                        {% endif  %}

                        </div>
                    {% endfor %}

                    {# If no sensor cards, add button to create card #}
                    {% if config.sensors|length == 0 %}
                    <div class="text-center">
                        <button onclick="load_next_sensor(this)" type="button" id="addSensorButton0" class="btn-secondary btn my-3">Add</button>
                    </div>
                    {% endif %}
                </div>

                <div id="devices" class="col-sm">
                    <h2 class="text-center">Add Devices</h2>

                    {% for device, params in config.devices.items %}

                        {% if forloop.first %}
                        <div id="addDeviceDiv1" class="device1">
                        {% else %}
                        <div id="addDeviceDiv{{ forloop.counter }}" class="device{{forloop.counter}} mt-5">
                        {% endif %}
                        <div class="card">
                            <div class="card-body">
                                <div class="d-flex justify-content-between">
                                    <button class="btn ps-2" style="visibility:hidden;"><i class="bi-x-lg"></i></button>
                                    <h4 class="card-title mx-auto my-auto device{{forloop.counter}}">device{{ forloop.counter }}</h4>
                                    <button class="btn my-auto pe-2 device{{forloop.counter}} delete" id="device{{ forloop.counter }}-remove" onclick="remove_instance(this)"><i class="bi-x-lg"></i></button>
                                </div>

                                {% include "node_configuration/device_type_dropdown.html" with index=forloop.counter selected=params.type %}

                                <div class="card-body device{{forloop.counter}} configParams">
                                    <div class="mb-2">
                                        <label for="device{{forloop.counter}}-nickname" class="device{{forloop.counter}}"><b>Nickname:</b></label>
                                        <input type="text" class="form-control device{{forloop.counter}} nickname" id="device{{forloop.counter}}-nickname" placeholder="" value="{{params.nickname}}" onchange="update_nickname(this)" oninput="prevent_duplicate_nickname(event)" required>
                                        <div id="sensor-nickname-feedback" class="invalid-feedback">Name already in use</div>
                                    </div>

                                {# Add non-rule parameter inputs #}
                                {% if "pin" in params %}
                                    {% include "node_configuration/device_pin_select.html" with index=forloop.counter %}
                                {% endif %}

                                {% if "ip" in params %}
                                    {% include "node_configuration/ip_address_input.html" with category="device" %}
                                {% endif %}

                                {% if "uri" in params %}
                                    {% include "node_configuration/uri_input.html" with category="device" %}
                                {% endif %}

                                {# Add default rule input #}
                                {% if params.metadata.prompt == "int_or_fade" %}
                                    {% include "node_configuration/default_rule_int_or_fade.html" with category="device" %}

                                {% elif params.metadata.prompt == "standard" %}
                                    {% include "node_configuration/default_rule_standard.html" with category="device" %}

                                {% elif params.type == "api-target" %}

                                    <div class="mb-2">
                                        <label for="device{{ forloop.counter }}-ip" class="device{{forloop.counter}}"><b>Target Node:</b></label>
                                        <select id="device{{ forloop.counter }}-ip" class="form-select mb-3 device{{forloop.counter}}" onchange="api_target_selected(this)">
                                            <option value="" selected="selected"></option>
                                            {% for node, ip in api_target_options.addresses.items %}
                                                <option value="{{ip}}" {% if params.ip == ip %}selected{% endif %}>{{node}}</option>
                                            {% endfor %}
                                        </select>
                                    </div>

                                    <div class="mb-2 text-center">
                                        <button id="device{{ forloop.counter }}-default_rule-button" class="btn btn-secondary mt-3 device{{forloop.counter}}" onclick="open_rule_modal(this);" type="button" data-original="{{params.default_rule}}" data-target="device{{ forloop.counter }}-default_rule">Set rule</button>
                                    </div>

                                    {# Hidden field receives rule from modal, onchange adds to button dataset attr (repopulate modal if reopened) #}
                                    <div class="mb-2 text-center">
                                        <label for="device{{ forloop.counter }}-default_rule" class="device{{forloop.counter}}" style="display:none;"><b>Default Rule:</b></label>
                                        <input type="default_rule" class="form-control device{{forloop.counter}}" id="device{{ forloop.counter }}-default_rule" placeholder="" style="display:none;" value="{{params.default_rule}}" onchange="document.getElementById('device{{forloop.counter}}-default_rule-button').dataset.original = this.value;" required>
                                    </div>

                                {% endif %}
                                </div>
                            </div>
                        </div>

                        {% if forloop.last and not config.ir_blaster %}
                        <div class="text-center position-relative">
                            <button onclick="load_next_device(this)" type="button" id="addDeviceButton{{ forloop.counter }}" class="btn-secondary btn my-3 device{{forloop.counter}}">Add another</button>
                        </div>
                        {% else %}
                        <div class="text-center position-relative">
                            <button onclick="load_next_device(this)" type="button" id="addDeviceButton{{ forloop.counter }}" class="btn-secondary btn my-3 device{{forloop.counter}}" style="display:none">Add another</button>
                        </div>
                        {% endif  %}
                    </div>

                    {% endfor %}

                    {% if config.ir_blaster %}

                    <div id="addDeviceDiv{{ config.devices|length|add:1 }}" class="device{{config.devices|length|add:1}} {% if config.devices|length %}mt-5{% endif %}">
                        <div class="card">
                            <div class="card-body">
                                <div class="d-flex justify-content-between">
                                    <button class="btn ps-2" style="visibility:hidden;"><i class="bi-x-lg"></i></button>
                                    <h4 class="card-title mx-auto my-auto device{{config.devices|length|add:1}}">device{{ config.devices|length|add:1 }}</h4>
                                    <button class="btn my-auto pe-2 device{{config.devices|length|add:1}} delete" id="device{{ config.devices|length|add:1 }}-remove" onclick="remove_instance(this)"><i class="bi-x-lg"></i></button>
                                </div>
                                {% include "node_configuration/device_type_dropdown.html" with index=forloop.counter selected="ir-blaster" %}

                                <div class="card-body device{{config.devices|length|add:1}} configParams">
                                    {% include "node_configuration/device_pin_select.html" with index=config.devices|length|add:1 %}

                                    <div class="mb-2">
                                        <label for="device{{ config.devices|length|add:1 }}-remotes" class="device{{config.devices|length|add:1}}"><b>Virtual remotes:</b></label>
                                        <div id="device{{ config.devices|length|add:1 }}-remotes" class="form-check device{{config.devices|length|add:1}}">
                                            <input class="form-check-input ir-target" type="checkbox" value="irblaster-tv" id="checkbox-tv" {% if "tv" in config.ir_blaster.target %}checked{% endif %}>
                                            <label class="form-check-label" for="checkbox-tv">TV (Samsung)</label></br>
                                            <input class="form-check-input ir-target" type="checkbox" value="irblaster-ac" id="checkbox-ac" {% if "ac" in config.ir_blaster.target %}checked{% endif %}>
                                            <label class="form-check-label" for="checkbox-ac">AC (Whynter)</label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="text-center position-relative">
                            <button onclick="load_next_device(this)" type="button" id="addDeviceButton{{ config.devices|length|add:1 }}" class="btn-secondary btn my-3 device{{config.devices|length|add:1}}">Add another</button>
                        </div>
                    </div>

                    {% endif %}

                    {# If no device cards, add button to create card #}
                    {% if config.devices|length == 0 and not config.ir_blaster %}
                    <div class="text-center">
                        <button onclick="load_next_device(this)" type="button" id="addDeviceButton0" class="btn-secondary btn my-3">Add</button>
                    </div>
                    {% endif %}

                </div>
            </div>

            <div class="d-flex justify-content-between mx-3 mt-auto">
                <button id="page1-back-button" type="button" class="btn btn-secondary mb-3">Back</button>
                <button type="button" class="btn btn-primary mb-3" style="visibility: hidden;">Submit</button>
                <button id="page1-button" type="button" class="btn btn-primary mb-3">Next</button>
            </div>
        </div>

        <div id="page2" class="flex-column h-100">
            <div id="page2-cards">
                <h3>Select targets for each sensor</h3>

                {% for sensor, params in config.sensors.items %}

                    <div class="card mb-4 {{sensor}}">
                        <div class="card-body">
                            <label id="{{sensor}}-targets-label" for="{{sensor}}-targets" class="card-title {{sensor}}"><b>{{ params.nickname }}</b> targets:</label>
                            <div id="{{sensor}}-targets" class="form-check sensor-targets {{sensor}}">

                                {% for device, dparams in config.devices.items %}

                                    <input type="checkbox" class="form-check-input {{sensor}} {{device}} target" id="target-{{sensor}}-{{device}}" value="target-{{sensor}}-{{device}}" {% if device in params.targets %}checked{% endif %}>
                                    <label for="target-{{sensor}}-{{device}}" class="form-check-label {{sensor}} {{device}} target-label">{{ dparams.nickname }}</label>
                                    <br class="{{device}}">

                                {% endfor %}
                            </div>
                        </div>
                    </div>

                {% endfor %}
            </div>

            <div class="d-flex justify-content-between mx-3 mt-auto">
                <button id="page2-back-button" type="button" class="btn btn-primary mb-3">Back</button>
                <button type="button" class="btn btn-primary mb-3" style="visibility: hidden;">Submit</button>
                <button id="page2-button" type="button" class="btn btn-primary mb-3">Next</button>
            </div>
        </div>

        <div id="page3" class="flex-column h-100">
            <h3>Add schedule rules (optional)</h3>
                <div id="page3-cards">

                {% for instance, params in config.instances.items %}

                    <div class="card mb-4 {{instance}}">
                        <div class="card-body text-center">
                            <label id="{{instance}}-rules-label" class="card-title schedule-rule-card {{instance}}" title="{{instance}} - {{params.type}}">
                                <b>{{ params.nickname }}</b>
                            </label>
                            <table id="{{instance}}-rules" class="table table-borderless {{instance}} {% if params.schedule.items|length == 0 %} d-none {% endif %}">
                                <tr>
                                    <th style="text-align: center;">Time</th>
                                    <th style="text-align: center;">Rule</th>
                                </tr>

                            {% if params.schedule.items|length > 0 %}
                            {% for time, rule in params.schedule.items %}

                                <tr id="{{instance}}-row-{{forloop.counter}}" class="{{instance}}">
                                    <td>
                                        <span class="form-control time {{instance}}" id="{{instance}}-rule{{forloop.counter}}-time" data-original="{{time}}" data-type="{{params.type}}" onclick="edit_existing_rule(this);">{{time}}</span>
                                    </td>

                                    {% if params.type == "api-target" %}

                                    <td>
                                        <span class="form-control {{instance}}" id="{{instance}}-rule{{forloop.counter}}-button" data-original="{{rule}}" data-type="{{params.type}}" onclick="edit_existing_rule(this);">click to view</span>
                                        <input type="text" class="form-control rule {{instance}}" id="{{instance}}-rule{{forloop.counter}}" data-original="{{rule}}" data-type="{{params.type}}" style="display:none;">
                                    </td>

                                    {% else %}

                                    <td>
                                        <span class="form-control rule {{instance}}" id="{{instance}}-rule{{forloop.counter}}" data-original="{{rule}}" data-type="{{params.type}}" onclick="edit_existing_rule(this);">{{rule}}</span>
                                    </td>

                                    {% endif %}

                                    <td class="min">
                                        <button type="button" class="btn btn-sm btn-primary mt-1" id="{{instance}}-edit{{forloop.counter}}" data-type="{{params.type}}" onclick="edit_existing_rule(this);"><i class="bi-pencil"></i></button>
                                    </td>
                                </tr>

                            {% endfor %}
                            {% endif %}

                            </table>
                            <div>
                                <button type="button" class="btn btn-secondary {{instance}}" id="{{instance}}-add-rule" data-type="{{params.type}}" onclick="add_new_rule(this)">Add Rule</i></button>
                            </div>
                        </div>
                    </div>

                {% endfor %}

                </div>
            <div class="d-flex justify-content-between mx-3 mt-auto">
                <button id="page3-back-button" type="button" class="btn btn-primary mb-3">Back</button>
                <button id="submit-button" type="submit" class="btn btn-primary mb-3">Submit</button>
                <button type="button" class="btn btn-secondary mb-3" disabled>Next</button>
            </div>
        </div>

        <!-- Schedule rule modal opened when user clicks rule parameter -->

        <div class="modal fade" id="schedule-rule-modal" tabindex="-1">
            <div class="modal-dialog modal-dialog-centered" style="max-width:750px">
                <div class="modal-content">
                    <div class="modal-header justify-content-between">
                        <button type="button" class="btn-close" style="visibility:hidden;"></button>
                        <h5 class="modal-title">Schedule Rule</h5>
                        <button type="button" class="btn-close" id="schedule-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body d-flex flex-column" id="rule-modal-body">
                    <!-- Populated by template when opened -->
                    </div>
                    <div id="rule-footer" class="modal-footer mx-auto">
                        <div id="rule-buttons">
                            <button type="button" id="add-rule" class="btn btn-success" onclick="add_rule()">Submit</button>
                            <button type="button" id="del-rule" class="btn btn-danger" onclick="delete_rule()">Delete</button>
                        </div>
                        <div id="rule-loading" class="m-0 d-none">
                            <div class="sk-flow">
                                <div class="sk-flow-dot my-auto"></div>
                                <div class="sk-flow-dot my-auto"></div>
                                <div class="sk-flow-dot my-auto"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Loading modal displayed while waiting on upload -->

        <div class="modal fade" id="upload-modal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1">
            <div class="modal-dialog modal-dialog-centered" >
                <div class="modal-content">
                    <div class="modal-header" style="border-bottom: 0px;">
                        <h3 class="mx-auto" id="upload-modal-title">Uploading...</h3>
                    </div>
                    <div class="modal-body d-flex justify-content-center mb-4" id="upload-modal-body">
                        <div class="spinner-border" style="width: 3rem; height: 3rem;" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Error modal displayed when upload fails -->

        <div class="modal fade" id="error-modal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1">
            <div class="modal-dialog modal-dialog-centered" >
                <div class="modal-content">
                    <div class="modal-header" style="border-bottom: 0px;">
                        <h3 class="mx-auto" id="error-modal-title">Error</h3>
                    </div>
                    <div class="modal-body d-flex justify-content-center flex-column mx-auto" id="error-modal-body">
                    </div>
                    <div class="modal-footer d-flex justify-content-center" id="error-modal-footer">
                    </div>
                </div>
            </div>
        </div>

        <!-- Overwrite duplicate modal dialog -->

        <div class="modal fade" id="duplicate-modal" tabindex="-1">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header" style="border-bottom: 0px;">
                        <h5 class="mx-auto" id="error-modal-title">Duplicate Warning</h5>
                    </div>
                    <div class="modal-body text-center" id="duplicate-modal-body">
                    </div>
                    <div class="modal-footer">
                        <button type="button" id="cancel-overwrite" class="btn btn-secondary ms-auto" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" id="confirm-overwrite" class="btn btn-danger me-auto" data-bs-dismiss="modal">Overwrite</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Api-target set rule modal -->
        <div class="modal fade" id="api-rule-modal" tabindex="-1">
            <div class="modal-dialog modal-dialog-centered" style="max-width:750px">
                <div class="modal-content">
                    <div class="modal-header justify-content-between">
                        <button type="button" class="btn-close" style="visibility:hidden;"></button>
                        <h5 class="modal-title">Api Target Rule</h5>
                        <button id="api-modal-close" type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body d-flex flex-column">

                        <button class="btn btn-sm btn-secondary mx-auto mb-3" type="button" data-bs-toggle="collapse" data-bs-target="#api-rule-modal-help" aria-expanded="false" aria-controls="api-rule-modal-help">
                            Help
                        </button>

                        <div class="collapse" id="api-rule-modal-help">
                            <p class="text-center">Just like other devices, ApiTargets can be turned on/off by sensors or manually. Instead of effecting a physical device they fire API commands.</p>

                            <p class="text-center">Commands are sent to the target node, which can be changed by closing this popup and selecting an option in the "Target Node" dropdown.</p>

                            <p class="text-center">The dropdowns below contain all available options for the current target node. Select a command to fire when this device is turned on, and another for when it is turned off.</p>

                            <p class="text-center">
                                <button class="btn btn-sm btn-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#api-rule-modal-examples" aria-expanded="false" aria-controls="api-rule-modal-examples">
                                    Examples
                                </button>
                            </p>

                            <div class="collapse" id="api-rule-modal-examples">
                                <ul>
                                    <li>Two nodes with motion sensors can work together to cover a large room. Set Sensor1 to target the lights, then set Sensor2 to activate Sensor1 with the <b>trigger_sensor</b> option.</li>
                                    <li>The thermostat can change when a door is open or closed. Set up a door sensor targeting this ApiTarget, then select the thermostat and <b>set_rule</b> command below.</li>
                                    <li>Any sensor can turn a TV or Air Conditioner on/off by triggering an ApiTarget targeting an <b>Ir Blaster</b>.</li>
                                </ul>

                                <p class="text-center">
                                    <button class="btn btn-sm btn-secondary mb-3" type="button" data-bs-toggle="collapse" data-bs-target="#api-rule-modal-help" aria-expanded="false" aria-controls="api-rule-modal-help">
                                        Close
                                    </button>
                                </p>
                            </div>

                        </div>

                        <form name="api_rule_form" id="api_rule_form">
                            <div id="on-action">
                                <select name="instance-on" id="instance-on" class="form-select mb-3 modal-dropdown api-instance" required>
                                    <option value="" selected="selected">Select target instance</option>
                                </select>

                                <select name="command-on" id="command-on" class="form-select mb-3 modal-dropdown api-command" required>
                                    <option value="" selected="selected">Please select instance first</option>
                                </select>

                                <select name="sub-command-on" id="sub-command-on" class="form-select mb-3 modal-dropdown api-command" style="display:none" required disabled>
                                    <option value="" selected="selected">Please select command first</option>
                                </select>

                                <input name="command-arg-on" id="command-arg-on" class="form-control mb-3 modal-input api-command-arg" style="display:none" disabled>
                            </div>

                            <div id="off-action" style="display:none;">
                                <select name="instance-off" id="instance-off" class="form-select mb-3 modal-dropdown api-instance" required>
                                    <option value="" selected="selected">Select target instance</option>
                                </select>

                                <select name="command-off" id="command-off" class="form-select mb-3 modal-dropdown api-command" required>
                                    <option value="" selected="selected">Please select instance first</option>
                                </select>

                                <select name="sub-command-off" id="sub-command-off" class="form-select mb-3 modal-dropdown api-command" style="display:none" required disabled>
                                    <option value="" selected="selected">Please select command first</option>
                                </select>

                                <input name="command-arg-off" id="command-arg-off" class="form-control mb-3 modal-input api-command-arg" style="display:none" disabled>
                            </div>
                        </form>

                        <div class="btn-group mx-auto" role="group" aria-label="Basic radio toggle button group">
                            <input type="radio" class="btn-check" name="btnradio" id="on-button" autocomplete="off" onclick="switch_page(this)" checked>
                            <label class="btn btn-outline-secondary ms-auto api-subrule" for="on-button">On Action</label>

                            <input type="radio" class="btn-check" name="btnradio" id="off-button" autocomplete="off" onclick="switch_page(this)">
                            <label class="btn btn-outline-secondary me-auto api-subrule" for="off-button">Off Action</label>
                        </div>

                    </div>
                    <div class="modal-footer">
                        <button type="button" id="submit-api-rule" class="btn btn-success mx-auto" data-bs-dismiss="modal" onclick="submit_api_rule(this)">Submit</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Toast notification shown when user sets wifi credentials -->
        <div class="fixed-bottom">
            <div id="set_credentials_toast" class="toast text-center mx-auto mb-3" role="alert" aria-live="assertive" aria-atomic="true" data-bs-autohide="false">
                <div class="toast-body">
                    <div id="toast-text" class="mb-2">Save default wifi credentials?</br>(pre-loaded on all future configs)</div>
                    <button class="btn btn-sm btn-primary me-2" data-bs-dismiss="toast" onclick="set_default_credentials();">Yes</button>
                    <button class="btn btn-sm btn-secondary" data-bs-dismiss="toast">No</button>
                </div>
            </div>
        </div>
    </div>

    {{ api_target_options|json_script:"context" }}
    {{ metadata|json_script:"metadata" }}
    {{ edit_existing|json_script:"edit_existing" }}

    <script>
        // Hide everything except first page
        document.getElementById('page2').style.display = 'none';
        document.getElementById('page3').style.display = 'none';

        // Get object used to populate api-target options from context
        const ApiTargetOptions = JSON.parse(document.getElementById("context").textContent);

        // Get device/sensor metadata object, used to determine input elements for each type
        const metadata = JSON.parse(document.getElementById("metadata").textContent);

        // Get var passed to submit_form function, controls whether config is re-uploaded
        const edit_existing = JSON.parse(document.getElementById("edit_existing").textContent);
        // If editing get original name (prevents rejecting existing name as duplicate)
        if (edit_existing) {
            var orig_name = document.getElementById('friendlyName').value.toLowerCase();
        };

        // Store parameters used to re-upload config after editing
        const target_ip = "{{ config.IP }}";
        const target_filename = "{{ config.FILENAME }}";

        // Track if user made changes (triggers warning before going back to overview)
        let changes_made = false;
        document.addEventListener('input', function() {
            changes_made = true;
        }, { once: true });

        // Create modal objects
        const uploadModal = new bootstrap.Modal(document.getElementById('upload-modal'));
        const errorModal = new bootstrap.Modal(document.getElementById('error-modal'));
        const duplicateModal = new bootstrap.Modal(document.getElementById('duplicate-modal'));
        const ruleModal = new bootstrap.Modal(document.getElementById('schedule-rule-modal'));

        // Prevent all keys except digits in floor input, 3 character max
        document.getElementById('floor').addEventListener('input', function(event) {
            event.target.value = event.target.value.replace(/[^\d]/g, '').substring(0,3);
        });

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        };

        // Submit
        document.getElementById("submit-button").addEventListener("click", function(e) {
            e.preventDefault();

            // Disable submit button, prevent submitting multiple times
            document.getElementById("submit-button").disabled = true;

            // Create config from form contents
            submit_form(edit_existing);
        });

        // Initialize toast shown when user changes wifi credentials
        const set_credentials_toast = new bootstrap.Toast(document.getElementById("set_credentials_toast"));

        // Called when values in wifi SSID/password fields change
        function open_toast() {
            const ssid = document.getElementById("ssid").value;
            const pass = document.getElementById("password").value;

            // Only open if both fields are filled
            if (ssid && pass) {
                set_credentials_toast.show();
            } else {
                set_credentials_toast.hide();
            };
        };

        // Handler for default wifi toast yes button
        function set_default_credentials() {
            const ssid = document.getElementById("ssid").value;
            const pass = document.getElementById("password").value;
            send_post_request("set_default_credentials", {"ssid": ssid, "password": pass});
        };

        // Listen for system theme changes, switch to dark/light mode to reflect (responsive)
        window.matchMedia('(prefers-color-scheme: dark)').addListener(function (e) {
            if (e.matches) { // Returns True for dark mode, False otherwise
                document.body.classList.add("dark");
                document.body.classList.remove("light");

                // Modal close buttons
                document.querySelectorAll('.btn-close').forEach(button => button.classList.add("btn-close-white"));
            } else {
                document.body.classList.remove("dark");
                document.body.classList.add("light");

                // Modal close buttons
                document.querySelectorAll('.btn-close').forEach(button => button.classList.remove("btn-close-white"));
            };
        });

        // Set modal close button color (runs once on load)
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.querySelectorAll('.btn-close').forEach(button => button.classList.add("btn-close-white"));
        };
    </script>
    <script src="{% static 'node_configuration/validate.js' %}"></script>
    <script src="{% static 'node_configuration/rule_sliders.js' %}"></script>
    <script src="{% static 'node_configuration/apiTargetOptions.js' %}"></script>
    <script src="{% static 'node_configuration/submit.js' %}"></script>
    <script src="{% static 'node_configuration/upload.js' %}"></script>
    <script src="{% static 'node_configuration/add-instance.js' %}"></script>
    <script src="{% static 'node_configuration/page-buttons.js' %}"></script>
    <script src="{% static 'node_configuration/schedule-rules.js' %}"></script>
    <script src="{% static 'api/schedule_rule_modal.js' %}"></script>
</body>
</html>
