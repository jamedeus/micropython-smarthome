{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
    {% if context.config|length == 2 %}
    <title>Create new config file</title>
    {% else %}
    <title>{{ context.config.TITLE }}</title>
    {% endif %}
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="{% static 'node_configuration/bootstrap.min.css' %}">
    <link rel="stylesheet" href="{% static 'node_configuration/bootstrap-icons.css' %}">
    <link rel="stylesheet" href="{% static 'node_configuration/style.css' %}">
    <link rel="stylesheet" href="{% static 'api/sliders.css' %}">
    <script src="{% static 'node_configuration/bootstrap.min.js' %}"></script>
    <script src="{% static 'node_configuration/jquery.min.js' %}"></script>
    <script src="{% static 'api/rangeslider.min.js' %}"></script>
    <script src="{% static 'node_configuration/smoothscroll.min.js' %}"></script>
    <script src="{% static 'node_configuration/classes.js' %}"></script>
    <style>
        /* Set table column to minimum width with class */
        td {
            width: auto;
        }

        td.min {
            width: 1%;
            white-space: nowrap;
        }
        /* ----- */

        /* Upload complete checkmark animation */
        .light {
            --success: #198754;
        }

        .dark {
            --success: #177a4c;
        }

        .checkmark__circle {
            stroke-dasharray: 166;
            stroke-dashoffset: 166;
            stroke-width: 2;
            stroke-miterlimit: 10;
            stroke: var(--success);
            fill: none;
            animation: stroke 0.6s cubic-bezier(0.65, 0, 0.45, 1) forwards;
        }

        .checkmark {
            width: 3rem;
            height: 3rem;
            border-radius: 50%;
            display: block;
            stroke-width: 2;
            stroke: #fff;
            stroke-miterlimit: 10;
            box-shadow: inset 0px 0px 0px var(--success);
            animation: fill .4s ease-in-out .4s forwards, scale .3s ease-in-out .9s both;
        }

        .checkmark__check {
            transform-origin: 50% 50%;
            stroke-dasharray: 48;
            stroke-dashoffset: 48;
            animation: stroke 0.3s cubic-bezier(0.65, 0, 0.45, 1) 0.8s forwards;
        }

        @keyframes stroke {
            100% {
                stroke-dashoffset: 0;
            }
        }

        @keyframes scale {
            0%, 100% {
                transform: none;
            }
            50% {
                transform: scale3d(1.1, 1.1, 1);
            }
        }

        @keyframes fill {
            100% {
                box-shadow: inset 0px 0px 0px 30px var(--success);
            }
        }
        /* ----- */

        /* Limit width for readability on large screen sizes */
        @media (min-width: 1200px) {
            .container {
                width: 960px;
            }
        }
        /* ----- */

        body.dark .modal-dropdown {
            background-color: #1b1e1f !important;
        }

        /* Force equal width for schedule rule fields */
        td {
            width: 50%;
        }

        /* Delete card animation */
        :root {
            --animation-height: 25rem;
        }

        @keyframes slide-up {
            0% {
                bottom: 0rem;
            }
            100% {
                bottom: var(--animation-height);
            }
        }

        .slide-up {
            animation-name: slide-up;
            animation-duration: 0.8s;
            animation-timing-function: ease;
            animation-fill-mode: forwards;
        }


        @keyframes fade-out {
            0% {
                opacity: 100%;
            }
            100% {
                opacity: 0%;
            }
        }

        .fade-out {
            animation-name: fade-out;
            animation-duration: 0.4s;
            animation-timing-function: ease;
            animation-fill-mode: forwards;
        }

        .fade-in {
            animation-name: fade-out;
            animation-direction: reverse;
            animation-duration: 0.4s;
            animation-timing-function: ease;
            animation-fill-mode: forwards;
        }
    </style>
</head>

<body>
    <script>
        // Check if user is in dark mode, change theme (runs once on page load)
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.body.classList.add("dark");
            console.log("Dark mode");
        } else {
            document.body.classList.add("light");
        };
    </script>

    <div class="container d-flex flex-column vh-100">
        <h1 class="text-center pt-3 pb-4">{{ context.config.TITLE }}</h1>

        {% if context %}

            <div id="page1" class="d-flex flex-column h-100">

                <form id="form" onkeydown="return event.key != 'Enter';">

                    <div  class="mb-4">
                        <h2>Metadata</h2>

                        <div class="mb-2">
                            <label for="friendlyName"><b>Name:</b></label>
                            <input type="text" class="form-control" id="friendlyName" placeholder="" name="friendlyName" value="{{context.config.NAME}}" required>
                        </div>

                        <div class="mb-2">
                            <label for="location"><b>Location:</b></label>
                            <input type="text" class="form-control" id="location" placeholder="" name="location" value="{{context.config.metadata.location}}" required>
                        </div>

                        <div class="mb-2">
                            <label for="floor"><b>Floor:</b></label>
                            <input type="text" class="form-control" id="floor" placeholder="" name="floor" value="{{context.config.metadata.floor}}" required>
                        </div>
                    </div>

                    <div class="mb-4">
                        <h2>Wifi</h2>

                        <div class="mb-2">
                            <label for="ssid"><b>SSID:</b></label>
                            <input type="text" class="form-control" id="ssid" placeholder="" name="ssid" value="{{context.config.wifi.ssid}}" onchange="open_toast()" required>
                        </div>

                        <div class="mb-2">
                            <label for="password"><b>Password:</b></label>
                            <input type="password" class="form-control" id="password" placeholder="" name="password" value="{{context.config.wifi.password}}" onchange="open_toast()" required>
                        </div>
                    </div>

                </form>

                <div class="row">
                    <div id="sensors" class="col-sm">
                        <h2 class="text-center">Add Sensors</h2>

                        {% for sensor, params in context.config.sensors.items %}

                            {% if forloop.first %}
                                <div id="addSensorDiv1" class="sensor{{forloop.counter}}">
                            {% else %}
                                <div id="addSensorDiv{{ forloop.counter }}" class="mt-5 sensor{{forloop.counter}}">
                            {% endif %}
                                <div class="card">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between">
                                            <button class="btn ps-2" style="visibility:hidden;"><i class="bi-x-lg"></i></button>
                                            <h4 class="card-title mx-auto my-auto sensor{{forloop.counter}}">sensor{{ forloop.counter }}</h4>
                                            <button class="btn my-auto pe-2 sensor{{forloop.counter}} delete" id="sensor{{ forloop.counter }}-remove" onclick="remove_instance(this)"><i class="bi-x-lg"></i></button>
                                        </div>

                                        <label for="sensorType{{ forloop.counter }}" class="form-label sensor{{forloop.counter}}"><b>Type:</b></label>
                                        <div>
                                            <select onchange="load_sensor_section(this)" id="sensorType{{ forloop.counter }}" class="form-select sensorType sensor{{forloop.counter}}" autocomplete="off" required>
                                            <option value="clear" disabled>Select sensor type</option>
                                            <option value="pir" {% if params.type == "pir" %} selected {% endif %}>Motion Sensor</option>
                                            <option value="switch" {% if params.type == "switch" %} selected {% endif %}>Switch</option>
                                            <option value="dummy" {% if params.type == "dummy" %} selected {% endif %}>Dummy</option>
                                            <option value="desktop" {% if params.type == "desktop" %} selected {% endif %}>Desktop</option>
                                            <option value="si7021" {% if params.type == "si7021" %} selected {% endif %}>Thermostat</option>
                                            </select>
                                        </div>

                                        <div id="addSensorOptions{{ forloop.counter }}" class="card-body sensor{{forloop.counter}}">
                                            <div class="mb-2">
                                                <label for="sensor{{forloop.counter}}-nickname" class="sensor{{forloop.counter}}"><b>Nickname:</b></label>
                                                <input type="text" class="form-control sensor{{forloop.counter}} nickname" id="sensor{{forloop.counter}}-nickname" placeholder="" value="{{params.nickname}}" onchange="update_nickname(this)" required>
                                            </div>

                                        {% if params.type == "pir" %}

                                                <div class="mb-2">
                                                    <label for="sensor{{forloop.counter}}-pin" class="sensor{{forloop.counter}}"><b>Pin:</b></label>
                                                    <input type="text" class="form-control sensor{{forloop.counter}}" id="sensor{{forloop.counter}}-pin" placeholder="" value="{{params.pin}}" required>
                                                </div>

                                                <div class="mb-2">
                                                    <label for="sensor{{forloop.counter}}-default_rule" class="mt-1 sensor{{forloop.counter}}"><b>Default Rule:</b></label>
                                                    <div class="d-flex flex-row align-items-center my-2">
                                                        <button id="{{sensor}}-default_rule-down" class="btn btn-sm me-1" onclick="rule_slider_increment(this);" data-stepsize="0.5"><i class="bi-dash-lg"></i></button>
                                                        <input id="sensor{{forloop.counter}}-default_rule" type="range" class="sensor{{forloop.counter}} mx-auto" min="0" max="60" data-displaymin="0" data-displaymax="60" data-displaytype="float" step="0.5" value="{{params.default_rule}}" autocomplete="off">
                                                        <button id="{{sensor}}-default_rule-up" class="btn btn-sm ms-1" onclick="rule_slider_increment(this);" data-stepsize="0.5"><i class="bi-plus-lg"></i></button>
                                                    </div>
                                                </div>

                                        {% elif params.type == "switch" %}

                                                <div class="mb-2">
                                                    <label for="sensor{{forloop.counter}}-pin" class="sensor{{forloop.counter}}"><b>Pin:</b></label>
                                                    <input type="text" class="form-control sensor{{forloop.counter}}" id="sensor{{forloop.counter}}-pin" placeholder="" value="{{params.pin}}" required>
                                                </div>

                                                <div class="mb-2">
                                                    <label for="sensor{{forloop.counter}}-default_rule" class="sensor{{forloop.counter}}"><b>Default Rule:</b></label>
                                                    <select id="sensor{{forloop.counter}}-default_rule" class="form-select sensor{{forloop.counter}}" autocomplete="off" required>
                                                        <option disabled>Select default rule</option>
                                                        <option value="enabled" {% if params.default_rule|lower == "enabled" %} selected {% endif %}>Enabled</option>
                                                        <option value="disabled" {% if params.default_rule|lower == "disabled" %} selected {% endif %}>Disabled</option>
                                                    </select>
                                                </div>

                                        {% elif params.type == "dummy" %}

                                                <div class="mb-2">
                                                    <label for="sensor{{forloop.counter}}-default_rule" class="sensor{{forloop.counter}}"><b>Default Rule:</b></label>
                                                    <select id="sensor{{forloop.counter}}-default_rule" class="form-select sensor{{forloop.counter}}" autocomplete="off" required>
                                                        <option disabled>Select default rule</option>
                                                        <option value="on" {% if params.default_rule|lower == "on" %} selected {% endif %}>On</option>
                                                        <option value="off" {% if params.default_rule|lower == "off" %} selected {% endif %}>Off</option>
                                                    </select>
                                                </div>

                                        {% elif params.type == "desktop" %}

                                                <div class="mb-2">
                                                    <label for="sensor{{forloop.counter}}-ip" class="sensor{{forloop.counter}}"><b>IP:</b></label>
                                                    <input type="text" class="form-control sensor{{forloop.counter}}" id="sensor{{forloop.counter}}-ip" placeholder="" value="{{params.ip}}" required>
                                                </div>

                                                <div class="mb-2">
                                                    <label for="sensor{{forloop.counter}}-default_rule" class="sensor{{forloop.counter}}"><b>Default Rule:</b></label>
                                                    <select id="sensor{{forloop.counter}}-default_rule" class="form-select sensor{{forloop.counter}}" autocomplete="off" required>
                                                        <option disabled>Select default rule</option>
                                                        <option value="enabled" {% if params.default_rule|lower == "enabled" %} selected {% endif %}>Enabled</option>
                                                        <option value="disabled" {% if params.default_rule|lower == "disabled" %} selected {% endif %}>Disabled</option>
                                                    </select>
                                                </div>

                                        {% elif params.type == "si7021" %}

                                                <div class="mb-2">
                                                    <label for="sensor{{forloop.counter}}-default_rule" class="mt-1 sensor{{forloop.counter}}"><b>Default Rule:</b></label>
                                                    <div class="d-flex flex-row align-items-center my-2">
                                                        <button id="{{sensor}}-default_rule-down" class="btn btn-sm me-1" onclick="rule_slider_increment(this);" data-stepsize="0.5"><i class="bi-dash-lg"></i></button>
                                                        <input id="sensor{{forloop.counter}}-default_rule" type="range" class="sensor{{forloop.counter}} mx-auto" min="65" max="80" data-displaymin="65" data-displaymax="80" data-displaytype="float" step="0.5" value="{{params.default_rule}}" autocomplete="off">
                                                        <button id="{{sensor}}-default_rule-up" class="btn btn-sm ms-1" onclick="rule_slider_increment(this);" data-stepsize="0.5"><i class="bi-plus-lg"></i></button>
                                                    </div>
                                                </div>

                                                <div class="mb-2">
                                                    <label class="form-label sensor{{forloop.counter}}" for="sensor{{forloop.counter}}-mode"><b>Mode:</b></label>
                                                    <select id="sensor{{forloop.counter}}-mode" class="form-select mb-3 sensor{{forloop.counter}}" required>
                                                        {% if params.mode == "cool" %}
                                                            <option value="cool" id="cool" selected>Cool</option>
                                                            <option value="heat" id="heat">Heat</option>
                                                        {% elif params.mode == "heat" %}
                                                            <option value="cool" id="cool">Cool</option>
                                                            <option value="heat" id="heat" selected>Heat</option>
                                                        {% else %}
                                                            <option value="cool" id="cool">Cool</option>
                                                            <option value="heat" id="heat">Heat</option>
                                                        {% endif %}
                                                    </select>
                                                </div>

                                                <div class="mb-2">
                                                    <label for="sensor{{forloop.counter}}-tolerance" class="sensor{{forloop.counter}}"><b>Tolerance:</b></label>
                                                    <input type="text" class="form-control sensor{{forloop.counter}}" id="sensor{{forloop.counter}}-tolerance" placeholder="" value="{{params.tolerance}}" required>
                                                </div>

                                        {% endif %}
                                        </div>
                                    </div>
                                </div>

                                {% if forloop.last %}
                                    <div class="text-center position-relative">
                                        <button onclick="load_next_sensor(this)" type="button" id="addSensorButton{{ forloop.counter }}" class="btn-secondary btn my-3 sensor{{forloop.counter}}">Add another</button>
                                    </div>
                                {% else %}
                                    <div class="text-center position-relative">
                                        <button onclick="load_next_sensor(this)" type="button" id="addSensorButton{{ forloop.counter }}" class="btn-secondary btn my-3 sensor{{forloop.counter}}" style="display:none">Add another</button>
                                    </div>
                                {% endif  %}

                            </div>
                        {% endfor %}

                        {% if context.config.sensors|length == 0 %}
                            <div class="text-center">
                                <button onclick="load_next_sensor(this)" type="button" id="addSensorButton0" class="btn-secondary btn my-3">Add</button>
                            </div>
                        {% endif %}
                    </div>

                    <div id="devices" class="col-sm">
                        <h2 class="text-center">Add Devices</h2>

                        {% for device, params in context.config.devices.items %}

                            {% if forloop.first %}
                                <div id="addDeviceDiv1" class="device1">
                            {% else %}
                                <div id="addDeviceDiv{{ forloop.counter }}" class="device{{forloop.counter}} mt-5">
                            {% endif %}
                                <div class="card">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between">
                                            <button class="btn ps-2" style="visibility:hidden;"><i class="bi-x-lg"></i></button>
                                            <h4 class="card-title mx-auto my-auto device{{forloop.counter}}">device{{ forloop.counter }}</h4>
                                            <button class="btn my-auto pe-2 device{{forloop.counter}} delete" id="device{{ forloop.counter }}-remove" onclick="remove_instance(this)"><i class="bi-x-lg"></i></button>
                                        </div>

                                        <label for="deviceType{{ forloop.counter }}" class="form-label device{{forloop.counter}}"><b>Type:</b></label>
                                        <div>
                                            <select onchange="load_device_section(this)" id="deviceType{{ forloop.counter }}" class="form-select deviceType device{{forloop.counter}}" autocomplete="off" required>
                                            <option value="clear" disabled>Select device type</option>
                                            <option value="dimmer" {% if params.type == "dimmer" %} selected {% endif %}>TP-Link Dimmer</option>
                                            <option value="bulb" {% if params.type == "bulb" %} selected {% endif %}>TP-Link Bulb</option>
                                            <option value="relay" {% if params.type == "relay" %} selected {% endif %}>Smart Relay</option>
                                            <option value="dumb-relay" {% if params.type == "dumb-relay" %} selected {% endif %}>Relay</option>
                                            <option value="desktop" {% if params.type == "desktop" %} selected {% endif %}>Desktop</option>
                                            <option value="pwm" {% if params.type == "pwm" %} selected {% endif %}>LED Strip</option>
                                            <option value="mosfet" {% if params.type == "mosfet" %} selected {% endif %}>Mosfet</option>
                                            <option value="api-target" {% if params.type == "api-target" %} selected {% endif %}>Api Command</option>
                                            <option value="ir-blaster">IR Blaster</option>
                                            </select>
                                        </div>

                                        <div id="addDeviceOptions{{ forloop.counter }}" class="card-body device{{forloop.counter}}">
                                            <div class="mb-2">
                                                <label for="device{{forloop.counter}}-nickname" class="device{{forloop.counter}}"><b>Nickname:</b></label>
                                                <input type="text" class="form-control device{{forloop.counter}} nickname" id="device{{forloop.counter}}-nickname" placeholder="" value="{{params.nickname}}" onchange="update_nickname(this)" required>
                                            </div>

                                        {% if params.type == "dimmer" or params.type == "bulb"%}
                                                <div class="mb-2">
                                                    <label for="device{{ forloop.counter }}-ip" class="device{{forloop.counter}}"><b>IP:</b></label>
                                                    <input type="text" class="form-control device{{forloop.counter}}" id="device{{ forloop.counter }}-ip" placeholder="" value="{{params.ip}}" required>
                                                </div>

                                                <div class="mb-2">
                                                    <label for="device{{forloop.counter}}-default_rule" class="mt-1 device{{forloop.counter}}"><b>Default Rule:</b></label>
                                                    <div class="d-flex flex-row align-items-center my-2">
                                                        <button id="{{device}}-default_rule-down" class="btn btn-sm me-1" onclick="rule_slider_increment(this);" data-stepsize="1"><i class="bi-dash-lg"></i></button>
                                                        <input id="device{{forloop.counter}}-default_rule" type="range" class="device{{forloop.counter}} mx-auto" min="1" max="100" data-displaymin="1" data-displaymax="100" data-displaytype="int" step="0.5" value="{{params.default_rule}}" autocomplete="off">
                                                        <button id="{{device}}-default_rule-up" class="btn btn-sm ms-1" onclick="rule_slider_increment(this);" data-stepsize="1"><i class="bi-plus-lg"></i></button>
                                                    </div>
                                                </div>

                                        {% elif params.type == "relay" %}
                                                <div class="mb-2">
                                                    <label for="device{{ forloop.counter }}-ip" class="device{{forloop.counter}}"><b>IP:</b></label>
                                                    <input type="text" class="form-control device{{forloop.counter}}" id="device{{ forloop.counter }}-ip" placeholder="" value="{{params.ip}}" required>
                                                </div>

                                                <div class="mb-2">
                                                    <label for="device{{ forloop.counter }}-default_rule" class="device{{forloop.counter}}"><b>Default Rule:</b></label>
                                                    <select id="device{{ forloop.counter }}-default_rule" class="form-select device{{forloop.counter}}" autocomplete="off" required>
                                                        <option disabled>Select default rule</option>
                                                        <option value="enabled" {% if params.default_rule|lower == "enabled" %} selected {% endif %}>Enabled</option>
                                                        <option value="disabled" {% if params.default_rule|lower == "disabled" %} selected {% endif %}>Disabled</option>
                                                    </select>
                                                </div>

                                        {% elif params.type == "dumb-relay" %}
                                                <div class="mb-2">
                                                    <label for="device{{ forloop.counter }}-pin" class="device{{forloop.counter}}"><b>Pin:</b></label>
                                                    <input type="text" class="form-control device{{forloop.counter}}" id="device{{ forloop.counter }}-pin" placeholder="" value="{{params.pin}}" required>
                                                </div>

                                                <div class="mb-2">
                                                    <label for="device{{ forloop.counter }}-default_rule" class="device{{forloop.counter}}"><b>Default Rule:</b></label>
                                                    <select id="device{{ forloop.counter }}-default_rule" class="form-select device{{forloop.counter}}" autocomplete="off" required>
                                                        <option disabled>Select default rule</option>
                                                        <option value="enabled" {% if params.default_rule|lower == "enabled" %} selected {% endif %}>Enabled</option>
                                                        <option value="disabled" {% if params.default_rule|lower == "disabled" %} selected {% endif %}>Disabled</option>
                                                    </select>
                                                </div>

                                        {% elif params.type == "desktop" %}
                                                <div class="mb-2">
                                                    <label for="device{{ forloop.counter }}-ip" class="device{{forloop.counter}}"><b>IP:</b></label>
                                                    <input type="text" class="form-control device{{forloop.counter}}" id="device{{ forloop.counter }}-ip" placeholder="" value="{{params.ip}}" required>
                                                </div>

                                                <div class="mb-2">
                                                    <label for="device{{ forloop.counter }}-default_rule" class="device{{forloop.counter}}"><b>Default Rule:</b></label>
                                                    <select id="device{{ forloop.counter }}-default_rule" class="form-select device{{forloop.counter}}" autocomplete="off" required>
                                                        <option disabled>Select default rule</option>
                                                        <option value="enabled" {% if params.default_rule|lower == "enabled" %} selected {% endif %}>Enabled</option>
                                                        <option value="disabled" {% if params.default_rule|lower == "disabled" %} selected {% endif %}>Disabled</option>
                                                    </select>
                                                </div>

                                        {% elif params.type == "pwm" %}
                                                <div class="mb-2">
                                                    <label for="device{{ forloop.counter }}-pin" class="device{{forloop.counter}}"><b>Pin:</b></label>
                                                    <input type="text" class="form-control device{{forloop.counter}}" id="device{{ forloop.counter }}-pin" placeholder="" value="{{params.pin}}" required>
                                                </div>

                                                <div class="mb-2">
                                                    <label for="device{{ forloop.counter }}-min" class="device{{forloop.counter}}"><b>Min brightness:</b></label>
                                                    <input type="min" class="form-control device{{forloop.counter}}" id="device{{ forloop.counter }}-min" placeholder="0" value="{{params.min}}" required>
                                                </div>

                                                <div class="mb-2">
                                                    <label for="device{{ forloop.counter }}-max" class="device{{forloop.counter}}"><b>Max brightness:</b></label>
                                                    <input type="text" class="form-control device{{forloop.counter}}" id="device{{ forloop.counter }}-max" placeholder="1023" value="{{params.max}}" required>
                                                </div>

                                                <div class="mb-2">
                                                    <label for="device{{forloop.counter}}-default_rule" class="mt-1 device{{forloop.counter}}"><b>Default Rule:</b></label>
                                                    <div class="d-flex flex-row align-items-center my-2">
                                                        <button id="{{device}}-default_rule-down" class="btn btn-sm me-1" onclick="rule_slider_increment(this);" data-stepsize="10"><i class="bi-dash-lg"></i></button>
                                                        <input id="device{{forloop.counter}}-default_rule" type="range" class="device{{forloop.counter}} mx-auto" min="0" max="1023" data-displaymin="0" data-displaymax="100" data-displaytype="int" step="0.5" value="{{params.default_rule}}" autocomplete="off">
                                                        <button id="{{device}}-default_rule-up" class="btn btn-sm ms-1" onclick="rule_slider_increment(this);" data-stepsize="10"><i class="bi-plus-lg"></i></button>
                                                    </div>
                                                </div>

                                        {% elif params.type == "mosfet" %}
                                                <div class="mb-2">
                                                    <label for="device{{ forloop.counter }}-pin" class="device{{forloop.counter}}"><b>Pin:</b></label>
                                                    <input type="text" class="form-control device{{forloop.counter}}" id="device{{ forloop.counter }}-pin" placeholder="" value="{{params.pin}}" required>
                                                </div>

                                                <div class="mb-2">
                                                    <label for="device{{ forloop.counter }}-default_rule" class="device{{forloop.counter}}"><b>Default Rule:</b></label>
                                                    <select id="device{{ forloop.counter }}-default_rule" class="form-select device{{forloop.counter}}" autocomplete="off" required>
                                                        <option disabled>Select default rule</option>
                                                        <option value="enabled" {% if params.default_rule|lower == "enabled" %} selected {% endif %}>Enabled</option>
                                                        <option value="disabled" {% if params.default_rule|lower == "disabled" %} selected {% endif %}>Disabled</option>
                                                    </select>
                                                </div>

                                        {% elif params.type == "api-target" %}
                                                <div class="mb-2">
                                                    <label for="device{{ forloop.counter }}-ip" class="device{{forloop.counter}}"><b>Target Node:</b></label>
                                                    <select id="device{{ forloop.counter }}-ip" class="form-select mb-3 device{{forloop.counter}}" onchange="api_target_selected(this)">
                                                        <option value="" selected="selected"></option>
                                                        {% for node, ip in context.api_target_options.addresses.items %}
                                                            <option value="{{ip}}" {% if params.ip == ip %}selected{% endif %}>{{node}}</option>
                                                        {% endfor %}
                                                    </select>
                                                </div>

                                                <div class="mb-2 text-center">
                                                    <button id="device{{ forloop.counter }}-default_rule-button" class="btn btn-secondary mt-3 device{{forloop.counter}}" onclick="open_rule_modal(this);" type="button">Set rule</button>
                                                </div>

                                                <div class="mb-2 text-center">
                                                    <label for="device{{ forloop.counter }}-default_rule" class="device{{forloop.counter}}" style="display:none;"><b>Default Rule:</b></label>
                                                    <input type="default_rule" class="form-control device{{forloop.counter}}" id="device{{ forloop.counter }}-default_rule" placeholder="" style="display:none;" value="{{params.default_rule}}" required>
                                                </div>

                                        {% endif %}
                                        </div>
                                    </div>
                                </div>

                                {% if forloop.last and not context.config.ir_blaster %}
                                    <div class="text-center position-relative">
                                        <button onclick="load_next_device(this)" type="button" id="addDeviceButton{{ forloop.counter }}" class="btn-secondary btn my-3 device{{forloop.counter}}">Add another</button>
                                    </div>
                                {% else %}
                                    <div class="text-center position-relative">
                                        <button onclick="load_next_device(this)" type="button" id="addDeviceButton{{ forloop.counter }}" class="btn-secondary btn my-3 device{{forloop.counter}}" style="display:none">Add another</button>
                                    </div>
                                {% endif  %}
                            </div>

                        {% endfor %}

                        {% if context.config.ir_blaster %}

                            <div id="addDeviceDiv{{ context.config.devices|length|add:1 }}" class="device{{context.config.devices|length|add:1}} {% if context.config.devices|length %}mt-5{% endif %}">
                                <div class="card">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between">
                                            <button class="btn ps-2" style="visibility:hidden;"><i class="bi-x-lg"></i></button>
                                            <h4 class="card-title mx-auto my-auto device{{context.config.devices|length|add:1}}">device{{ context.config.devices|length|add:1 }}</h4>
                                            <button class="btn my-auto pe-2 device{{context.config.devices|length|add:1}} delete" id="device{{ context.config.devices|length|add:1 }}-remove" onclick="remove_instance(this)"><i class="bi-x-lg"></i></button>
                                        </div>
                                        <label for="deviceType{{ context.config.devices|length|add:1 }}" class="form-label device{{context.config.devices|length|add:1}}"><b>Type:</b></label>
                                        <div>
                                            <select onchange="load_device_section(this)" id="deviceType{{ context.config.devices|length|add:1 }}" class="form-select deviceType device{{context.config.devices|length|add:1}}" required>
                                            <option value="clear">Select device type</option>
                                            <option value="dimmer">TP-Link Dimmer</option>
                                            <option value="bulb">TP-Link Bulb</option>
                                            <option value="relay">Smart Relay</option>
                                            <option value="dumb-relay">Relay</option>
                                            <option value="desktop">Desktop</option>
                                            <option value="pwm">LED Strip</option>
                                            <option value="mosfet">Mosfet</option>
                                            <option value="api-target">Api Command</option>
                                            <option value="ir-blaster" selected>IR Blaster</option>
                                            </select>
                                        </div>

                                        <div id="addDeviceOptions{{ context.config.devices|length|add:1 }}" class="card-body device{{context.config.devices|length|add:1}}">
                                            <div class="mb-2">
                                                <label for="device{{ context.config.devices|length|add:1 }}-pin" class="device{{context.config.devices|length|add:1}}"><b>Pin:</b></label>
                                                <input type="text" class="form-control device{{context.config.devices|length|add:1}}" id="device{{ context.config.devices|length|add:1 }}-pin" value="{{ context.config.ir_blaster.pin }}" required>
                                            </div>

                                            <div class="mb-2">
                                                <label for="device{{ context.config.devices|length|add:1 }}-remotes" class="device{{context.config.devices|length|add:1}}"><b>Virtual remotes:</b></label>
                                                <div id="device{{ context.config.devices|length|add:1 }}-remotes" class="form-check device{{context.config.devices|length|add:1}}">
                                                    <input class="form-check-input ir-target" type="checkbox" value="irblaster-tv" id="checkbox-tv" {% if "tv" in context.config.ir_blaster.target %}checked{% endif %}>
                                                    <label class="form-check-label" for="checkbox-tv">TV (Samsung)</label></br>
                                                    <input class="form-check-input ir-target" type="checkbox" value="irblaster-ac" id="checkbox-ac" {% if "ac" in context.config.ir_blaster.target %}checked{% endif %}>
                                                    <label class="form-check-label" for="checkbox-ac">AC (Whynter)</label>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="text-center position-relative">
                                    <button onclick="load_next_device(this)" type="button" id="addDeviceButton{{ context.config.devices|length|add:1 }}" class="btn-secondary btn my-3 device{{context.config.devices|length|add:1}}">Add another</button>
                                </div>
                            </div>

                        {% endif %}

                        {% if context.config.devices|length == 0 %}
                            <div class="text-center">
                                <button onclick="load_next_device(this)" type="button" id="addDeviceButton0" class="btn-secondary btn my-3">Add</button>
                            </div>
                        {% endif %}

                    </div>
                </div>

                <div class="d-flex justify-content-between mx-3 mt-auto">
                    <button id="page1-back-button" type="button" class="btn btn-secondary mb-3">Back</button>
                    <button type="button" class="btn btn-primary mb-3" style="visibility: hidden;">Submit</button>
                    <button id="page1-button" type="button" class="btn btn-primary mb-3">Next</button>
                </div>
            </div>

            <div id="page2" class="flex-column h-100">
                <div id="page2-cards">
                    <h3>Select targets for each sensor</h3>

                    {% for sensor, params in context.config.sensors.items %}

                        <div class="card mb-4 {{sensor}}">
                            <div class="card-body">
                                <label id="{{sensor}}-targets-label" for="{{sensor}}-targets" class="card-title {{sensor}}"><b>{{ params.nickname }}</b> targets:</label>
                                <div id="{{sensor}}-targets" class="form-check sensor-targets {{sensor}}">

                                    {% for device, dparams in context.config.devices.items %}

                                        <input type="checkbox" class="form-check-input {{sensor}} {{device}} target" id="target-{{sensor}}-{{device}}" value="target-{{sensor}}-{{device}}" {% if device in params.targets %}checked{% endif %}>
                                        <label for="target-{{sensor}}-{{device}}" class="form-check-label {{sensor}} {{device}} target-label">{{ dparams.nickname }}</label>
                                        <br class="{{device}}">

                                    {% endfor %}
                                </div>
                            </div>
                        </div>

                    {% endfor %}
                </div>

                <div class="d-flex justify-content-between mx-3 mt-auto">
                    <button id="page2-back-button" type="button" class="btn btn-primary mb-3">Back</button>
                    <button type="button" class="btn btn-primary mb-3" style="visibility: hidden;">Submit</button>
                    <button id="page2-button" type="button" class="btn btn-primary mb-3">Next</button>
                </div>
            </div>

            <div id="page3" class="flex-column h-100">
                <h3>Add schedule rules (optional)</h3>
                    <div id="page3-cards">
                    {% for instance, params in context.config.instances.items %}

                        <div class="card mb-4 {{instance}}">
                            <div class="card-body text-center">
                                <label id="{{instance}}-rules-label" class="card-title schedule-rule-card {{instance}}" title="{{instance}} - {{params.type}}">
                                    <b>{{ params.nickname }}</b>
                                </label>
                                <table id="{{instance}}-rules" class="table table-borderless {{instance}}">
                                    <tr>
                                        <th style="text-align: center;">Time</th>
                                        <th style="text-align: center;">Rule</th>
                                    </tr>

                                    {% if params.schedule.items|length > 0 %}
                                        {% for time, rule in params.schedule.items %}
                                            <tr id="{{instance}}-row-{{forloop.counter}}" class="{{instance}}">
                                                <td>
                                                    <input type="time" class="form-control timestamp {{instance}}" id="{{instance}}-rule{{forloop.counter}}-time" placeholder="HH:MM" value="{{time}}">
                                                </td>

                                                {% if params.type == "pir" %}
                                                    <td>
                                                        <div class="d-flex flex-row align-items-center my-2">
                                                            <button id="{{instance}}-rule{{forloop.counter}}-down" class="btn btn-sm me-1" onclick="rule_slider_increment(this);" data-stepsize="0.5"><i class="bi-dash-lg"></i></button>
                                                            <input id="{{instance}}-rule{{forloop.counter}}" type="range" class="{{instance}} mx-auto" min="0" max="60" data-displaymin="0" data-displaymax="60" data-displaytype="float" step="0.5" value="{{rule}}" value="{{rule}}" autocomplete="off">
                                                            <button id="{{instance}}-rule{{forloop.counter}}-up" class="btn btn-sm ms-1" onclick="rule_slider_increment(this);" data-stepsize="0.5"><i class="bi-plus-lg"></i></button>
                                                        </div>
                                                    </td>

                                                {% elif params.type == "si7021" %}
                                                    <td>
                                                        <div class="d-flex flex-row align-items-center my-2">
                                                            <button id="{{instance}}-rule{{forloop.counter}}-down" class="btn btn-sm me-1" onclick="rule_slider_increment(this);" data-stepsize="0.5"><i class="bi-dash-lg"></i></button>
                                                            <input id="{{instance}}-rule{{forloop.counter}}" type="range" class="{{instance}} mx-auto" min="65" max="80" data-displaymin="65" data-displaymax="80" data-displaytype="float" step="0.5" value="{{rule}}" value="{{rule}}" autocomplete="off">
                                                            <button id="{{instance}}-rule{{forloop.counter}}-up" class="btn btn-sm ms-1" onclick="rule_slider_increment(this);" data-stepsize="0.5"><i class="bi-plus-lg"></i></button>
                                                        </div>
                                                    </td>

                                                {% elif params.type == "dimmer" or params.type == "bulb" %}
                                                    <td>
                                                        <input type="text" class="form-control rule {{instance}}" id="{{instance}}-rule{{forloop.counter}}" placeholder="" value="{{rule}}">
                                                    </td>

                                                    <!-- TODO find best way to allow both int and fade rule -->
<!--                                                    <td>
                                                        <div class="d-flex flex-row align-items-center my-2">
                                                            <button id="{{instance}}-rule{{forloop.counter}}-down" class="btn btn-sm me-1" onclick="rule_slider_increment(this);" data-stepsize="1"><i class="bi-dash-lg"></i></button>
                                                            <input id="{{instance}}-rule{{forloop.counter}}" type="range" class="{{instance}} mx-auto" min="0" max="60" data-displaymin="0" data-displaymax="60" data-displaytype="int" step="1" value="{{rule}}" value="{{rule}}" autocomplete="off">
                                                            <button id="{{instance}}-rule{{forloop.counter}}-up" class="btn btn-sm ms-1" onclick="rule_slider_increment(this);" data-stepsize="1"><i class="bi-plus-lg"></i></button>
                                                        </div>
                                                    </td>-->

                                                {% elif params.type == "pwm" %}
                                                    <td>
                                                        <input type="text" class="form-control rule {{instance}}" id="{{instance}}-rule{{forloop.counter}}" placeholder="" value="{{rule}}">
                                                    </td>

                                                    <!-- TODO find best way to allow both int and fade rule -->
<!--                                                    <td>
                                                        <div class="d-flex flex-row align-items-center my-2">
                                                            <button id="{{instance}}-rule{{forloop.counter}}-down" class="btn btn-sm me-1" onclick="rule_slider_increment(this);" data-stepsize="10"><i class="bi-dash-lg"></i></button>
                                                            <input id="{{instance}}-rule{{forloop.counter}}" type="range" class="{{instance}} mx-auto" min="0" max="1023" data-displaymin="0" data-displaymax="100" data-displaytype="int" step="1" value="{{rule}}" value="{{rule}}" autocomplete="off">
                                                            <button id="{{instance}}-rule{{forloop.counter}}-up" class="btn btn-sm ms-1" onclick="rule_slider_increment(this);" data-stepsize="10"><i class="bi-plus-lg"></i></button>
                                                        </div>
                                                    </td>-->

                                                {% elif params.type == "dummy" %}
                                                    <td>
                                                        <select id="{{instance}}-rule{{forloop.counter}}" class="form-select rule {{instance}} autocomplete="off">
                                                            <option disabled>Select rule</option>
                                                            <option value='enabled' {% if rule|lower == "enabled" %} selected {% endif %}>Enabled</option>
                                                            <option value='disabled' {% if rule|lower == "disabled" %} selected {% endif %}>Disabled</option>
                                                            <option value='on' {% if rule|lower == "on" %} selected {% endif %}>On</option>
                                                            <option value='off' {% if rule|lower == "off" %} selected {% endif %}>Off</option>
                                                        </select>
                                                    </td>

                                                {% elif params.type == "switch" or params.type == "desktop" or params.type == "relay" or params.type == "dumb-relay" or params.type == "mosfet" %}
                                                    <td>
                                                        <select id="{{instance}}-rule{{forloop.counter}}" class="form-select rule {{instance}} autocomplete="off">
                                                            <option disabled>Select rule</option>
                                                            <option value='enabled' {% if rule|lower == "enabled" %} selected {% endif %}>Enabled</option>
                                                            <option value='disabled' {% if rule|lower == "disabled" %} selected {% endif %}>Disabled</option>
                                                        </select>
                                                    </td>

                                                {% elif params.type == "api-target" %}
                                                    <td>
                                                        <button id="{{instance}}-rule{{forloop.counter}}-button" class="form-control {{instance}}" onclick="open_rule_modal(this);" type="button">Set rule</button>
                                                        <input type="text" class="form-control rule {{instance}}" id="{{instance}}-rule{{forloop.counter}}" value="{{rule}}" style="display:none;">
                                                    </td>
                                                {% endif %}
                                                <td class="min">
                                                    <button type="button" class="remove btn btn-sm btn-danger mt-1 {{instance}}" id="{{instance}}-remove{{forloop.counter}}" onclick="remove(this)"><i class="bi-x-lg"></i></button>
                                                </td>
                                            </tr>
                                        {% endfor %}
                                    {% else %}
                                        <tr id="{{instance}}-row-1" class="{{instance}}">
                                            <td>
                                                <input type="time" class="form-control timestamp {{instance}}" id="{{instance}}-rule1-time" placeholder="HH:MM">
                                            </td>

                                            {% if not params.type == "api-target" %}
                                                <td>
                                                    <input type="text" class="form-control rule {{instance}}" id="{{instance}}-rule1" placeholder="">
                                                </td>
                                            {% else %}
                                                <td>
                                                    {# Show button that opens api rule modal containing dropdowns used to set rule. Selection from modal added to hidden text box, read by form #}
                                                    <button id="{{instance}}-rule1-button" class="form-control {{instance}}" onclick="open_rule_modal(this);" type="button">Set rule</button>
                                                    <input type="text" class="form-control rule {{instance}}" id="{{instance}}-rule1" style="display:none;">
                                                </td>
                                            {% endif %}

                                            <td class="min">
                                                <button type="button" class="remove btn btn-sm btn-danger mt-1 {{instance}}" id="{{instance}}-remove1"  onclick="remove(this)"><i class="bi-x-lg"></i></button>
                                            </td>
                                        </tr>
                                    {% endif %}
                                </table>
                                <button type="button" class="btn btn-secondary {{instance}}" id="{{instance}}-add-rule" onclick="add(this)">Add another</button>
                            </div>
                        </div>

                    {% endfor %}
                    </div>

                <div class="d-flex justify-content-between mx-3 mt-auto">
                    <button id="page3-back-button" type="button" class="btn btn-primary mb-3">Back</button>
                    <button id="submit-button" type="submit" class="btn btn-primary mb-3">Submit</button>
                    <button type="button" class="btn btn-secondary mb-3" disabled>Next</button>
                </div>
            </div>

            <!-- Loading modal displayed while waiting on upload -->

            <div class="modal fade" id="upload-modal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1">
                <div class="modal-dialog modal-dialog-centered" >
                    <div class="modal-content">
                        <div class="modal-header" style="border-bottom: 0px;">
                            <h3 class="mx-auto" id="upload-modal-title">Uploading...</h3>
                        </div>
                        <div class="modal-body d-flex justify-content-center mb-4" id="upload-modal-body">
                            <div class="spinner-border" style="width: 3rem; height: 3rem;" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Error modal displayed when upload fails -->

            <div class="modal fade" id="error-modal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1">
                <div class="modal-dialog modal-dialog-centered" >
                    <div class="modal-content">
                        <div class="modal-header" style="border-bottom: 0px;">
                            <h3 class="mx-auto" id="error-modal-title">Error</h3>
                        </div>
                        <div class="modal-body d-flex justify-content-center" id="error-modal-body">
                        </div>
                        <div class="modal-footer d-flex justify-content-center" id="error-modal-footer">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Overwrite duplicate modal dialog -->

            <div class="modal fade" id="duplicate-modal" tabindex="-1">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content">
                        <div class="modal-body" id="duplicate-modal-body">
                        </div>
                        <div class="modal-footer">
                            <button type="button" id="cancel-overwrite" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="button" id="confirm-overwrite" class="btn btn-danger" data-bs-dismiss="modal">Overwrite</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Api-target set rule modal -->
            <div class="modal fade" id="api-rule-modal" tabindex="-1">
                <div class="modal-dialog modal-dialog-centered" style="max-width:750px">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Api Target Rule</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body d-flex flex-column">

                            <button class="btn btn-sm btn-secondary mx-auto mb-3" type="button" data-bs-toggle="collapse" data-bs-target="#api-rule-modal-help" aria-expanded="false" aria-controls="api-rule-modal-help">
                                Help
                            </button>

                            <div class="collapse" id="api-rule-modal-help">
                                <p class="text-center">Just like other devices, ApiTargets can be turned on/off by sensors or manually. Instead of effecting a physical device they fire API commands.</p>

                                <p class="text-center">Commands are sent to the target node, which can be changed by closing this popup and selecting an option in the "Target Node" dropdown.</p>

                                <p class="text-center">The dropdowns below contain all available options for the current target node. Select a command to fire when this device is turned on, and another for when it is turned off.</p>

                                <p class="text-center">
                                    <button class="btn btn-sm btn-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#api-rule-modal-examples" aria-expanded="false" aria-controls="api-rule-modal-examples">
                                        Examples
                                    </button>
                                </p>

                                <div class="collapse" id="api-rule-modal-examples">
                                    <ul>
                                        <li>Two nodes with motion sensors can work together to cover a large room. Set Sensor1 to target the lights, then set Sensor2 to activate Sensor1 with the <b>trigger_sensor</b> option.</li>
                                        <li>The thermostat can change when a door is open or closed. Set up a door sensor targeting this ApiTarget, then select the thermostat and <b>set_rule</b> command below.</li>
                                        <li>Any sensor can turn a TV or Air Conditioner on/off by triggering an ApiTarget targeting an <b>Ir Blaster</b>.</li>
                                    </ul>

                                    <p class="text-center">
                                        <button class="btn btn-sm btn-secondary mb-3" type="button" data-bs-toggle="collapse" data-bs-target="#api-rule-modal-help" aria-expanded="false" aria-controls="api-rule-modal-help">
                                            Close
                                        </button>
                                    </p>
                                </div>

                            </div>

                            <form name="api_rule_form" id="api_rule_form">
                                <div id="on-action">
                                    <select name="instance-on" id="instance-on" class="form-select mb-3 modal-dropdown api-instance" required>
                                        <option value="" selected="selected">Select target instance</option>
                                    </select>

                                    <select name="command-on" id="command-on" class="form-select mb-3 modal-dropdown api-command" required>
                                        <option value="" selected="selected">Please select instance first</option>
                                    </select>

                                    <select name="sub-command-on" id="sub-command-on" class="form-select mb-3 modal-dropdown api-command" style="display:none" required disabled>
                                        <option value="" selected="selected">Please select command first</option>
                                    </select>

                                    <input name="command-arg-on" id="command-arg-on" class="form-control mb-3 modal-dropdown api-command-arg" style="display:none" disabled>
                                </div>

                                <div id="off-action" style="display:none;">
                                    <select name="instance-off" id="instance-off" class="form-select mb-3 modal-dropdown api-instance" required>
                                        <option value="" selected="selected">Select target instance</option>
                                    </select>

                                    <select name="command-off" id="command-off" class="form-select mb-3 modal-dropdown api-command" required>
                                        <option value="" selected="selected">Please select instance first</option>
                                    </select>

                                    <select name="sub-command-off" id="sub-command-off" class="form-select mb-3 modal-dropdown api-command" style="display:none" required disabled>
                                        <option value="" selected="selected">Please select command first</option>
                                    </select>

                                    <input name="command-arg-off" id="command-arg-off" class="form-control mb-3 modal-dropdown api-command-arg" style="display:none" disabled>
                                </div>
                            </form>

                            <div class="btn-group mx-auto" role="group" aria-label="Basic radio toggle button group">
                                <input type="radio" class="btn-check" name="btnradio" id="on-button" autocomplete="off" onclick="switch_page(this)" checked>
                                <label class="btn btn-outline-secondary ms-auto" for="on-button">On Action</label>

                                <input type="radio" class="btn-check" name="btnradio" id="off-button" autocomplete="off" onclick="switch_page(this)">
                                <label class="btn btn-outline-secondary me-auto" for="off-button">Off Action</label>
                            </div>

                        </div>
                        <div class="modal-footer">
                            <button type="button" id="submit-api-rule" class="btn btn-success mx-auto" data-bs-dismiss="modal" onclick="submit_api_rule(this)">Submit</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Toast notification shown when user sets wifi credentials -->
            <div class="fixed-bottom">
                <div id="set_credentials_toast" class="toast text-center mx-auto mb-3" role="alert" aria-live="assertive" aria-atomic="true" data-bs-autohide="false">
                    <div class="toast-body">
                        <div id="toast-text" class="mb-2">Save default wifi credentials?</br>(pre-loaded on all future configs)</div>
                        <button class="btn btn-sm btn-primary me-2" data-bs-dismiss="toast" onclick="set_default_credentials();">Yes</button>
                        <button class="btn btn-sm btn-secondary" data-bs-dismiss="toast">No</button>
                    </div>
                </div>
            </div>

        {% else %}
            <p>FATAL ERROR</p>
        {% endif %}
    </div>

    {{ context.api_target_options|json_script:"context" }}

    <script>
        $('#page2').hide();
        $('#page3').hide();

        var ApiTargetOptions = JSON.parse(document.getElementById("context").textContent);

        const base_url = window.location.href.split("edit_config")[0];

        // Store parameters used to re-upload config after editing
        const target_ip = "{{ context.config.IP }}"
        const target_filename = "{{ context.config.FILENAME }}"

        // Track if an IrBlaster is configured (cannot have multiple)
        ir_blaster_configured = false;
        for (device of document.getElementsByClassName("deviceType")) {
            if (device.value == "ir-blaster") {
                ir_blaster_configured = true;
            };
        };

        {# Set var passed to submit_form function, controls whether config is re-uploaded or not #}
        {# For new configs length will be 1 if no default password set, otherwise 2. Existing configs have min length of 9 #}
        {% if context.config|length <= 2 %}
        const edit_existing = false;
        {% else %}
        const edit_existing = true;
        {% endif %}

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        // Show the modal with id modal, optionally change title/body/footer
        function show_modal(modal, title=false, body=false, footer=false) {
            if (title) {
                document.getElementById(modal + "-title").innerHTML = title;
            };

            if (body) {
                document.getElementById(modal + "-body").innerHTML = body;
            };

            if (footer) {
                document.getElementById(modal + "-footer").innerHTML = footer;
            };

            $('#' + modal).modal('show');
        };

        document.getElementById("submit-button").addEventListener("click", function(e) {
            e.preventDefault();

            // Disable submit button, prevent submitting multiple times
            document.getElementById("submit-button").disabled = true;

            // Create config from form contents
            submit_form(edit_existing);
        });

        // Initialize toast shown when user changes wifi credentials
        const set_credentials_toast = new bootstrap.Toast(document.getElementById("set_credentials_toast"));

        // Called when values in wifi SSID/password fields change
        function open_toast() {
            const ssid = document.getElementById("ssid").value;
            const pass = document.getElementById("password").value;

            // Only open if both fields are filled
            if (ssid && pass) {
                set_credentials_toast.show();
            } else {
                set_credentials_toast.hide();
            };
        };

        // Handler for default wifi toast yes button
        function set_default_credentials() {
            const ssid = document.getElementById("ssid").value;
            const pass = document.getElementById("password").value;
            send_post_request("set_default_credentials", {"ssid": ssid, "password": pass});
        };

        // Listen for system theme changes, switch to dark/light mode to reflect (responsive)
        window.matchMedia('(prefers-color-scheme: dark)').addListener(function (e) {
            if (e.matches) { // Returns True for dark mode, False otherwise
                document.body.classList.add("dark");
                document.body.classList.remove("light");

                // Buttons in ApiTarget rule modal
                modal = document.getElementById('api-rule-modal');
                Array.from(modal.querySelectorAll('button')).forEach(function(button) {
                    if (button.classList.contains("btn-secondary")) {
                        button.classList.remove("btn-secondary");
                        button.classList.add("btn-dark");
                    };
                });
                Array.from(modal.querySelectorAll('label')).forEach(function(button) {
                    if (button.classList.contains("btn-outline-secondary")) {
                        button.classList.remove("btn-outline-secondary");
                        button.classList.add("btn-outline-dark");
                    };
                });
            } else {
                document.body.classList.remove("dark");
                document.body.classList.add("light");

                // Buttons in ApiTarget rule modal
                modal = document.getElementById('api-rule-modal');
                Array.from(modal.querySelectorAll('button')).forEach(function(button) {
                    if (button.classList.contains("btn-dark")) {
                        button.classList.remove("btn-dark");
                        button.classList.add("btn-secondary");
                    };
                });
                Array.from(modal.querySelectorAll('label')).forEach(function(button) {
                    if (button.classList.contains("btn-outline-dark")   ) {
                        button.classList.remove("btn-outline-dark");
                        button.classList.add("btn-outline-secondary");
                    };
                });
            }
        });
    </script>
    <script src="{% static 'node_configuration/rule_sliders.js' %}"></script>
    <script src="{% static 'node_configuration/apiTargetOptions.js' %}"></script>
    <script src="{% static 'node_configuration/submit.js' %}"></script>
    <script src="{% static 'node_configuration/add-instance.js' %}"></script>
    <script src="{% static 'node_configuration/page-buttons.js' %}"></script>
    <script src="{% static 'node_configuration/schedule-rules.js' %}"></script>

</body>


</html>
