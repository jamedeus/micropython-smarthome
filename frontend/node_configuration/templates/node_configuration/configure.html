{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
    <title>Create new config file</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="{% static 'node_configuration/bootstrap.min.css' %}">
    <link rel="stylesheet" href="{% static 'node_configuration/style.css' %}">
    <script src="{% static 'node_configuration/bootstrap.min.js' %}"></script>
    <script src="{% static 'node_configuration/jquery.min.js' %}"></script>
    <script src="{% static 'node_configuration/smoothscroll.min.js' %}"></script>
    <script>

        function getCookie(name) {
            var cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                var cookies = document.cookie.split(';');
                for (var i = 0; i < cookies.length; i++) {
                    var cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        };

        async function readForm(url) {
            var value = Object.fromEntries(new FormData(document.getElementById("form")).entries());

            console.log({ value });

            let csrftoken = getCookie('csrftoken');

            const result = await fetch(url, {
                method: 'POST',
                body: JSON.stringify(value),
                headers: { 'Accept': 'application/json, text/plain, */*',
                    'Content-Type': 'application/json',
                    "X-CSRFToken": csrftoken }
            });

            return result
        };

    </script>
    <style>
        td {
            width: auto;
        }

        td.min {
            width: 1%;
            white-space: nowrap;
        }

        /* Limit width for readability on large screen sizes */
        @media (min-width: 1200px) {
            .container {
                width: 960px;
            }
        }
    </style>
</head>

<body>
    <script>
        // Check if user is in dark mode, change theme (runs once on page load)
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.body.classList.add("dark");
            console.log("Dark mode");
        };
    </script>

    <div class="container d-flex flex-column vh-100">
        <h1 class="text-center pt-3 pb-4">Create New Config</h1>

        <form id="form" class="h-100" onkeydown="return event.key != 'Enter';">

            <div id="page1" class="d-flex flex-column h-100">

                <div>
                    <h2>Metadata</h2>

                    <div class="mb-2">
                        <label for="friendlyName"><b>Name:</b></label>
                        <input type="text" class="form-control" id="friendlyName" placeholder="" name="friendlyName" required>
                    </div>

                    <div class="mb-2">
                        <label for="location"><b>Location:</b></label>
                        <input type="text" class="form-control" id="location" placeholder="" name="location" required>
                    </div>

                    <div class="mb-2">
                        <label for="floor"><b>Floor:</b></label>
                        <input type="text" class="form-control" id="floor" placeholder="" name="floor" required>
                    </div>
                </div></br>

                <div class="mb-3">
                    <h2>Wifi</h2>

                    <div class="mb-2">
                        <label for="ssid"><b>SSID:</b></label>
                        <input type="text" class="form-control" id="ssid" placeholder="" name="ssid" required>
                    </div>

                    <div class="mb-2">
                        <label for="password"><b>Password:</b></label>
                        <input type="password" class="form-control" id="password" placeholder="" name="password" required>
                    </div>
                </div></br>

                <div class="row">
                    <div class="col-sm">
                        <h2>Add Sensors</h2>

                        <div id="addSensorDiv1">
                            <div class="card">
                                <div class="card-body">
                                    <h4 class="card-title">sensor1</h4>
                                    <label for="sensorType1" class="form-label"><b>Type:</b></label>
                                    <div>
                                        <select onchange="load_sensor_section(this)" name="sensorType1" id="sensorType1" class="form-select sensorType" autocomplete="off" required>
                                        <option value="clear">Select sensor type</option>
                                        <option value="pir">Motion Sensor</option>
                                        <option value="switch">Switch</option>
                                        <option value="dummy">Dummy</option>
                                        <option value="desktop">Desktop</option>
                                        <option value="si7021">Thermostat</option>
                                        </select>
                                    </div>

                                    <div id="addSensorOptions1" class="card-body"></div>
                                </div>
                            </div>

                            <div class="text-center">
                                <button onclick="load_next_sensor(this)" type="button" id="addSensorButton1" class="btn-secondary btn my-3">Add another</button>
                            </div>

                            <div id="addSensorDiv2"></div>
                        </div>

                    </div></br>

                    <div class="col-sm">
                        <h2>Add Devices</h2>

                        <div id="addDeviceDiv1">
                            <div class="card">
                                <div class="card-body">
                                    <h4 class="card-title">device1</h4>
                                    <label for="deviceType1" class="form-label"><b>Type:</b></label>
                                    <div>
                                        <select onchange="load_device_section(this)" name="deviceType1" id="deviceType1" class="form-select deviceType" autocomplete="off" required>
                                        <option value="clear">Select device type</option>
                                        <option value="dimmer">TP-Link Dimmer</option>
                                        <option value="bulb">TP-Link Bulb</option>
                                        <option value="relay">Smart Relay</option>
                                        <option value="dumb-relay">Relay</option>
                                        <option value="desktop">Desktop</option>
                                        <option value="pwm">LED Strip</option>
                                        <option value="mosfet">Mosfet</option>
                                        <option value="api-target">Api Command</option>
                                        <option value="ir-blaster">IR Blaster</option>
                                        </select>
                                    </div>

                                    <div id="addDeviceOptions1" class="card-body"></div>
                                </div>
                            </div>

                            <div class="text-center">
                                <button onclick="load_next_device(this)" type="button" id="addDeviceButton1" class="btn-secondary btn my-3">Add another</button>
                            </div>

                            <div id="addDeviceDiv2"></div>
                        </div>

                    </div></br>
                </div>

                <div class="d-flex justify-content-between mx-3 mt-auto">
                    <button id="page1-back-button" type="button" class="btn btn-secondary mb-3">Back</button>
                    <button type="button" class="btn btn-primary mb-3" style="visibility: hidden;">Submit</button>
                    <button id="page1-button" type="button" class="btn btn-primary mb-3">Next</button>
                </div>
            </div>

            <div id="page2" class="flex-column h-100" style="display:none;">
            </div>

            <div id="page3" class="flex-column h-100" style="display:none;">
            </div>

        </form>

        <!-- Overwrite duplicate modal dialog -->

        <div class="modal fade" id="duplicate-modal" tabindex="-1">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-body" id="duplicate-modal-body">
                    </div>
                    <div class="modal-footer">
                        <button type="button" id="cancel-overwrite" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" id="confirm-overwrite" class="btn btn-danger" data-bs-dismiss="modal">Overwrite</button>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script>
        async function load_sensor_section(select) {
            // Get index of sensor
            const index = parseInt(select.id.replace("sensorType", ""));

            // Get user selection
            const selected = document.getElementById(select.id).value

            // Add nickname section to template, other sections added below as needed
            var template = `<div class="mb-2">
                                <label for="sensor${index}-nickname"><b>Nickname:</b></label>
                                <input type="text" class="form-control" id="sensor${index}-nickname" placeholder="" name="sensor${index}-nickname" required>
                            </div>`

            // Get template for sensor type selected by user
            if (selected == "pir" || selected == "switch") {
                template += `<div class="mb-2">
                                <label for="sensor${index}-pin"><b>Pin:</b></label>
                                <input type="text" class="form-control" id="sensor${index}-pin" placeholder="" name="sensor${index}-pin" required>
                            </div>

                            <div class="mb-2">
                                <label for="sensor${index}-default_rule"><b>Default Rule:</b></label>
                                <input type="default_rule" class="form-control" id="sensor${index}-default_rule" placeholder="" name="sensor${index}-default_rule" required>
                            </div>`

            } else if (selected == "desktop") {
                template += `<div class="mb-2">
                                <label for="sensor${index}-ip"><b>IP:</b></label>
                                <input type="text" class="form-control" id="sensor${index}-ip" placeholder="" name="sensor${index}-ip" required>
                            </div>

                            <div class="mb-2">
                                <label for="sensor${index}-default_rule"><b>Default Rule:</b></label>
                                <input type="text" class="form-control" id="sensor${index}-default_rule" placeholder="" name="sensor${index}-default_rule" required>
                            </div>`

            } else if (selected == "dummy") {
                template += `<div class="mb-2">
                                <label for="sensor${index}-default_rule"><b>Default Rule:</b></label>
                                <input type="default_rule" class="form-control" id="sensor${index}-default_rule" placeholder="" name="sensor${index}-default_rule" required>
                            </div>`
            } else if (selected == "si7021") {
                template += `<div class="mb-2">
                                <label for="sensor${index}-default_rule"><b>Default Rule:</b></label>
                                <input type="default_rule" class="form-control" id="sensor${index}-default_rule" placeholder="" name="sensor${index}-default_rule" required>
                            </div>

                            <div class="mb-2">
                                <label class="form-label" for="sensor${index}-mode"><b>Mode:</b></label>
                                <select name="sensor${index}-mode" id="sensor${index}-mode" class="form-select mb-3" required>
                                    <option value="cool" id="cool">Cool</option>
                                    <option value="heat" id="heat">Heat</option>
                                </select>
                            </div>

                            <div class="mb-2">
                                <label for="sensor${index}-tolerance"><b>Tolerance:</b></label>
                                <input type="text" class="form-control" id="sensor${index}-tolerance" placeholder="" name="sensor${index}-tolerance" required>
                            </div>`
            } else {
                // User selected first option ("Select sensor type"), clear form
                template = "";
            };

            // Render div, scroll down until visible
            document.getElementById("addSensorOptions" + index).innerHTML = template;
            document.getElementById("addSensorOptions" + index).scrollIntoView({behavior: "smooth"});
        };

        async function load_device_section(select) {
            // Get index of device
            const index = parseInt(select.id.replace("deviceType", ""));

            // Get user selection
            const selected = document.getElementById(select.id).value

            // Add nickname section to template, other sections added below as needed
            var template = `<div class="mb-2">
                                <label for="device${index}-nickname"><b>Nickname:</b></label>
                                <input type="text" class="form-control" id="device${index}-nickname" placeholder="" name="device${index}-nickname" required>
                            </div>`

            // Get template for device type selected by user
            if (selected == "dimmer" || selected == "bulb" || selected == "desktop" || selected == "api-target" || selected == "relay") {
                template += `<div class="mb-2">
                                <label for="device${index}-ip"><b>IP:</b></label>
                                <input type="text" class="form-control" id="device${index}-ip" placeholder="" name="device${index}-ip" required>
                            </div>

                            <div class="mb-2">
                                <label for="device${index}-default_rule"><b>Default Rule:</b></label>
                                <input type="default_rule" class="form-control" id="device${index}-default_rule" placeholder="" name="device${index}-default_rule" required>
                            </div>`

            } else if (selected == "mosfet" || selected == "dumb-relay") {
                template += `<div class="mb-2">
                                <label for="device${index}-pin"><b>Pin:</b></label>
                                <input type="text" class="form-control" id="device${index}-pin" placeholder="" name="device${index}-pin" required>
                            </div>

                            <div class="mb-2">
                                <label for="device${index}-default_rule"><b>Default Rule:</b></label>
                                <input type="default_rule" class="form-control" id="device${index}-default_rule" placeholder="" name="device${index}-default_rule" required>
                            </div>`

            } else if (selected == "pwm") {
                template += `<div class="mb-2">
                                <label for="device${index}-pin"><b>Pin:</b></label>
                                <input type="text" class="form-control" id="device${index}-pin" placeholder="" name="device${index}-pin" required>
                            </div>

                            <div class="mb-2">
                                <label for="device${index}-min"><b>Min brightness:</b></label>
                                <input type="min" class="form-control" id="device${index}-min" placeholder="0" name="device${index}-min" required>
                            </div>

                            <div class="mb-2">
                                <label for="device${index}-max"><b>Max brightness:</b></label>
                                <input type="text" class="form-control" id="device${index}-max" placeholder="1023" name="device${index}-max" required>
                            </div>

                            <div class="mb-2">
                                <label for="device${index}-default_rule"><b>Default Rule:</b></label>
                                <input type="default_rule" class="form-control" id="device${index}-default_rule" placeholder="" name="device${index}-default_rule" required>
                            </div>`

            } else if (selected == "ir-blaster") {
                template += `<div class="mb-2">
                                <label for="device${index}-pin"><b>Pin:</b></label>
                                <input type="text" class="form-control" id="device${index}-pin" placeholder="" name="device${index}-pin" required>
                            </div>

                            <div class="mb-2">
                                <label for="device${index}-min"><b>Virtual remotes:</b></label>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="irblaster-tv" value="irblaster-tv" id="irblaster-tv">
                                    <label class="form-check-label" for="checkbox-tv">TV (Samsung)</label></br>
                                    <input class="form-check-input" type="checkbox" name="irblaster-ac" value="irblaster-ac" id="irblaster-ac">
                                    <label class="form-check-label" for="checkbox-ac">AC (Whynter)</label>
                                </div>
                            </div>`

            } else {
                // User selected first option ("Select device type"), clear form
                template = "";
            };

            // Render div, scroll down until visible
            document.getElementById("addDeviceOptions" + index).innerHTML = template;
            document.getElementById("addDeviceOptions" + index).scrollIntoView({behavior: "smooth"});
        };

        async function load_next_device(button) {
            // Get index of clicked button
            const index = parseInt(button.id.replace("addDeviceButton", ""));

            var template = `<div class="mt-5">
                                <div class="card">
                                    <div class="card-body">
                                        <h4 class="card-title">device${index + 1}</h4>
                                        <label for="deviceType${index + 1}" class="form-label"><b>Type:</b></label>
                                        <div>
                                            <select onchange="load_device_section(this)" name="deviceType${index + 1}" id="deviceType${index + 1}" class="form-select deviceType" required>
                                            <option value="clear">Select device type</option>
                                            <option value="dimmer">TP-Link Dimmer</option>
                                            <option value="bulb">TP-Link Bulb</option>
                                            <option value="relay">Smart Relay</option>
                                            <option value="dumb-relay">Relay</option>
                                            <option value="desktop">Desktop</option>
                                            <option value="pwm">LED Strip</option>
                                            <option value="mosfet">Mosfet</option>
                                            <option value="api-target">Api Command</option>
                                            <option value="ir-blaster">IR Blaster</option>
                                            </select>
                                        </div>

                                        <div id="addDeviceOptions${index + 1}" class="card-body"></div>
                                    </div>
                                </div>

                                <div class="text-center">
                                    <button onclick="load_next_device(this)" type="button" id="addDeviceButton${index + 1}" class="btn-secondary btn my-3">Add another</button>
                                </div>

                                <div id="addDeviceDiv${index + 2}">
                                </div>
                            </div>`

            // Hide clicked button
            document.getElementById("addDeviceButton" + index).style.display = "none";

            // Render div, scroll down until visible
            document.getElementById("addDeviceDiv" + (index + 1)).innerHTML = template;
            document.getElementById("addDeviceDiv" + (index + 1)).scrollIntoView({behavior: "smooth"});
        };

        async function load_next_sensor(button) {
            // Get index of clicked button
            const index = parseInt(button.id.replace("addSensorButton", ""));

            var template = `<div class="mt-5">
                                <div class="card">
                                    <div class="card-body">
                                        <h4 class="card-title">sensor${index + 1}</h4>
                                        <label for="sensorType${index + 1}" class="form-label"><b>Type:</b></label>
                                        <div>
                                            <select onchange="load_sensor_section(this)" name="sensorType${index + 1}" id="sensorType${index + 1}" class="form-select sensorType" required>
                                            <option value="clear">Select sensor type</option>
                                            <option value="pir">Motion Sensor</option>
                                            <option value="switch">Switch</option>
                                            <option value="dummy">Dummy</option>
                                            <option value="desktop">Desktop</option>
                                            <option value="si7021">Thermostat</option>
                                            </select>
                                        </div>

                                        <div id="addSensorOptions${index + 1}" class="card-body"></div>
                                    </div>
                                </div>

                                <div class="text-center">
                                    <button onclick="load_next_sensor(this)" type="button" id="addSensorButton${index + 1}" class="btn-secondary btn my-3">Add another</button>
                                </div>

                                <div id="addSensorDiv${index + 2}">
                                </div>
                            </div>`

            // Hide clicked button
            document.getElementById("addSensorButton" + index).style.display = "none";

            // Render div, scroll down until visible
            document.getElementById("addSensorDiv" + (index + 1)).innerHTML = template;
            document.getElementById("addSensorDiv" + (index + 1)).scrollIntoView({behavior: "smooth"});
        };

        document.getElementById('page1-button').addEventListener("click", async function(e) {
            e.preventDefault();

            var next_page = await readForm("configure_page2");
            next_page = await next_page.text()

            $('#page2').html(next_page);

            document.getElementById("page2").classList.add("d-flex");
            document.getElementById("page1").classList.remove("d-flex");
            document.getElementById("page1").style.display = "none";
        });

        document.getElementById('page1-back-button').addEventListener("click", function(e) {
            window.location.replace("/node_configuration");
        });

        document.getElementById('form').addEventListener("submit", function(e) {
            e.preventDefault();

            submit_form();
        });

        async function submit_form() {
            var result = await readForm("generateConfigFile");

            if (result.ok) {
                // Redirect back to overview where user can upload the newly-created config
                window.location.replace("/node_configuration");
            } else {

                // If duplicate error, display modal allowing user to overwrite
                if (result.status == 409) {
                    // Get duplicate name, add to modal body
                    const name = document.getElementById("friendlyName").value;
                    document.getElementById("duplicate-modal-body").innerHTML = "<p>Config named <b>" + name + "</b> already exists. Would you like to overwrite it? This cannot be undone.</p>"
                    $('#duplicate-modal').modal('show');

                    // Add listener to overwrite button, sends delete command for the existing config then re-submits form
                    $('#confirm-overwrite').click(async function() {
                        // Disable listener once triggered, prevent overwrite button stacking multiple actions
                        $('#confirm-overwrite').off('click');

                        let csrftoken = getCookie('csrftoken');

                        const response = await fetch("delete_config", {
                            method: 'POST',
                            body: JSON.stringify(name + ".json"),
                            headers: { 'Accept': 'application/json, text/plain, */*',
                                'Content-Type': 'application/json',
                                "X-CSRFToken": csrftoken }
                        });

                        // Re-submit form
                        submit_form();
                    });

                    // Add listener to cancel button
                    $('#cancel-overwrite').click(function() {
                        // Prevent stacking listeners on overwrite button each time cancel pressed
                        $('#confirm-overwrite').off('click');
                    });

                // If other error, display in alert
                } else {
                    alert(await result.text());
                };
            };
        };

        // Listen for system theme changes, switch to dark/light mode to reflect (responsive)
        window.matchMedia('(prefers-color-scheme: dark)').addListener(function (e) {
            if (e.matches) { // Returns True for dark mode, False otherwise
                document.body.classList.add("dark");
                for (el of document.getElementsByClassName("table")) {
                    el.classList.add("table-dark")
                };
            } else {
                document.body.classList.remove("dark");
                for (el of document.getElementsByClassName("table")) {
                    el.classList.remove("table-dark")
                };
            }
        });
    </script>

</body>


</html>
