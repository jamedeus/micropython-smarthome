{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
    <title>Micropython Smarthome API</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="{% static 'node_configuration/jquery.min.js' %}"></script>
    <script>

        function getCookie(name) {
            var cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                var cookies = document.cookie.split(';');
                for (var i = 0; i < cookies.length; i++) {
                    var cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        };

    </script>
</head>

<body>

    <div id="page1">
        <h3>Api Overview</h3>

        {% if context %}
            {% for node in context %}
                <button onclick="select_node(this)" type="button" class="select_node" id="{{node.friendly_name}}">{{node.friendly_name}}</button>
            {% endfor %}

        {% else %}
            <p>No nodes available</p>
        {% endif %}
    </div>

    <div id="page2" style="display:none;">

        <h3 id="target_node"></h3>

        <label class="col-2 col-form-label" for="select_command"><b>Select Command</b></label>
        <div class="col col-10">
            <select onchange="select_command(this)" name="select_command" id="select_command" class="form-select mb-3" required>
                <option value="clear" id="clear">Please select a command</option>
                <option value="status">Status</option>
                <option value="reboot">Reboot</option>
                <option value="disable">Disable device/sensor</option>
                <option value="disable_in">Disable device/sensor after delay</option>
                <option value="enable">Enable device/sensor</option>
                <option value="enable_in">Enable device/sensor after delay</option>
                <option value="set_rule">Set device/sensor rule</option>
                <option value="reset_rule">Reset device/sensor rule</option>
                <option value="get_schedule_rules">Get device/sensor schedule rules</option>
                <option value="add_rule">Add device/sensor schedule rule</option>
                <option value="remove_rule">Remove device/sensor schedule rule</option>
                <option value="get_attributes">Get device/sensor attributes (debug)</option>
                <option value="ir">Send IR Command</option>
                <option value="get_temp">Get temperature reading</option>
                <option value="get_humid">Get humidity reading</option>
                <option value="clear_log">Clear log</option>
                <option value="condition_met">Check if sensor is triggered</option>
                <option value="trigger_sensor">Trigger sensor</option>
                <option value="turn_on">Turn device on</option>
                <option value="turn_off">Turn device off</option>
            </select>
        </div></br>

        <div id="options">
            <form id="form">
            </form>
        </div>

    </div>

    <script>

        var selected_node = "";
        var selected_node_status = "";
        var selected_command = "";
        var device_options = "";
        var sensor_options = "";
        var schedule_rules = "";

        const submit_button = "<button onclick='send_command(this)' type='button' id='send'>Send</button>";

        const dropdown_open = "\
                        <select name='select_target' id='select_target' onchange='load_additional_info(this)' required>\
                        <option disabled selected value> -- select an option -- </option>";

        const dropdown_close = "</select></br></br>";

        const delay_input = "<input type='number' id='delay_input' placeholder='minutes' name='delay_input' required></br></br>"

        const rule_input = "<input type='text' id='rule_input' placeholder='new rule' name='rule_input' required></br></br>"

        const timestamp_input = "<input type='text' id='timestamp_input' placeholder='HH:MM' name='timestamp_input' required></br></br>"

        const additional_info = "<div id='additional_info'></div></br>"

        async function select_node(selected) {
            selected_node = selected.id;
            document.getElementById("clear").selected = true;
            document.getElementById("target_node").textContent = selected_node;
            document.getElementById("page1").style.display = "none";
            document.getElementById("page2").style.display = "inline";
            selected_node_status = await fetch("/get_status/" + selected_node);
            selected_node_status = await selected_node_status.json();

            for (var device in selected_node_status["devices"]) {
                device_options = device_options + "<option value='" + device + "'>" + device + "</option>";
            };

            for (var sensor in selected_node_status["sensors"]) {
                sensor_options = sensor_options + "<option value='" + sensor + "'>" + sensor + "</option>";
            };
        };

        async function select_command(selected) {
            // Get chosen command
            selected_command = document.getElementById(selected.id).value;

            if (selected_command == "clear") {
                document.getElementById("form").innerHTML = "";
            } else if (selected_command == "status") {
                // Add div, no submit button (already have status info)
                document.getElementById("form").innerHTML = additional_info;
                // Pass select element to function, loads existing status info into div
                load_additional_info(selected);
            } else if (selected_command == "reboot") {
                document.getElementById("form").innerHTML = submit_button;
            } else if (selected_command == "disable") {
                document.getElementById("form").innerHTML = dropdown_open + device_options + sensor_options + dropdown_close + additional_info + submit_button;
            } else if (selected_command == "disable_in") {
                document.getElementById("form").innerHTML = dropdown_open + device_options + sensor_options + dropdown_close + additional_info + delay_input + submit_button;
            } else if (selected_command == "enable") {
                document.getElementById("form").innerHTML = dropdown_open + device_options + sensor_options + dropdown_close + additional_info + submit_button;
            } else if (selected_command == "enable_in") {
                document.getElementById("form").innerHTML = dropdown_open + device_options + sensor_options + dropdown_close + additional_info + delay_input + submit_button;
            } else if (selected_command == "set_rule") {
                document.getElementById("form").innerHTML = dropdown_open + device_options + sensor_options + dropdown_close + additional_info + rule_input + submit_button;
            } else if (selected_command == "reset_rule") {
                document.getElementById("form").innerHTML = dropdown_open + device_options + sensor_options + dropdown_close + additional_info + submit_button;
            } else if (selected_command == "get_schedule_rules") {
                document.getElementById("form").innerHTML = dropdown_open + device_options + sensor_options + dropdown_close + additional_info;
            } else if (selected_command == "add_rule") {
                document.getElementById("form").innerHTML = dropdown_open + device_options + sensor_options + dropdown_close + additional_info + timestamp_input + rule_input + submit_button;
            } else if (selected_command == "remove_rule") {
                document.getElementById("form").innerHTML = dropdown_open + device_options + sensor_options + dropdown_close + additional_info + timestamp_input + submit_button;
            } else if (selected_command == "get_attributes") {
                document.getElementById("form").innerHTML = dropdown_open + device_options + sensor_options + dropdown_close + submit_button;
            } else if (selected_command == "ir") {
                document.getElementById("form").innerHTML = "<p>Not yet supported</p>";
            } else if (selected_command == "get_temp") {
                document.getElementById("form").innerHTML = submit_button;
            } else if (selected_command == "get_humid") {
                document.getElementById("form").innerHTML = submit_button;
            } else if (selected_command == "clear_log") {
                document.getElementById("form").innerHTML = submit_button;
            } else if (selected_command == "condition_met") {
                document.getElementById("form").innerHTML = dropdown_open + sensor_options + dropdown_close + additional_info + submit_button;
            } else if (selected_command == "trigger_sensor") {
                document.getElementById("form").innerHTML = dropdown_open + sensor_options + dropdown_close + additional_info + submit_button;
            } else if (selected_command == "turn_on") {
                document.getElementById("form").innerHTML = dropdown_open + device_options + dropdown_close + additional_info + submit_button;
            } else if (selected_command == "turn_off") {
                document.getElementById("form").innerHTML = dropdown_open + device_options + dropdown_close + additional_info + submit_button;
            };
        };

        async function send_command(selected) {
            const data = new FormData(document.getElementById("form"));

            var value = Object.fromEntries(data.entries());

            value["target"] = selected_node

            value["command"] = document.getElementById('select_command').value;

            let csrftoken = getCookie('csrftoken');

            const next_page = await fetch('/send_command', {
                method: 'POST',
                body: JSON.stringify(value),
                headers: { 'Accept': 'application/json, text/plain, */*',
                    'Content-Type': 'application/json',
                    "X-CSRFToken": csrftoken }
            });

            const result = await next_page.text()

            alert(result);

            // Update status after sending command
            selected_node_status = await fetch("/get_status/" + selected_node);
            selected_node_status = await selected_node_status.json();

            // Update additional info section (if any)
            load_additional_info(document.getElementById("select_target"));
        };

        async function load_additional_info(selected) {
            try {
                selected_target = document.getElementById(selected.id).value;
            }
            catch(err) {
                // Dropdown wasn't used, no update needed
                return
            }

            if (selected_command == "status") {
                document.getElementById("additional_info").innerHTML = "<pre>" + JSON.stringify(selected_node_status, null, 4) + "</pre>";

            } else if (selected_command == "enable") {
                if (selected_node_status[selected_target.replace(/[0-9]/g, '') + "s"][selected_target]["enabled"]) {
                    document.getElementById("additional_info").innerHTML = selected_target + " already enabled";
                    // Hide button
                    document.getElementById('send').style.display = 'none';
                } else {
                    // Show button in case previously hidden
                    document.getElementById('send').style.display = 'initial';
                };

            } else if (selected_command == "enable_in") {
                if (selected_node_status[selected_target.replace(/[0-9]/g, '') + "s"][selected_target]["enabled"]) {
                    document.getElementById("additional_info").innerHTML = selected_target + " already enabled";
                } else {
                    document.getElementById("additional_info").innerHTML = selected_target + " currently disabled";
                };

            } else if (selected_command == "disable") {
                if (selected_node_status[selected_target.replace(/[0-9]/g, '') + "s"][selected_target]["enabled"]) {
                    // Show button in case previously hidden
                    document.getElementById('send').style.display = 'initial';
                } else {
                    document.getElementById("additional_info").innerHTML = selected_target + " already disabled";
                    // Hide button
                    document.getElementById('send').style.display = 'none';
                };

            } else if (selected_command == "disable_in") {
                if (selected_node_status[selected_target.replace(/[0-9]/g, '') + "s"][selected_target]["enabled"]) {
                    document.getElementById("additional_info").innerHTML = selected_target + " currently enabled";
                } else {
                    document.getElementById("additional_info").innerHTML = selected_target + " already disabled";
                };

            } else if (selected_command == "set_rule") {
                const current_rule = selected_node_status[selected_target.replace(/[0-9]/g, '') + "s"][selected_target]["current_rule"];
                document.getElementById("additional_info").innerHTML = "Current rule: " + current_rule;

            } else if (selected_command == "reset_rule") {
                const current_rule = selected_node_status[selected_target.replace(/[0-9]/g, '') + "s"][selected_target]["current_rule"];
                const scheduled_rule = selected_node_status[selected_target.replace(/[0-9]/g, '') + "s"][selected_target]["scheduled_rule"];

                if (current_rule == scheduled_rule) {
                    document.getElementById("additional_info").innerHTML = "Current rule (" + current_rule + ") already matches scheduled rule (" + scheduled_rule + ")."
                    // Hide button
                    document.getElementById('send').style.display = 'none';
                } else {
                    document.getElementById("additional_info").innerHTML = "Current rule (" + current_rule + ") will revert back to scheduled rule (" + scheduled_rule + ")."
                    // Show button in case previously hidden
                    document.getElementById('send').style.display = 'initial';
                };

            } else if (selected_command == "add_rule") {
                // Get object containing target's existing rules
                const rules = selected_node_status[selected_target.replace(/[0-9]/g, '') + "s"][selected_target]["schedule"];

                // If target has no rules, add text to div and skip rest of function
                if (Object.keys(rules).length == 0) {
                    document.getElementById("additional_info").innerHTML = "No existing rules";
                    return;
                };

                // Build table of target's existing rules, display in div
                var rules_table = '<h3>Existing rules:</h3><table style="width:50%"><tr><th style="text-align: left;">Time</th><th style="text-align: left;">Rule</th></tr>'
                for (var rule in rules) {
                    rules_table = rules_table + "<tr><td>" + rule + "</td><td>" + rules[rule] + "</td></tr>";
                };
                rules_table = rules_table + "</table>";

                document.getElementById("additional_info").innerHTML = rules_table;

            } else if (selected_command == "remove_rule") {
                // Get object containing target's existing rules
                const rules = selected_node_status[selected_target.replace(/[0-9]/g, '') + "s"][selected_target]["schedule"];

                // If target has no rules, add text to div and skip rest of function
                if (Object.keys(rules).length == 0) {
                    document.getElementById("additional_info").innerHTML = "No existing rules";
                    // Remove input and submit button (cannot remove if no rules)
                    document.getElementById('timestamp_input').style.display = 'none';
                    document.getElementById('send').style.display = 'none';
                    return;
                };

                // Build table of target's existing rules, display in div
                var rules_table = '<h3>Existing rules:</h3><table style="width:50%"><tr><th style="text-align: left;">Time</th><th style="text-align: left;">Rule</th></tr>'
                for (var rule in rules) {
                    rules_table = rules_table + "<tr><td>" + rule + "</td><td>" + rules[rule] + "</td></tr>";
                };
                rules_table = rules_table + "</table>";

                document.getElementById("additional_info").innerHTML = rules_table;

                // Display input and submit button in case they were previously hidden
                document.getElementById('timestamp_input').style.display = 'initial';
                document.getElementById('send').style.display = 'initial';

            } else if (selected_command == "get_schedule_rules") {
                // Get object containing target's existing rules
                const rules = selected_node_status[selected_target.replace(/[0-9]/g, '') + "s"][selected_target]["schedule"];

                // If target has no rules, add text to div and skip rest of function
                if (Object.keys(rules).length == 0) {
                    document.getElementById("additional_info").innerHTML = "No existing rules";
                    return;
                };

                // Build table of target's existing rules, display in div
                var rules_table = '<h3>Existing rules:</h3><table style="width:50%"><tr><th style="text-align: left;">Time</th><th style="text-align: left;">Rule</th></tr>'
                for (var rule in rules) {
                    rules_table = rules_table + "<tr><td>" + rule + "</td><td>" + rules[rule] + "</td></tr>";
                };
                rules_table = rules_table + "</table>";

                document.getElementById("additional_info").innerHTML = rules_table;

            } else if (selected_command == "condition_met") {
                const type = selected_node_status["sensors"][selected_target]["type"];
                const targets = selected_node_status["sensors"][selected_target]["targets"];

                document.getElementById("additional_info").innerHTML = "Sensor type: " + type + "</br>Targets: " + targets;

            } else if (selected_command == "trigger_sensor") {
                const type = selected_node_status["sensors"][selected_target]["type"];
                const targets = selected_node_status["sensors"][selected_target]["targets"];

                document.getElementById("additional_info").innerHTML = "Sensor type: " + type + "</br>Targets: " + targets;

            } else if (selected_command == "turn_on") {
                if (selected_node_status["devices"][selected_target]["turned_on"]) {
                    document.getElementById("additional_info").innerHTML = selected_target + " already turned on.";
                    // Hide button
                    document.getElementById('send').style.display = 'none';
                } else {
                    document.getElementById("additional_info").innerHTML = selected_target + " currently off.";
                    // Show button in case previously hidden
                    document.getElementById('send').style.display = 'initial';
                };

            } else if (selected_command == "turn_off") {
                if (!selected_node_status["devices"][selected_target]["turned_on"]) {
                    document.getElementById("additional_info").innerHTML = selected_target + " already turned off.";
                    // Hide button
                    document.getElementById('send').style.display = 'none';
                } else {
                    document.getElementById("additional_info").innerHTML = selected_target + " currently on.";
                    // Show button in case previously hidden
                    document.getElementById('send').style.display = 'initial';
                };
            };

        };

    </script>

</body>
</html>
