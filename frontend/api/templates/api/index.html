{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
    <title>Micropython Smarthome API</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="{% static 'node_configuration/bootstrap.min.css' %}">
    <link rel="stylesheet" href="{% static 'node_configuration/bootstrap-icons.css' %}">
    <link rel="stylesheet" href="{% static 'node_configuration/style.css' %}">
    <script src="{% static 'node_configuration/bootstrap.min.js' %}"></script>
    <script src="{% static 'node_configuration/jquery.min.js' %}"></script>
    <script>

        function getCookie(name) {
            var cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                var cookies = document.cookie.split(';');
                for (var i = 0; i < cookies.length; i++) {
                    var cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        };

    </script>
    <style>
        .result {
            background-color: #D9D9D9;
            border-radius: 8px;
            width: 85%;
        }

        body.dark .result {
            background-color: #2B2E2F;
        }

        /* Limit width for readability on large screen sizes */
        @media (min-width: 1200px) {
            .container {
                width: 960px;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <div id="page1">
            <h3 class="text-center mt-3">Api Overview</h3>

            {% if context %}
                <div class="text-center">
                    {% for node in context %}
                        <button onclick="select_node(this)" type="button" class="select_node btn btn-primary m-1" id="{{node.friendly_name}}">{{node.friendly_name}}</button>
                    {% endfor %}
                </div>

            {% else %}
                <p>No nodes available</p>
            {% endif %}
        </div>

        <div id="page2" style="display:none;">

            <button onclick="page1()" type="button" id="back_button" class="btn btn-secondary mt-3">Back</button></br>

            <h3 id="target_node" class="text-center mt-3"></h3>

            <label class="form-label" for="select_command"><b>Select Command</b></label>
            <div>
                <select onchange="select_command(this)" name="select_command" id="select_command" class="form-select mb-3" required>
                    <option value="clear" id="clear">Please select a command</option>
                    <option value="status">Status</option>
                    <option value="reboot">Reboot</option>
                    <option value="disable">Disable device/sensor</option>
                    <option value="enable">Enable device/sensor</option>
                    <option value="set_rule">Set device/sensor rule</option>
                    <option value="reset_rule">Reset device/sensor rule</option>
                    <option value="schedule_rules">Modify device/sensor schedule rules</option>
                    <option value="get_attributes">Get device/sensor attributes (debug)</option>
                    <option value="ir">Send IR Command</option>
                    <option value="temp_sensor" id="temp_sensor_option">View temperature/humidity readings</option>
                    <option value="clear_log">Clear log</option>
                    <option value="condition_met">Check if sensor is triggered</option>
                    <option value="trigger_sensor">Trigger sensor</option>
                    <option value="turn_on">Turn device on</option>
                    <option value="turn_off">Turn device off</option>
                </select>
            </div></br>

            <div id="options">
                <form id="form">
                </form>
            </div>

        </div>
    </div>

    <!-- Error modal displayed when unable to connect to target node -->

    <div class="modal fade" id="error-modal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered" >
            <div class="modal-content">
                <div class="modal-header pb-0" style="border-bottom: 0px;">
                    <h3 class="mx-auto mb-0" id="error-modal-title">Connection Error</h3>
                </div>
                <div class="modal-body" id="error-modal-body">
                    <p class="text-center">Attempting to reestablish connection...</p>
                    <div class="d-flex justify-content-center mb-3">
                        <div class="spinner-border" style="width: 1.5rem; height: 1.5rem;" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                    <div class="d-flex justify-content-center">
                        <button type="button" id="ok-button" class="btn btn-success" data-bs-dismiss="modal" onclick="page1()">Back to Overview</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Check if user is in dark mode, change theme (runs once on page load)
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.body.classList.add("dark");
            console.log("Dark mode");
        };

        var selected_node = "";
        var selected_node_status = "";
        var selected_node_unreachable = false;
        var selected_command = "";
        var device_options = "";
        var sensor_options = "";
        var climate_data = "";
        var timer;

        const submit_button = "<div class='text-center'><button onclick='submit_form(this)' type='button' id='send' class='btn btn-primary'>Send</button></div></br><div id='result' class='result mx-auto'></div>";

        const dropdown_open = "\
                        <select name='select_target' id='select_target' onchange='load_additional_info(this)' class='form-control' required>\
                        <option disabled selected value> -- select an option -- </option>";

        const dropdown_close = "</select></br>";

        const dropdown_label_target = "<label class='form-label' for='select_taret'>Select Target</label>";

        const dropdown_label_command = "<label class='form-label' for='select_taret'>Select Command</label>";

        const delay_input = "<label class='form-label' for='delay_input'>For (leave blank for permanent)</label></br><input type='number' id='delay_input' placeholder='minutes' name='delay_input' class='form-control'></br>"

        const rule_input = "<input type='text' id='rule_input' placeholder='new rule' name='rule_input' class='form-control' required></br>"

        const add_rule_input = "<h5 class='text-center'>Add new rule</h5><div style='width: 85%' class='row mx-auto'><div class='col'><input type='text' id='add_rule_input' placeholder='HH:MM' name='add_rule_input' class='form-control' maxlength='5' required></div><div class='col'><input type='text' id='rule_input' placeholder='new rule' name='rule_input' class='form-control' required></div></div></br>"

        const additional_info = "<div id='additional_info'></div></br>"

        const ir_target_select = "<div class='form-check'><input type='radio' id='tv' name='ir_target' value='tv' class='form-check-input' onclick='load_additional_info(this)'><label for='tv' class='form-check-label'>TV</label><br><input type='radio' id='ac' name='ir_target' value='ac' class='form-check-input' onclick='load_additional_info(this)'><label for='ac' class='form-label-input'>Air Conditioner</label></div><br>"

        const ac_options = "<option value='on'>on</option><option value='off'>off</option><option value='start'>start</option><option value='stop'>stop</option>"

        const tv_options = "<option value='power'>power</option><option value='vol_up'>vol_up</option><option value='vol_down'>vol_down</option><option value='mute'>mute</option><option value='up'>up</option><option value='down'>down</option><option value='left'>left</option><option value='right'>right</option><option value='enter'>enter</option><option value='settings'>settings</option><option value='exit'>exit</option><option value='source'>source</option>"

        // Form submit listener (prevent querystring submit when user presses enter)
        document.getElementById("form").addEventListener("submit", function(e) {
            console.log("submit");
            e.preventDefault();
            submit_form(e.target);
        });

        // Get status every 5 seconds, update div if user currently viewing status
        function monitorSelectedNodeStatus(start) {
            if (start) {
                // Initial value, used to detect change
                selected_node_unreachable = false;

                statusTimer = setInterval(async function() {
                    // Get status object
                    selected_node_status = await fetch("/get_status/" + selected_node);
                    selected_node_status = await selected_node_status.json();

                    // If unable to connect
                    if (selected_node_unreachable == false && selected_node_status == "Error: Unable to connect.") {
                        $("#error-modal").modal("show");
                        console.log("Unable to connect to target, will retry every 5 seconds.");
                        selected_node_unreachable = true;

                        // Clear device/sensor options (none are reachable if node isn't)
                        rebuild_target_options();
                        select_command(document.getElementById("select_command"));

                    } else if (selected_node_unreachable == true && selected_node_status != "Error: Unable to connect.") {
                        $("#error-modal").modal("hide");
                        console.log("Re-connected to target.");
                        selected_node_unreachable = false;

                        // If node was unreachable but now reachable, re-populate device/sensor menus (blank while unreachable)
                        rebuild_target_options();
                        select_command(document.getElementById("select_command"));
                    };

                    // If user is viewig status, update div every time new data received
                    if (selected_command == "status") {
                        document.getElementById("additional_info").innerHTML = `<div class='d-block text-center'><pre class='d-inline-block text-start'>${JSON.stringify(selected_node_status, null, 4)}</pre></div>`;
                    };

                }, 5000);
            } else {
                clearInterval(statusTimer);

                // Clear old data if present
                selected_node_status = ""
            };
        };

        async function rebuild_target_options() {
            // Clear previous options (selected node changed, options may be different)
            device_options = "";
            sensor_options = "";

            // Rebuild device and sensor options for current node
            for (var device in selected_node_status["devices"]) {
                device_options = device_options + `<option value='${device}'>${device}</option>`;
            };

            // Detect presence of temp sensor in loop below
            var temp_sensor = false;

            for (var sensor in selected_node_status["sensors"]) {
                sensor_options = sensor_options + `<option value='${sensor}'>${sensor}</option>`;

                // If node has temp sensor, toggle bool
                if (selected_node_status["sensors"][sensor]["type"] == "si7021") {
                    temp_sensor = true;
                };
            };

            if (temp_sensor) {
                // Show menu option
                document.getElementById("temp_sensor_option").style.display = "initial";

                // Get initial reading
                climate_data = await fetch("/get_climate_data/" + selected_node);
                climate_data = await climate_data.json();

                // Query new reading every 5 seconds
                queryTempSensor(true);
            } else {
                // If no temp sensor, hide menu option and stop querying (may be running from previous selection)
                document.getElementById("temp_sensor_option").style.display = "none";

                // Stop querying sensor every 5 seconds
                queryTempSensor(false);
            };
        };

        async function select_node(selected) {
            selected_node = selected.id;
            document.getElementById("clear").selected = true;
            document.getElementById("form").innerHTML = "";
            document.getElementById("target_node").textContent = selected_node;
            document.getElementById("page1").style.display = "none";
            document.getElementById("page2").style.display = "inline";
            selected_node_status = await fetch("/get_status/" + selected_node);
            selected_node_status = await selected_node_status.json();

            // Get device/sensor dropdown options for status object
            rebuild_target_options();

            // Update status info for selected node every 15 seconds
            monitorSelectedNodeStatus(true);
        };

        function page1() {
            document.getElementById("page2").style.display = "none";
            document.getElementById("page1").style.display = "initial";

            // Stop querying selected node status info
            monitorSelectedNodeStatus(false);

            // Stop querying climate data (if user previously viewed node with temp sensor)
            queryTempSensor(false);
        };

        async function select_command(selected) {
            // Get chosen command
            selected_command = document.getElementById(selected.id).value;

            if (selected_command == "clear") {
                document.getElementById("form").innerHTML = "";
            } else if (selected_command == "status") {
                // Add div, no submit button (already have status info)
                document.getElementById("form").innerHTML = additional_info;
                // Pass select element to function, loads existing status info into div
                load_additional_info(selected);
            } else if (selected_command == "reboot") {
                document.getElementById("form").innerHTML = submit_button;
            } else if (selected_command == "disable") {
                document.getElementById("form").innerHTML = dropdown_label_target + dropdown_open + device_options + sensor_options + dropdown_close + delay_input + additional_info + submit_button;
                document.getElementById('delay_input').addEventListener('input', delay_input_handler);

                // Prevent non-numeric input in delay field (accepts int minutes)
                document.getElementById("delay_input").addEventListener("keypress", function (evt) {
                    if (evt.which < 48 || evt.which > 57) {
                        evt.preventDefault();
                    }
                });
            } else if (selected_command == "enable") {
                document.getElementById("form").innerHTML = dropdown_label_target + dropdown_open + device_options + sensor_options + dropdown_close + delay_input + additional_info + submit_button;
                document.getElementById('delay_input').addEventListener('input', delay_input_handler);

                // Prevent non-numeric input in delay field (accepts int minutes)
                document.getElementById("delay_input").addEventListener("keypress", function (evt) {
                    if (evt.which < 48 || evt.which > 57) {
                        evt.preventDefault();
                    }
                });
            } else if (selected_command == "set_rule") {
                document.getElementById("form").innerHTML = dropdown_label_target + dropdown_open + device_options + sensor_options + dropdown_close + additional_info + rule_input + submit_button;
            } else if (selected_command == "reset_rule") {
                document.getElementById("form").innerHTML = dropdown_label_target + dropdown_open + device_options + sensor_options + dropdown_close + additional_info + submit_button;
            } else if (selected_command == "schedule_rules") {
                document.getElementById("form").innerHTML = dropdown_label_target + dropdown_open + device_options + sensor_options + dropdown_close + additional_info;
            } else if (selected_command == "get_attributes") {
                document.getElementById("form").innerHTML = dropdown_label_target + dropdown_open + device_options + sensor_options + dropdown_close + submit_button;
            } else if (selected_command == "ir") {
                document.getElementById("form").innerHTML = ir_target_select + additional_info;
            } else if (selected_command == "temp_sensor") {
                document.getElementById("form").innerHTML = additional_info;
                document.getElementById("additional_info").innerHTML = `<div class="result mx-auto py-1"><table class="table table-borderless"><tr><th class="text-center w-50">Temperature</th><th class="text-center w-50">Humidity</th><tr><td class="text-center">${climate_data["temp"].toFixed(2)}</td><td class="text-center">${climate_data["humid"].toFixed(2)}</td></tr>`;
            } else if (selected_command == "clear_log") {
                document.getElementById("form").innerHTML = submit_button;
            } else if (selected_command == "condition_met") {
                document.getElementById("form").innerHTML = dropdown_label_target + dropdown_open + sensor_options + dropdown_close + additional_info + submit_button;
            } else if (selected_command == "trigger_sensor") {
                document.getElementById("form").innerHTML = dropdown_label_target + dropdown_open + sensor_options + dropdown_close + additional_info + submit_button;
            } else if (selected_command == "turn_on") {
                document.getElementById("form").innerHTML = dropdown_label_target + dropdown_open + device_options + dropdown_close + additional_info + submit_button;
            } else if (selected_command == "turn_off") {
                document.getElementById("form").innerHTML = dropdown_label_target + dropdown_open + device_options + dropdown_close + additional_info + submit_button;
            };
        };

        // Receives command parameters in value
        async function send_command(value) {
            // Add target and selected command to request body
            value["target"] = selected_node
            value["command"] = document.getElementById('select_command').value;

            let csrftoken = getCookie('csrftoken');

            var result = await fetch('/send_command', {
                method: 'POST',
                body: JSON.stringify(value),
                headers: { 'Accept': 'application/json, text/plain, */*',
                    'Content-Type': 'application/json',
                    "X-CSRFToken": csrftoken }
            });

            return result
        };

        async function submit_form(selected) {
            // Clear results from previous command to avoid confusion
            try { document.getElementById("result").innerHTML = ""; } catch(err) {};

            // Disable send button until finished with current command
            document.getElementById("send").disabled = true;

            const data = new FormData(document.getElementById("form"));

            var value = Object.fromEntries(data.entries());

            var result = await send_command(value);
            result = await result.json();

            // Update status after sending command
            selected_node_status = await fetch("/get_status/" + selected_node);
            selected_node_status = await selected_node_status.json();

            // Update additional info section (if any)
            load_additional_info(document.getElementById("select_target"));

            // If result was an error, unhide results div (if hidden, ie schedule_rules menu)
            if (JSON.stringify(result).startsWith('{"ERROR')) {
                console.log("showing results div");
                document.getElementById("result").style = "";
            } else {
                // If command succeeded, clear input fields to avoid confusion
                try { document.getElementById('delay_input').value = ""; } catch(err) {};
            };

            // Load result div (if any)
            try {
                document.getElementById("result").innerHTML = `<pre class='p-3'>${JSON.stringify(result, null, 4)}</pre>`;
            } catch(err) {};

            // Re-enable send button
            document.getElementById("send").disabled = false;
        };

        async function load_additional_info(selected) {
            try {
                selected_target = document.getElementById(selected.id).value;
                // Function called before user selected target (ie filled text input first), exit function
                if (!selected_target) { return };
            } catch(err) {
                // Dropdown wasn't used, no update needed
                return
            };

            if (selected_command == "status") {
                document.getElementById("additional_info").innerHTML = `<div class='d-block text-center'><pre class='d-inline-block text-start'>${JSON.stringify(selected_node_status, null, 4)}</pre></div>`;

            } else if (selected_command == "enable") {
                msg = "";
                delay = document.getElementById("delay_input").value;

                if (selected_node_status[selected_target.replace(/[0-9]/g, '') + "s"][selected_target]["enabled"]) {
                    msg = selected_target + " already enabled";
                } else {
                    msg = selected_target + " will be enabled";
                };

                if (delay) {
                    msg = msg + `</br>${selected_target} will be disabled in ${delay} minutes`;
                };

                document.getElementById("additional_info").innerHTML = `<div class='text-center'>${msg}</div>`;

            } else if (selected_command == "disable") {
                msg = "";
                delay = document.getElementById("delay_input").value;

                if (! selected_node_status[selected_target.replace(/[0-9]/g, '') + "s"][selected_target]["enabled"]) {
                    msg = selected_target + " already disabled";
                } else {
                    msg = selected_target + " will be disabled";
                };

                if (delay) {
                    msg = msg + `</br>${selected_target} will be re-enabled in ${delay} minutes`;
                };

                document.getElementById("additional_info").innerHTML = `<div class='text-center'>${msg}</div>`;

            } else if (selected_command == "set_rule") {
                const current_rule = selected_node_status[selected_target.replace(/[0-9]/g, '') + "s"][selected_target]["current_rule"];
                document.getElementById("additional_info").innerHTML = `<div class='text-center'>Current rule: ${current_rule}</div>`;

                // Clear rule input when target changes, after submit
                document.getElementById('rule_input').value = "";

            } else if (selected_command == "reset_rule") {
                const current_rule = selected_node_status[selected_target.replace(/[0-9]/g, '') + "s"][selected_target]["current_rule"];
                const scheduled_rule = selected_node_status[selected_target.replace(/[0-9]/g, '') + "s"][selected_target]["scheduled_rule"];

                if (current_rule == scheduled_rule) {
                    document.getElementById("additional_info").innerHTML = `<div class='text-center'>Current rule (${current_rule}) already matches scheduled rule (${scheduled_rule}).</div>`;
                    // Hide button
                    document.getElementById('send').style.display = 'none';
                } else {
                    document.getElementById("additional_info").innerHTML = `<div class='text-center'>Current rule (${current_rule}) will revert back to scheduled rule (${scheduled_rule}).</div>`;
                    // Show button in case previously hidden
                    document.getElementById('send').style.display = 'initial';
                };

            } else if (selected_command == "schedule_rules") {
                // Get object containing target's existing rules
                const rules = selected_node_status[selected_target.replace(/[0-9]/g, '') + "s"][selected_target]["schedule"];

                // If target has no rules, add text to div and skip rest of function
                if (Object.keys(rules).length == 0) {
                    document.getElementById("additional_info").innerHTML = "No existing rules";
                    return;
                };

                // Build table of target's existing rules, display in div
                var rules_table = '<h3 class="text-center">Existing rules:</h3><div class="result mx-auto py-1"><table class="table table-borderless"><tr><th class="text-center w-25">Time</th><th class="text-center w-50">Rule</th><th class="text-center w-25">Delete</th></tr>'
                for (var rule in rules) {
                    rules_table = rules_table + `<tr><td class='text-center'>${rule}</td><td class='text-center'>${rules[rule]}</td><td class='text-center'><button onclick='delete_rule(this)' type='button' id="${rule}" class='btn btn-sm btn-danger py-0'>X</button></td></tr>`;
                };
                rules_table = rules_table + "</table></div></br>";

                document.getElementById("additional_info").innerHTML = rules_table + add_rule_input + submit_button;

                // Hide results div (additional_info updates to show result)
                document.getElementById("result").style.display = "none";

                // Only allow numbers and : in timestamp field
                document.getElementById("add_rule_input").addEventListener("keypress", function (evt) {
                    if (evt.which < 48 || evt.which > 58) {
                        evt.preventDefault();
                    };
                });

            } else if (selected_command == "condition_met") {
                const type = selected_node_status["sensors"][selected_target]["type"];
                const targets = selected_node_status["sensors"][selected_target]["targets"];

                document.getElementById("additional_info").innerHTML = `<div class='text-center'>Sensor type: ${type}</br>Targets: ${targets}</div>`;

            } else if (selected_command == "trigger_sensor") {
                const type = selected_node_status["sensors"][selected_target]["type"];
                const targets = selected_node_status["sensors"][selected_target]["targets"];

                document.getElementById("additional_info").innerHTML = `<div class='text-center'>Sensor type: ${type}</br>Targets: ${targets}</div>`;

            } else if (selected_command == "turn_on") {
                if (selected_node_status["devices"][selected_target]["turned_on"]) {
                    document.getElementById("additional_info").innerHTML = `<div class='text-center'>${selected_target} already turned on.</div>`;
                    // Hide button
                    document.getElementById('send').style.display = 'none';
                } else {
                    document.getElementById("additional_info").innerHTML = `<div class='text-center'>${selected_target} currently off.</div>`;
                    // Show button in case previously hidden
                    document.getElementById('send').style.display = 'initial';
                };

            } else if (selected_command == "turn_off") {
                if (!selected_node_status["devices"][selected_target]["turned_on"]) {
                    document.getElementById("additional_info").innerHTML = `<div class='text-center'>${selected_target} already turned off.</div>`;
                    // Hide button
                    document.getElementById('send').style.display = 'none';
                } else {
                    document.getElementById("additional_info").innerHTML = `<div class='text-center'>${selected_target} currently on.</div>`;
                    // Show button in case previously hidden
                    document.getElementById('send').style.display = 'initial';
                };
            } else if (selected_command == "ir") {
                if (selected.value == "ac") {

                    buttons = `<div class="d-flex flex-column">
                                    <div class="row mx-auto mb-3">
                                        <button class="col m-3 btn btn-lg btn-primary" onclick="send_command({ir_target: 'ac', key: 'stop'});"><i class="bi-wind"></i></button>
                                        <button class="col m-3 btn btn-lg btn-primary" onclick="send_command({ir_target: 'ac', key: 'off'});"><i class="bi-x-octagon-fill"></i></button>
                                        <button class="col m-3 btn btn-lg btn-primary" onclick="send_command({ir_target: 'ac', key: 'start'});"><i class="bi-snow"></i></i></button>
                                    </div>
                                </div>`

                    document.getElementById("additional_info").innerHTML = buttons;
                    document.getElementById("additional_info").scrollIntoView();

                } else if (selected.value == "tv") {

                    buttons = `<div class="d-flex flex-column">
                                    <div class="row mx-auto mb-3">
                                        <button class="col m-3 btn btn-lg btn-primary" onclick="send_command({ir_target: 'tv', key: 'power'});"><i class="bi-power"></i></button>
                                        <button class="col m-3 btn btn-lg btn-primary" style="visibility: hidden;"><i class="bi-question"></i></button>
                                        <button class="col m-3 btn btn-lg btn-primary" onclick="send_command({ir_target: 'tv', key: 'source'});"><i class="bi-upload"></i></button>
                                    </div>
                                    <div class="row mx-auto">
                                        <button class="col m-3 btn btn-lg btn-primary" onclick="send_command({ir_target: 'tv', key: 'up'});"><i class="bi bi-arrow-up"></i></button>
                                    </div>
                                    <div class="row mx-auto">
                                        <button class="col m-3 btn btn-lg btn-primary" onclick="send_command({ir_target: 'tv', key: 'left'});"><i class="bi bi-arrow-left"></i></button>
                                        <button class="col m-3 btn btn-lg btn-primary" onclick="send_command({ir_target: 'tv', key: 'enter'});"><i class="bi bi-app"></i></button>
                                        <button class="col m-3 btn btn-lg btn-primary" onclick="send_command({ir_target: 'tv', key: 'right'});"><i class="bi bi-arrow-right"></i></button>
                                    </div>
                                    <div class="row mx-auto mb-3">
                                        <button class="col m-3 btn btn-lg btn-primary" onclick="send_command({ir_target: 'tv', key: 'down'});"><i class="bi bi-arrow-down"></i></button>
                                    </div>
                                    <div class="row mx-auto">
                                        <button class="col m-3 btn btn-lg btn-primary" onclick="send_command({ir_target: 'tv', key: 'vol_down'});"><i class="bi-volume-down-fill"></i></button>
                                        <button class="col m-3 btn btn-lg btn-primary" onclick="send_command({ir_target: 'tv', key: 'mute'});"><i class="bi-volume-mute-fill"></i></button>
                                        <button class="col m-3 btn btn-lg btn-primary" onclick="send_command({ir_target: 'tv', key: 'vol_up'});"><i class="bi-volume-up-fill"></i></button>
                                    </div>
                                    <div class="row mx-auto">
                                        <button class="col m-3 btn btn-lg btn-secondary" onclick="send_command({ir_target: 'tv', key: 'settings'});"><i class="bi-gear-fill"></i></button>
                                        <button class="col m-3 btn btn-lg btn-secondary" style="visibility: hidden;"><i class="bi-question"></i></button>
                                        <button class="col m-3 btn btn-lg btn-secondary" onclick="send_command({ir_target: 'tv', key: 'exit'});"><i class="bi-arrow-return-left"></i></button>
                                    </div>
                                </div>`

                    document.getElementById("additional_info").innerHTML = buttons;
                    document.getElementById("additional_info").scrollIntoView();
                };
            };
        };

        // Triggered by delete button on remove_rule page
        async function delete_rule(selected) {
            // Hide results div (may be present from previous command)
            document.getElementById("result").style.display = "none";

            // Set selected rule timestamp as value of input
            document.getElementById('add_rule_input').value = selected.id;

            // Remove text that may be in rule box (interpreted as add rule if both contain text)
            document.getElementById('rule_input').value = "";

            selected.disabled = true;

            // Send command to delete rule
            submit_form(this);
        };

        // Updates additional_info div contents when number in field changes
        const delay_input_handler = function(e) {
            load_additional_info(document.getElementById("select_target"));

            // Clear results from previous command to avoid confusion
            try { document.getElementById("result").innerHTML = ""; } catch(err) {};
        };

        // Clear results section after any part of form changes to avoid confusion
        document.getElementById('form').addEventListener('change', function(e) {
            try { document.getElementById("result").innerHTML = ""; } catch(err) {};
        });

        // Get new temp+humidity reading every 5 seconds, update div if user currently viewing sensor data
        function queryTempSensor(start) {
            if (start) {
                timer = setInterval(async function() {
                    climate_data = await fetch("/get_climate_data/" + selected_node);
                    climate_data = await climate_data.json();

                    if (selected_command == "temp_sensor") {
                        document.getElementById("additional_info").innerHTML = `<div class="result mx-auto py-1"><table class="table table-borderless"><tr><th class="text-center w-50">Temperature</th><th class="text-center w-50">Humidity</th><tr><td class="text-center">${climate_data["temp"].toFixed(2)}</td><td class="text-center">${climate_data["humid"].toFixed(2)}</td></tr>`;
                    };
                }, 5000);
            } else {
                clearInterval(timer);

                // Clear old data if present
                climate_data = ""
            };
        };

        // Listen for system theme changes, switch to dark/light mode to reflect (responsive)
        window.matchMedia('(prefers-color-scheme: dark)').addListener(function (e) {
            if (e.matches) { // Returns True for dark mode, False otherwise
                document.body.classList.add("dark");
            } else {
                document.body.classList.remove("dark");
            }
        });
    </script>

</body>
</html>
