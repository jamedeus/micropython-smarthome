<div id="{{instance}}-card" class="card">
    <div class="card-body d-flex flex-column">
        <div class="d-flex justify-content-between">
            {# Sensor: Add trigger button #}
            {% if category == "sensor" %}
                <button class="btn btn-outline-secondary trigger-button my-auto me-auto {% if params.condition_met %}trigger-on{% endif %}" id="{{instance}}-trigger" autocomplete="off" onclick="trigger(this)"><i class="bi-exclamation-lg"></i></button>

            {# Device: Add turn on button #}
            {% else %}
                <button class="btn btn-outline-secondary power-button my-auto me-auto {% if params.turned_on %}toggle-on{% endif %}" id="{{instance}}-power-state" autocomplete="off" onclick="power(this)"><i class="bi-lightbulb"></i></button>

            {% endif %}
            <h4 class="card-title mx-auto my-auto" id="{{instance}}-title">{{ params.nickname }}</h4>
            <div class="dropdown ms-auto my-auto">
                <button type="button" class="btn btn-outline-secondary menu-button" id="{{instance}}-menu-button" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi-list"></i></button>
                <ul id="{{instance}}-menu" class="dropdown-menu dropdown-menu-end" aria-labelledby="{{instance}}-menu-button">
                    <li><a id="{{instance}}-enable" class="dropdown-item" onclick="enable_disable_handler(this);">{% if params.enabled %}Disable{% else %}Enable{% endif %}</a></li>
                    <li><a id="{{instance}}-schedule-toggle" class="dropdown-item" onclick="open_schedule_toggle(this);">Schedule Toggle</a></li>
                    <li><a id="{{instance}}-reset" class="dropdown-item" onclick="reset(this);">Reset rule</a></li>
                    {# Sensor: Add show targets option #}
                    {% if category == "sensor" %}
                        <li><a id="{{instance}}-targets" class="dropdown-item" onclick="show_targets(this);">Show targets</a></li>

                    {# Device: Add prompt-specific options if needed #}
                    {% else %}
                        {% if params.prompt == "api_target" %}
                            <li><a id="{{instance}}-current_rule-button" class="dropdown-item" data-target="{{instance}}-current_rule" onclick="open_rule_modal(this);">Change rule</a></li>
                        {% endif %}
                        {% if params.prompt in "int_or_fade" %}
                            <li><a id="{{instance}}-start-fade" class="dropdown-item" onclick="open_fade_modal(this);">Start Fade</a></li>
                        {% endif %}

                    {% endif %}
                    <li><a id="{{instance}}-debug" class="dropdown-item" onclick="debug(this);">Debug</a></li>
                </ul>
            </div>
        </div>

        {# Collapse card if instance disabled #}
        {% if params.enabled %}
            <div class="collapse show" id="{{instance}}-body">
        {% else %}
            <div class="collapse" id="{{instance}}-body">
        {% endif %}

        {# Add rule input based on prompt type #}
        {% if params.prompt == "float_range" %}
            <div class="d-flex flex-row align-items-center mt-4 mb-4 pb-3">
                <button id="{{instance}}-rule-down" class="btn btn-sm me-1" onclick="rule_slider_increment(this);" data-stepsize="0.5"><i class="bi-dash-lg"></i></button>
                <input id="{{instance}}-rule" type="range" class="current-rule-slider mx-auto" min="{{params.min_rule}}" max="{{params.max_rule}}" data-displaymin="{{params.min_rule}}" data-displaymax="{{params.max_rule}}" data-displaytype="float" step="0.5" value="{{params.current_rule}}" autocomplete="off">
                <button id="{{instance}}-rule-up" class="btn btn-sm ms-1" onclick="rule_slider_increment(this);" data-stepsize="0.5"><i class="bi-plus-lg"></i></button>
            </div>

        {% elif params.prompt == "int_or_fade" %}
            <div class="d-flex flex-row align-items-center mt-4 mb-4 pb-3">
                <button id="{{instance}}-rule-down" class="btn btn-sm me-1" onclick="rule_slider_increment(this);" data-stepsize="{% widthratio params.max_rule 100 1|floatformat:"0" %}"><i class="bi-dash-lg"></i></button>
                <input id="{{instance}}-rule" type="range" class="current-rule-slider mx-auto" min="{{params.min_rule}}" max="{{params.max_rule}}" data-displaymin="1" data-displaymax="100" data-displaytype="int" value="{{params.current_rule}}" autocomplete="off">
                <button id="{{instance}}-rule-up" class="btn btn-sm ms-1" onclick="rule_slider_increment(this);" data-stepsize="{% widthratio params.max_rule 100 1|floatformat:"0" %}"><i class="bi-plus-lg"></i></button>
            </div>

        {% elif params.prompt == "api_target" %}
            <div style="display:none;">
                <input id="{{instance}}-current_rule" type="text" autocomplete="off" value="{{params.current_rule}}" onchange="change_api_target_rule(this);">
            </div>

        {% endif %}

        {% if category == "sensor" %}
            {# Disble trigger button for sensors which don't support endpoint #}
            {# TODO this should be configured in metadata to avoid hardcoded types #}
            {% if params.type in "switch, load-cell" %}
                <script>
                    // Disable trigger button (trigger not supported but still need to see state)
                    document.getElementById("{{instance}}-trigger").disabled = true;
                </script>
            {% endif %}
        {% endif %}

        {# Add schedule rules collapse #}
        {% include "api/schedule_rule_section.html" %}
    </div>
</div>
</div></br>
