{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
    <title>{{ context.metadata.id }} - Micropython Smarthome API</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="{% static 'node_configuration/bootstrap.min.css' %}">
    <link rel="stylesheet" href="{% static 'node_configuration/bootstrap-icons.css' %}">
    <link rel="stylesheet" href="{% static 'node_configuration/style.css' %}">
    <link rel="stylesheet" href="{% static 'api/sliders.css' %}">
    <link rel="stylesheet" href="{% static 'api/animations.css' %}">
    {% if context.metadata.ir_blaster == True %}
    <link rel="stylesheet" href="{% static 'api/remote.css' %}">
    {% endif %}
    <script src="{% static 'node_configuration/popper.min.js' %}"></script>
    <script src="{% static 'node_configuration/bootstrap.min.js' %}"></script>
    <script src="{% static 'node_configuration/jquery.min.js' %}"></script>
    <script src="{% static 'api/rangeslider.min.js' %}"></script>

    <script>

        function getCookie(name) {
            var cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                var cookies = document.cookie.split(';');
                for (var i = 0; i < cookies.length; i++) {
                    var cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        };

    </script>
    <style>
        /* Limit width for readability on large screen sizes */
        @media (min-width: 1200px) {
            .container {
                width: 960px;
            }
        }

        /* Block double tap zoom on mobile, allows pressing buttons quickly */
        body {
            touch-action: manipulation;
        }
    </style>
</head>

<body>
    <div class="container">
        {% if context %}

            <div class="d-flex justify-content-between">
                <button type="button" class="btn my-auto" id="back_button" onclick="window.location.href = '/api'"><i class="bi-chevron-left"></i></button>
                <h1 class="my-3">{{context.metadata.id}}</h1>
                <div class="dropdown my-auto">
                    <button type="button" class="btn" id="more_options_button" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi-list"></i></button>
                    <ul id="more_options_menu" class="dropdown-menu dropdown-menu-end" aria-labelledby="more_options_button">
                        <li><a class="dropdown-item" onclick="send_command({'command': 'reboot'});">Reboot</a></li>
                        <li><a class="dropdown-item" onclick="send_command({'command': 'clear_log'});">Clear Log</a></li>
                        <li><a class="dropdown-item" onclick="reset_all_rules();">Reset all rules</a></li>
                    </ul>
                </div>
            </div>

            <!-- Check if user is in dark mode, change theme (runs here to prevent visual flash) -->
            <script>
                if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                    document.body.classList.add("dark");
                    document.getElementById("back_button").classList.add("btn-dark");
                    document.getElementById("more_options_button").classList.add("btn-dark");
                    document.getElementById("more_options_menu").classList.add("dropdown-menu-dark");
                    console.log("Dark mode");
                } else {
                    document.getElementById("back_button").classList.add("btn-light");
                    document.getElementById("more_options_button").classList.add("btn-light");
                };
            </script>

            <div class="row">

<!--      SENSORS      -->
                <div id="sensor-cards" class="col-sm">

                    {% for sensor, params in context.sensors.items %}

                        <div class="card">
                            <div class="card-body d-flex flex-column">
                                <div class="d-flex flex-row">
                                    <h4 class="card-title" id="{{sensor}}-title">{{ params.nickname }}</h4>
                                    <div class="form-check form-switch ms-auto my-auto">
                                        {% if params.enabled %}
                                            <input class="form-check-input" type="checkbox" id="{{sensor}}-enable-toggle" data-bs-toggle="collapse" data-bs-target="#{{sensor}}-body" aria-expanded="false" aria-controls="{{sensor}}-body" autocomplete="off" onchange="enable(this)" checked>
                                        {% else %}
                                            <input class="form-check-input" type="checkbox" id="{{sensor}}-enable-toggle" data-bs-toggle="collapse" data-bs-target="#{{sensor}}-body" aria-expanded="false" aria-controls="{{sensor}}-body" autocomplete="off" onchange="enable(this)">
                                        {% endif %}
                                    </div>
                                </div>

                                {% if params.enabled %}
                                    <div class="collapse show" id="{{sensor}}-body">
                                {% else %}
                                    <div class="collapse" id="{{sensor}}-body">
                                {% endif %}

                                <!-- Trigger button -->
                                {% if params.type in "pir,desktop,dummy" %}
                                    <div>
                                        <!-- TODO backend report trigger state in status obj, display here (like device on/off state) -->
                                        <input type="checkbox" class="btn-check" id="{{sensor}}-trigger" autocomplete="off" onclick="trigger(this)" checked>
                                        <label class="btn btn-sm btn-primary" for="{{sensor}}-trigger" id="{{sensor}}-trigger-label">Trigger</label><br>
                                    </div>
                                {% endif %}
                                <!-- End trigger button -->

                                <!-- Rule slider -->
                                {% if params.type == "pir" %}

                                    <div class="d-flex flex-row align-items-center">
                                        <div class="col-1">
                                            <button id="{{sensor}}-rule-down" class="btn btn-sm btn-outline-secondary" onclick="rule_slider_increment(this);" data-stepsize="1"><i class="bi-dash"></i></button>
                                        </div>
                                        <div class="col-10">
                                            <input id="{{sensor}}-rule" type="range" class="current-rule-slider mx-auto" min="0" max="60" step="0.5" value="{{params.current_rule}}" autocomplete="off">
                                        </div>
                                        <div class="col-1">
                                            <button id="{{sensor}}-rule-up" class="btn btn-sm btn-outline-secondary ms-auto" onclick="rule_slider_increment(this);" data-stepsize="1"><i class="bi-plus"></i></button>
                                        </div>
                                    </div>
                                    <div class="text-center row">
                                        <div id="{{sensor}}-rule-reset" class="text-center mb-3 mt-3 pt-3 reset-button" style="visibility: hidden">
                                            <button class="btn btn-sm btn-secondary" onclick="reset(this)">Reset</button>
                                        </div>
                                    </div>

                                {% elif params.type == "si7021" %}
                                    <table class="table table-borderless">
                                        <tbody>
                                            <tr>
                                                <th class="text-center w-50 pb-0">Temperature</th>
                                                <th class="text-center w-50 pb-0">Humidity</th>
                                            </tr>
                                            <tr>
                                                <td class="text-center fs-5" id="temperature">{{params.temp|floatformat:"2"}}</td>
                                                <td class="text-center fs-5" id="humidity">{{params.humid|floatformat:"2"}}</td>
                                            </tr>
                                        </tbody>
                                    </table>

                                    <!-- Close climate data card, start new card for thermostat -->
                                    </div></div></div></br>

                                    <script>
                                        // Change previous card title to "Climate Data", old title will be reused in new card below
                                        var title = document.getElementById("{{sensor}}-title");
                                        title.innerHTML = "Climate Data";
                                        // Center title
                                        title.parentElement.classList.remove("d-flex");
                                        title.parentElement.classList.remove("flex-row");
                                        title.classList.add("text-center");

                                        // Remove enable/disable toggle, will be replaced in new card below
                                        var toggle = document.getElementById("{{sensor}}-enable-toggle");
                                        toggle.parentElement.remove();

                                    </script>

                                    <div class="card">
                                        <div class="card-body d-flex flex-column">
                                            <div class="d-flex flex-row">
                                                <h4 class="card-title">{{ params.nickname }}</h4>
                                                <div class="form-check form-switch ms-auto my-auto">
                                                    {% if params.enabled %}
                                                        <input class="form-check-input" type="checkbox" id="{{sensor}}-enable-toggle" data-bs-toggle="collapse" data-bs-target="#{{sensor}}-body" aria-expanded="false" aria-controls="{{sensor}}-body" autocomplete="off" onchange="enable(this)" checked>
                                                    {% else %}
                                                        <input class="form-check-input" type="checkbox" id="{{sensor}}-enable-toggle" data-bs-toggle="collapse" data-bs-target="#{{sensor}}-body" aria-expanded="false" aria-controls="{{sensor}}-body" autocomplete="off" onchange="enable(this)">
                                                    {% endif %}
                                                </div>
                                            </div>

                                            {% if params.enabled %}
                                                <div class="collapse show" id="{{sensor}}-body">
                                            {% else %}
                                                <div class="collapse" id="{{sensor}}-body">
                                            {% endif %}

                                            <!-- Range slider -->
                                            <div class="d-flex flex-row align-items-center">
                                                <div class="col-1">
                                                    <button id="{{sensor}}-rule-down" class="btn btn-sm btn-outline-secondary" onclick="rule_slider_increment(this);" data-stepsize="0.5"><i class="bi-dash"></i></button>
                                                </div>
                                                <div class="col-10">
                                                    <input id="{{sensor}}-rule" type="range" class="current-rule-slider mx-auto" min="65" max="80" step="0.1" value="{{params.current_rule}}" autocomplete="off">
                                                </div>
                                                <div class="col-1">
                                                    <button id="{{sensor}}-rule-up" class="btn btn-sm btn-outline-secondary ms-auto" onclick="rule_slider_increment(this);" data-stepsize="0.5"><i class="bi-plus"></i></button>
                                                </div>
                                            </div>
                                            <div class="text-center row">
                                                <div id="{{sensor}}-rule-reset" class="text-center mb-3 mt-3 pt-3 reset-button" style="visibility: hidden">
                                                    <button class="btn btn-sm btn-secondary" onclick="reset(this)">Reset</button>
                                                </div>
                                            </div>

                                {% endif %}
                                <!-- End rule slider -->

                                <!-- Schedule rules section, collapsed by default -->
                                <p class="text-center">
                                    <button class="btn btn-sm btn-primary" type="button" data-bs-toggle="collapse" data-bs-target="#{{sensor}}-schedule-rules" aria-expanded="false" aria-controls="{{sensor}}-schedule-rules">
                                        Schedule rules
                                    </button>
                                </p>
                                <div class="collapse" id="{{sensor}}-schedule-rules">

                                    <table id="{{sensor}}-rules" class="table table-borderless">
                                        <tr>
                                            <th style="text-align: left;">Time</th>
                                            <th style="text-align: left;">Rule</th>
                                        </tr>

                                        {% if params.schedule.items|length > 0 %}
                                            {% for time, rule in params.schedule.items %}
                                                <tr id="{{sensor}}-row-{{forloop.counter}}">
                                                    <td><input type="time" class="form-control schedule-rule" id="schedule-{{sensor}}-rule{{forloop.counter}}-time" placeholder="HH:MM" name="schedule-{{sensor}}-rule{{forloop.counter}}-time" value="{{ time }}" data-original="{{ time }}" data-bs-toggle="tooltip" data-bs-trigger="manual" title="Rule at this time already exists" autocomplete="off"></td>
                                                    <td><input type="text" class="form-control schedule-rule" id="schedule-{{sensor}}-rule{{forloop.counter}}-value" placeholder="" name="schedule-{{sensor}}-rule{{forloop.counter}}-value" value="{{ rule }}" data-original="{{ rule }}" data-bs-toggle="tooltip" data-bs-trigger="manual" title="Invalid rule" autocomplete="off"></td>
                                                    <td class="min"><button type="button" class="remove btn btn-sm btn-danger mt-1" id="{{sensor}}-remove{{forloop.counter}}"  onclick="delete_rule(this)"><i class="bi-trash"></i></button></td>
                                                </tr>
                                            {% endfor %}
                                        {% else %}
                                            <tr id="{{sensor}}-row-1">
                                                <td><input type="time" class="form-control" id="schedule-{{sensor}}-rule1-time" placeholder="HH:MM" name="schedule-{{sensor}}-rule1-time" data-bs-toggle="tooltip" data-bs-trigger="manual" title="Rule at this time already exists"></td>
                                                <td><input type="text" class="form-control" id="schedule-{{sensor}}-rule1-value" placeholder="" name="schedule-{{sensor}}-rule1-value" data-bs-toggle="tooltip" data-bs-trigger="manual" title="Invalid rule"></td>
                                                <td class="min"><button type="button" class="remove btn btn-sm btn-success mt-1" id="{{sensor}}-add1" onclick="add_rule(this)"><i class="bi-plus-lg"></i></button></td>
                                            </tr>
                                        {% endif %}
                                    </table>

                                    <div class="text-center mx-3 mb-3">
                                        <button type="button" class="btn btn-secondary btn-sm add" id="{{sensor}}-add-rule" onclick="add_rule_row(this)"><i class="bi-plus-lg"></i></button>
                                    </div>

                                    <!-- If no rules exist, hide add rule button (blank row above already has add button) -->
                                    {% if params.schedule.items|length == 0 %}
                                        <script>
                                            document.getElementById("{{sensor}}-add-rule").style.display = "none";
                                        </script>
                                    {% endif %}

                                </div>
                                <!-- End schedule rules section -->
                            </div>
                        </div>
                        </div></br>
                    {% endfor %}
                </div>

<!--      DEVICES      -->
                <div id="device-cards" class="col-sm">

                    {% for device, params in context.devices.items %}

                        <div class="card">
                            <div class="card-body d-flex flex-column">
                                <div class="d-flex flex-row">
                                    <h4 class="card-title" id="{{device}}-title">{{ params.nickname }}</h4>
                                    <div class="form-check form-switch ms-auto my-auto">
                                        {% if params.enabled %}
                                            <input class="form-check-input" type="checkbox" id="{{device}}-enable-toggle" data-bs-toggle="collapse" data-bs-target="#{{device}}-body" aria-expanded="false" aria-controls="{{device}}-body" autocomplete="off" onchange="enable(this)" checked>
                                        {% else %}
                                            <input class="form-check-input" type="checkbox" id="{{device}}-enable-toggle" data-bs-toggle="collapse" data-bs-target="#{{device}}-body" aria-expanded="false" aria-controls="{{device}}-body" autocomplete="off" onchange="enable(this)">
                                        {% endif %}
                                    </div>
                                </div>

                                {% if params.enabled %}
                                    <div class="collapse show" id="{{device}}-body">
                                {% else %}
                                    <div class="collapse" id="{{device}}-body">
                                {% endif %}

                                <!-- Power toggle button -->
                                <div class="text-center mb-3">
                                    {% if params.turned_on %}
                                        <button class="btn power-toggle toggle-on" id="{{device}}-power-state" autocomplete="off" onclick="power(this)"><i class="bi-lightbulb"></i></button>
                                    {% else %}
                                        <button class="btn power-toggle" id="{{device}}-power-state" autocomplete="off" onclick="power(this)"><i class="bi-lightbulb"></i></button>
                                    {% endif %}
                                </div>

                                <!-- Rule slider -->
                                {% if params.type in "dimmer,bulb" %}

                                    <div class="d-flex flex-row align-items-center">
                                        <div class="col-1">
                                            <button id="{{device}}-rule-down" class="btn btn-sm btn-outline-secondary" onclick="rule_slider_increment(this);" data-stepsize="1"><i class="bi-dash"></i></button>
                                        </div>
                                        <div class="col-10">
                                            <input id="{{device}}-rule" type="range" class="current-rule-slider mx-auto" min="1" max="100" value="{{params.current_rule}}" autocomplete="off">
                                        </div>
                                        <div class="col-1">
                                            <button id="{{device}}-rule-up" class="btn btn-sm btn-outline-secondary ms-auto" onclick="rule_slider_increment(this);" data-stepsize="1"><i class="bi-plus"></i></button>
                                        </div>
                                    </div>
                                    <div class="text-center row">
                                        <div id="{{device}}-rule-reset" class="text-center mb-3 mt-3 pt-3 reset-button" style="visibility: hidden">
                                            <button class="btn btn-sm btn-secondary" onclick="reset(this)">Reset</button>
                                        </div>
                                    </div>

                                {% elif params.type == "pwm" %}

                                    <div class="d-flex flex-row align-items-center">
                                        <div class="col-1">
                                            <button id="{{device}}-rule-down" class="btn btn-sm btn-outline-secondary" onclick="rule_slider_increment(this);" data-stepsize="8"><i class="bi-dash"></i></button>
                                        </div>
                                        <div class="col-10">
                                            <input id="{{device}}-rule" type="range" class="current-rule-slider mx-auto" min="0" max="1023" value="{{params.current_rule}}" autocomplete="off">
                                        </div>
                                        <div class="col-1">
                                            <button id="{{device}}-rule-up" class="btn btn-sm btn-outline-secondary ms-auto" onclick="rule_slider_increment(this);" data-stepsize="8"><i class="bi-plus"></i></button>
                                        </div>
                                    </div>
                                    <div class="text-center row">
                                        <div id="{{device}}-rule-reset" class="text-center mb-3 mt-3 pt-3 reset-button" style="visibility: hidden">
                                            <button class="btn btn-sm btn-secondary" onclick="reset(this)">Reset</button>
                                        </div>
                                    </div>

                                {% endif %}

                                <!-- End rule slider -->

                                <!-- Schedule rules section, collapsed by default -->
                                <p class="text-center">
                                    <button class="btn btn-sm btn-primary" type="button" data-bs-toggle="collapse" data-bs-target="#{{device}}-schedule-rules" aria-expanded="false" aria-controls="{{device}}-schedule-rules">
                                        Schedule rules
                                    </button>
                                </p>
                                <div class="collapse" id="{{device}}-schedule-rules">

                                    <table id="{{device}}-rules" class="table table-borderless">
                                        <tr>
                                            <th style="text-align: left;">Time</th>
                                            <th style="text-align: left;">Rule</th>
                                        </tr>

                                        {% if params.schedule.items|length > 0 %}
                                            {% for time, rule in params.schedule.items %}
                                                <tr id="{{device}}-row-{{forloop.counter}}">
                                                    <td><input type="time" class="form-control schedule-rule" id="schedule-{{device}}-rule{{forloop.counter}}-time" placeholder="HH:MM" name="schedule-{{device}}-rule{{forloop.counter}}-time" value="{{ time }}" data-original="{{ time }}" data-bs-toggle="tooltip" data-bs-trigger="manual" title="Rule at this time already exists" autocomplete="off"></td>
                                                    <td><input type="text" class="form-control schedule-rule" id="schedule-{{device}}-rule{{forloop.counter}}-value" placeholder="" name="schedule-{{device}}-rule{{forloop.counter}}-value" value="{{ rule }}" data-original="{{ rule }}" data-bs-toggle="tooltip" data-bs-trigger="manual" title="Invalid rule" autocomplete="off"></td>
                                                    <td class="min"><button type="button" class="remove btn btn-sm btn-danger mt-1" id="{{device}}-remove{{forloop.counter}}"  onclick="delete_rule(this)"><i class="bi-trash"></i></button></td>
                                                </tr>
                                            {% endfor %}
                                        {% else %}
                                            <tr id="{{device}}-row-1">
                                                <td><input type="time" class="form-control" id="schedule-{{device}}-rule1-time" placeholder="HH:MM" name="schedule-{{device}}-rule1-time" data-bs-toggle="tooltip" data-bs-trigger="manual" title="Rule at this time already exists"></td>
                                                <td><input type="text" class="form-control" id="schedule-{{device}}-rule1-value" placeholder="" name="schedule-{{device}}-rule1-value" data-bs-toggle="tooltip" data-bs-trigger="manual" title="Invalid rule"></td>
                                                <td class="min"><button type="button" class="remove btn btn-sm btn-success mt-1" id="{{device}}-add1" onclick="add_rule(this)"><i class="bi-plus-lg"></i></button></td>
                                            </tr>
                                        {% endif %}
                                    </table>

                                    <div class="text-center mx-3 mb-3">
                                        <button type="button" class="btn btn-secondary btn-sm add" id="{{device}}-add-rule" onclick="add_rule_row(this)"><i class="bi-plus-lg"></i></button>
                                    </div>

                                    <!-- If no rules exist, hide add rule button (blank row above already has add button) -->
                                    {% if params.schedule.items|length == 0 %}
                                        <script>
                                            document.getElementById("{{device}}-add-rule").style.display = "none";
                                        </script>
                                    {% endif %}

                                </div>
                                <!-- End schedule rules section -->

                                </div>

                            </div>
                        </div></br>

                    {% endfor %}

                    {% if context.metadata.ir_blaster == True %}

                        {% if context.sensors|length == 0 and context.devices|length == 0 %}
                            <!-- If target node ONLY has IR blaster, close device column, start new column for remotes -->
                            </div>
                            <div id="remote-cards">
                        {% endif %}

                        <div class="d-flex flex-column pb-4">
                            <div class="row text-center remote remote-top mx-auto" style="position: relative;">
                                <!-- Title is narrower than body due to mx-auto - add invisible buttons to reserve correct width -->
                                <button class="col m-3 btn btn-lg btn-primary" type="button" style="visibility: hidden;height: 0px;"><i class="bi-question"></i></button>
                                <button class="col m-3 btn btn-lg btn-primary" type="button" style="visibility: hidden;height: 0px;"><i class="bi-question"></i></button>
                                <button class="col m-3 btn btn-lg btn-primary" type="button" style="visibility: hidden;height: 0px;"><i class="bi-question"></i></button>
                                <!-- Position title on top of invisible buttons -->
                                <h4 class="mt-2" style="position: absolute;align: center;">TV Remote</h4>
                            </div>
                            <div class="row pb-3 remote mx-auto" id="width-test" style="position: relative;">
                                <button class="col m-3 btn btn-lg btn-primary" type="button" onclick="send_command({'command': 'ir', 'ir_target': 'tv', 'key': 'power'});" title="Power"><i class="bi-power"></i></button>
                                <button class="col m-3 btn btn-lg btn-primary" type="button" style="visibility: hidden;"><i class="bi-question"></i></button>
                                <button class="col m-3 btn btn-lg btn-primary" type="button" onclick="send_command({'command': 'ir', 'ir_target': 'tv', 'key': 'source'});" title="Source"><i class="bi-upload"></i></button>
                            </div>
                            <div class="row remote mx-auto" style="width: auto;">
                                <button class="col m-3 btn btn-lg btn-primary" type="button" style="visibility: hidden;"><i class="bi-question"></i></button>
                                <button class="col m-3 btn btn-lg btn-primary" type="button" onclick="send_command({'command': 'ir', 'ir_target': 'tv', 'key': 'up'});" title="Up"><i class="bi bi-arrow-up"></i></button>
                                <button class="col m-3 btn btn-lg btn-primary" type="button" style="visibility: hidden;"><i class="bi-question"></i></button>
                            </div>
                            <div class="row remote mx-auto" style="width: auto;">
                                <button class="col m-3 btn btn-lg btn-primary" type="button" onclick="send_command({'command': 'ir', 'ir_target': 'tv', 'key': 'left'});" title="Left"><i class="bi bi-arrow-left"></i></button>
                                <button class="col m-3 btn btn-lg btn-primary" type="button" onclick="send_command({'command': 'ir', 'ir_target': 'tv', 'key': 'enter'});" title="Enter"><i class="bi bi-app"></i></button>
                                <button class="col m-3 btn btn-lg btn-primary" type="button" onclick="send_command({'command': 'ir', 'ir_target': 'tv', 'key': 'right'});" title="right"><i class="bi bi-arrow-right"></i></button>
                            </div>
                            <div class="row pb-3 remote mx-auto" style="width: auto;">
                                <button class="col m-3 btn btn-lg btn-primary" type="button" style="visibility: hidden;"><i class="bi-question"></i></button>
                                <button class="col m-3 btn btn-lg btn-primary" type="button" onclick="send_command({'command': 'ir', 'ir_target': 'tv', 'key': 'down'});" title="Down"><i class="bi bi-arrow-down"></i></button>
                                <button class="col m-3 btn btn-lg btn-primary" type="button" style="visibility: hidden;"><i class="bi-question"></i></button>
                            </div>
                            <div class="row remote mx-auto" style="width: auto;">
                                <button class="col m-3 btn btn-lg btn-primary" type="button" onclick="send_command({'command': 'ir', 'ir_target': 'tv', 'key': 'vol_down'});" title="Volume Down"><i class="bi-volume-down-fill"></i></button>
                                <button class="col m-3 btn btn-lg btn-primary" type="button" onclick="send_command({'command': 'ir', 'ir_target': 'tv', 'key': 'mute'});" title="Mute"><i class="bi-volume-mute-fill"></i></button>
                                <button class="col m-3 btn btn-lg btn-primary" type="button" onclick="send_command({'command': 'ir', 'ir_target': 'tv', 'key': 'vol_up'});" title="Volume Up"><i class="bi-volume-up-fill"></i></button>
                            </div>
                            <div class="row remote remote-bottom mx-auto" style="width: auto;">
                                <button class="col m-3 btn btn-lg btn-secondary" type="button" onclick="send_command({'command': 'ir', 'ir_target': 'tv', 'key': 'settings'});" title="Settings"><i class="bi-gear-fill"></i></button>
                                <button class="col m-3 btn btn-lg btn-secondary" type="button" style="visibility: hidden;"><i class="bi-question"></i></button>
                                <button class="col m-3 btn btn-lg btn-secondary" type="button" onclick="send_command({'command': 'ir', 'ir_target': 'tv', 'key': 'exit'});" title="Exit"><i class="bi-arrow-return-left"></i></button>
                            </div>
                        </div>

                        <div class="d-flex flex-column" style="width: auto;">
                            <div class="row text-center remote remote-top mx-auto" style="position: relative;">
                                <!-- Title is narrower than body due to mx-auto - add invisible buttons to reserve correct width -->
                                <button class="col m-3 btn btn-lg btn-primary" type="button" style="visibility: hidden;height: 1px;"><i class="bi-question"></i></button>
                                <button class="col m-3 btn btn-lg btn-primary" type="button" style="visibility: hidden;height: 1px;"><i class="bi-question"></i></button>
                                <button class="col m-3 btn btn-lg btn-primary" type="button" style="visibility: hidden;height: 1px;"><i class="bi-question"></i></button>
                                <!-- Position title on top of invisible buttons -->
                                <h4 class="mt-2" style="position: absolute;align: center;">AC Remote</h4>
                            </div>
                            <div class="row mb-3 py-2 remote remote-bottom mx-auto">
                                <button class="col m-3 btn btn-lg btn-primary" type="button" onclick="send_command({'command': 'ir', 'ir_target': 'ac', 'key': 'stop'});" title="Stop cooling"><i class="bi-wind"></i></button>
                                <button class="col m-3 btn btn-lg btn-primary" type="button" onclick="send_command({'command': 'ir', 'ir_target': 'ac', 'key': 'off'});" title="Turn off fan"><i class="bi-x-octagon-fill"></i></button>
                                <button class="col m-3 btn btn-lg btn-primary" type="button" onclick="send_command({'command': 'ir', 'ir_target': 'ac', 'key': 'start'});" title="Start cooling"><i class="bi-snow"></i></i></button>
                            </div>
                        </div>
                    {% endif %}
                </div>
            </div>

        {% else %}
            <p>FATAL ERROR</p>
        {% endif %}
    </div>

    <!-- Error modal displayed when unable to connect to target node -->

    <div class="modal fade" id="error-modal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered" >
            <div class="modal-content">
                <div class="modal-header pb-0" style="border-bottom: 0px;">
                    <h3 class="mx-auto mb-0" id="error-modal-title">Connection Error</h3>
                </div>
                <div class="modal-body" id="error-modal-body">
                    <p class="text-center mb-0">Attempting to reestablish connection...</p>
                    <div class="d-flex justify-content-center">
                        <div id="spinner" class="loading-animation loading-animation-show"><div></div><div></div><div></div><div></div></div>
                    </div>
                    <div class="d-flex justify-content-center">
                        <button type="button" id="ok-button" class="btn btn-success" data-bs-dismiss="modal" onclick="window.location.href = '/api'">Back to Overview</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Save context for later use -->
    {{ context|json_script:"context" }}

    <script>
        const target_node = "{{ context.metadata.id }}";

        var target_node_status = JSON.parse(document.getElementById("context").textContent);

        // Initial value, used to detect change (lose connection, re-establish connection)
        selected_node_unreachable = false;

        // Prevent multiple functions modifying status object at the same time
        var status_lock = false;

        // Initialize all range sliders, add listeners
        for (slider of $('input[type="range"]')) {
            // Initialize
            $('#' + slider.id).rangeslider({
                polyfill: false,
                onInit: function() {
                // Select handle element closest to slider, update displayed rule
                $handle = $('.rangeslider__handle', this.$range);
                $handle[0].textContent = this.value;

                this.$range[0].classList.add("mx-auto")
                }
            });

            // Update current rule displayed while slider moves
            $('#' + slider.id).on('input', function(e) {
                // Select handle element closest to slider, update displayed rule
                var $handle = $('.rangeslider__handle', e.target.nextSibling);
                $handle[0].textContent = this.value;
            });

            // Runs once when user releases click on slider
            $('#' + slider.id).on('change', async function(e) {
                const id = e.target.id.split("-")[0];
                // Device or sensor
                const category = id.replace(/[0-9]/g, '') + "s";

                const new_rule = this.value;
                const scheduled = target_node_status[category][id]["scheduled_rule"];

                // Show reset button if new rule differs from scheduled, otherwise hide reset button
                if (new_rule != scheduled) {
                    document.getElementById(id + "-rule-reset").style.visibility = "visible";
                } else {
                    document.getElementById(id + "-rule-reset").style.visibility = "hidden";
                };

                console.log(`${id}: new rule = ${new_rule}, type = ${typeof(new_rule)}`)

                // Fire API command
                var result = await send_command({'command': 'set_rule', 'instance': id, 'rule': new_rule});
                result = await result.json();
            });
        };

        // Receives command parameters in value
        async function send_command(value) {
            // Add target and selected command to request body
            value["target"] = target_node

            let csrftoken = getCookie('csrftoken');

            var result = await fetch('/send_command', {
                method: 'POST',
                body: JSON.stringify(value),
                headers: { 'Accept': 'application/json, text/plain, */*',
                    'Content-Type': 'application/json',
                    "X-CSRFToken": csrftoken }
            });

            return result
        };

        // Show reset button if current rule differs from scheduled
        for (slider of document.getElementsByClassName("current-rule-slider")) {
            const id = slider.id.split("-")[0];
            // Device or sensor
            const category = id.replace(/[0-9]/g, '') + "s";

            // Used in listeners below
            const rule = slider.value;
            const scheduled = target_node_status[category][id]["scheduled_rule"];

            // If current rule != scheduled rule, show reset button
            if (rule != scheduled) {
                document.getElementById(id + "-rule-reset").style.visibility = "visible";
            };
        };

        // Handler for current_rule reset button
        async function reset(el) {
            const target = el.parentElement.id.split("-")[0];
            // Device or sensor
            const category = target.replace(/[0-9]/g, '') + "s";

            var result = await send_command({'command': 'reset_rule', 'instance': target});
            result = await result.json();

            if (JSON.stringify(result).startsWith('{"ERROR')) {
                console.log(`Failed to reset ${target} rule`);
            } else {
                // Update current rule
                const scheduled = target_node_status[category][target]["scheduled_rule"];

                // Update slider position
                const slider = document.getElementById(target + "-rule");
                slider.value = scheduled
                $('input[type="range"]').rangeslider('update', true);

                // Select handle element closest to slider, update current rule displayed
                var $handle = $('.rangeslider__handle', document.getElementById(target + '-rule').nextSibling);
                $handle[0].textContent = document.getElementById(target + '-rule').value;

                // Hide reset button
                document.getElementById(target + "-rule-reset").style.visibility = "hidden";
            };
        };

        // Handler for rule slider plus and minus buttons
        async function rule_slider_increment(button) {
            const target = button.id.split("-")[0];
            // Device or sensor
            const category = target.replace(/[0-9]/g, '') + "s";

            const current = parseFloat(document.getElementById(`${target}-rule`).value);
            const scheduled = target_node_status[category][target]["scheduled_rule"];

            if (button.id.split("-")[2] == "up") {
                var new_rule = current + parseFloat(button.dataset.stepsize);
            } else {
                var new_rule = current - parseFloat(button.dataset.stepsize);
            };

            // Update slider position
            document.getElementById(`${target}-rule`).value = new_rule;
            $('input[type="range"]').rangeslider('update', true);
            // Select handle element closest to slider, update current rule displayed
            var $handle = $('.rangeslider__handle', document.getElementById(target + '-rule').nextSibling);
            $handle[0].textContent = document.getElementById(target + '-rule').value;

            // Show reset button if new rule differs from scheduled, otherwise hide reset button
            if (new_rule != scheduled) {
                document.getElementById(target + "-rule-reset").style.visibility = "visible";
            } else {
                document.getElementById(target + "-rule-reset").style.visibility = "hidden";
            };

            // Fire API command
            var result = await send_command({'command': 'set_rule', 'instance': target, 'rule': new_rule.toString()});
            result = await result.json();
        };

        // Click all visible reset buttons
        function reset_all_rules() {
            for (button of document.getElementsByClassName("reset-button")) {
                if (button.style.visibility == "visible") {
                    button.children[0].click();
                }
            };
        };

        // Handler for device enable/disable toggle
        async function enable(el) {
            const target = el.id.split("-")[0];

            if (el.checked) {
                console.log(`Enabling ${target}`);
                var result = await send_command({'command': 'enable', 'instance': target, 'delay_input': ''});
            } else {
                console.log(`Disabling ${target}`);
                var result = await send_command({'command': 'disable', 'instance': target, 'delay_input': ''});
            };

            result = await result.json();
            if (JSON.stringify(result).startsWith('{"ERROR')) {
                // Command failed
                if (el.checked) {
                    alert(`Failed to enable ${target}`);
                    // Move toggle back, collapse card
                    document.getElementById(target + "-enable-toggle").checked = false;
                    $('#' + target + '-body').collapse('hide')
                } else {
                    alert(`Failed to disable ${target}`);
                    // Move toggle back, expand card
                    document.getElementById(target + "-enable-toggle").checked = true;
                    // TODO figure out why collapse('show') doesn't work. Temporary workaround (no animation) below
//                     $('#' + target + '-body').collapse('show')
                    var card = document.getElementById(target + "-body").classList.add('show');
                };
            };
        };

        // Handler for device power on/off toggle
        async function power(el) {
            const target = el.id.split("-")[0];

            if (el.classList.contains("toggle-on")) {
                // Fade button back to on appearance
                el.classList.remove("toggle-on");
                el.classList.add("toggle-off");

                var result = await send_command({'command': 'turn_off', 'instance': target});
                result = await result.json();

                // If send failed, fade button back to off appearance
                if (JSON.stringify(result).startsWith('{"ERROR')) {
                    console.log(`Failed to turn off ${target}`);
                    el.classList.remove("toggle-off");
                    el.classList.add("toggle-on");
                };

            } else {
                // Fade button back to off appearance
                el.classList.remove("toggle-off");
                el.classList.add("toggle-on");

                var result = await send_command({'command': 'turn_on', 'instance': target});
                result = await result.json();

                // If send failed, fade button back to on appearance
                if (JSON.stringify(result).startsWith('{"ERROR')) {
                    console.log(`Failed to turn on ${target}`);
                    el.classList.remove("toggle-on");
                    el.classList.add("toggle-off");
                };

            };
        };

        async function trigger(el) {
            const target = el.id.split("-")[0];

            var result = await send_command({'command': 'trigger_sensor', 'instance': target});
            result = await result.json();

                if (JSON.stringify(result).startsWith('{"ERROR')) {
                    console.log(`Failed to trigger ${target}`);
                } else {
                    // Update page contents immediately after triggering (sensor probably turned targets on)
                    updateStatusObject();
                };
        };

        // Handler for delete button in schedule rules dropdown
        // Removes row from table after deleting rule unless called with remove=false
        async function delete_rule(selected, remove=true) {
            // Prevent user submitting multiple times
            selected.disabled = true;

            // Get target device/sensor
            const target = selected.id.split("-")[0];

            // Get rule number
            const rule = selected.id.split("-")[1].replace(/[a-z]/g, '')

            // Get timestamp
            // Uses dataset.original instead of .value to allow editing existing rules (old needs to be deleted before adding new, see add_rule() below)
            // While delete button is visible to user, dataset.original and .value are always identical (changes to add button when different)
            const timestamp = document.getElementById(`schedule-${target}-rule${rule}-time`).dataset.original;

            // Send command
            var result = await send_command({'command': 'remove_rule', 'instance': target, 'rule': timestamp});
            result = await result.json();

            if (JSON.stringify(result).startsWith('{"ERROR')) {
                // Re-enable button if failed to delete
                alert(JSON.stringify(result));
                selected.disabled = false;
            } else if (remove) {
                // Delete row if success
                document.getElementById(selected.id).parentElement.parentElement.remove();

                // Check if deleted rule was last rule
                if (document.getElementById(target + "-rules").rows.length == 1) {
                    // If no rules remain, add blank row
                    var template = `<tr id="${target}-row-1">
                                        <td><input type="time" class="form-control" id="schedule-${target}-rule1-time" placeholder="HH:MM" name="schedule-${target}-rule1-time"></td>
                                        <td><input type="text" class="form-control" id="schedule-${target}-rule1-value" placeholder="" name="schedule-${target}-rule1-value"></td>
                                        <td class="min"><button type="button" class="remove btn btn-sm btn-success mt-1" id="${target}-add1" onclick="add_rule(this)"><i class="bi-plus-lg"></i></button></td>
                                    </tr>`

                    document.getElementById(target + "-rules").insertAdjacentHTML('beforeend', template);

                    // Hide add row button
                    document.getElementById(target + "-add-rule").style.display = "none";
                };
            };
        };

        // Get array of schedule rule input tooltips (used to show help messages when invalid rule entered, not shown on hover)
        var schedule_rule_tooltips = {};
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
        for (i in tooltipTriggerList) {
            // Add with element ID as key, tooltip as value
            schedule_rule_tooltips[tooltipTriggerList[i].id] = new bootstrap.Tooltip(tooltipTriggerList[i]);
        };

        // Tooltip stays visible until user hovers or selects field
        function hide_tooltip(e) {
            schedule_rule_tooltips[e.target.id].hide();
        };

        // Add listeners to hide tooltip on hover/select
        for (id in schedule_rule_tooltips) {
            document.getElementById(id).addEventListener("mouseover", hide_tooltip);
            document.getElementById(id).addEventListener("focus", hide_tooltip);
        };

        async function add_rule_row(el) {
            // Get target device/sensor
            const target = el.id.split("-")[0];

            // Get new row number
            const table = document.getElementById(target + "-rules");
            const row = parseInt(table.rows[table.rows.length-1].id.split("-")[2]) + 1

            // Add row number + target id to empty row template
            var template = `<tr id="${target}-row-${row}">
                                <td><input type="time" class="form-control" id="schedule-${target}-rule${row}-time" placeholder="HH:MM" name="schedule-${target}-rule${row}-time" data-bs-toggle="tooltip" data-bs-trigger="manual" title="Rule at this time already exists"></td>
                                <td><input type="text" class="form-control" id="schedule-${target}-rule${row}-value" placeholder="" name="schedule-${target}-rule${row}-value" data-bs-toggle="tooltip" data-bs-trigger="manual" title="Invalid rule"></td>
                                <td class="min"><button type="button" class="remove btn btn-sm btn-success mt-1" id="${target}-add${row}" onclick="add_rule(this)"><i class="bi-plus-lg"></i></button></td>
                            </tr>`

            // Add new empty rows
            document.getElementById(target + "-rules").insertAdjacentHTML('beforeend', template);

            // Add tooltips (used for help messages when invalid rule entered)
            schedule_rule_tooltips[`schedule-${target}-rule${row}-time`] = new bootstrap.Tooltip(document.getElementById(`schedule-${target}-rule${row}-time`));
            schedule_rule_tooltips[`schedule-${target}-rule${row}-value`] = new bootstrap.Tooltip(document.getElementById(`schedule-${target}-rule${row}-value`));

            // Add listener to dismiss tooltips on hover/select
            document.getElementById(`schedule-${target}-rule${row}-time`).addEventListener("mouseover", hide_tooltip);
            document.getElementById(`schedule-${target}-rule${row}-time`).addEventListener("focus", hide_tooltip);
            document.getElementById(`schedule-${target}-rule${row}-value`).addEventListener("mouseover", hide_tooltip);
            document.getElementById(`schedule-${target}-rule${row}-value`).addEventListener("focus", hide_tooltip);

            // Focus time field
            document.getElementById(`schedule-${target}-rule${row}-time`).focus();

            // Hide add rule button (will be un-hidden when user finishes adding this rule)
            document.getElementById(target + "-add-rule").style.display = "none"
        };

        function disable_row(row, disable) {
            if (disable) {
                for (field of row.children) {
                    field.children[0].disabled = true;
                };
            } else {
                for (field of row.children) {
                    field.children[0].disabled = false;
                };
            };
        };

        // Handler for add button in schedule rules dropdown, used to create new rules and edit existing
        async function add_rule(el) {
            // Get target device/sensor
            const target = el.id.split("-")[0];

            // Get rule number
            const num = el.id.split("add")[1];

            // Disable row fields + button (prevent user submitting multiple times)
            row = document.getElementById(target + "-row-" + num);
            disable_row(row, true);

            // Get timestamp input
            const timestamp = document.getElementById(`schedule-${target}-rule${num}-time`);

            // Get rule input
            const rule = document.getElementById(`schedule-${target}-rule${num}-value`);

            // Do not add incomplete rule
            if (timestamp.value.length == 0 || rule.value.length == 0) {
                el.disabled = false;
                return;
            };

            // Prevent other functions modifying status object until finished adding rule
            // Otherwise if user clicked add after monitoring function got new status, but before it overwrote old, changes made below may be overwritten
            status_lock = true;

            // If user modified an existing rule without changing timestamp, add overwrite arg
            if (timestamp.dataset.original == timestamp.value) {
                var result = await send_command({'command': 'add_rule', 'instance': target, 'time': timestamp.value, 'rule': rule.value, 'overwrite': 'overwrite'});
                result = await result.json();
            } else {
                var result = await send_command({'command': 'add_rule', 'instance': target, 'time': timestamp.value, 'rule': rule.value});
                result = await result.json();
            };

            if (JSON.stringify(result).startsWith('{"ERROR":"Rule already exists')) {
                // Re-enable row inputs and button
                disable_row(row, false);

                // Focus field with invalid param
                timestamp.focus();

                // Show tooltip
                schedule_rule_tooltips[timestamp.id].show();

            } else if (JSON.stringify(result) == '{"ERROR":"Invalid rule"}') {
                // Re-enable row inputs and button
                disable_row(row, false);

                // Focus field with invalid param
                rule.focus();

                // Show tooltip
                schedule_rule_tooltips[rule.id].show();

            } else if (JSON.stringify(result).startsWith('{"ERROR')) {
                // All other errors (unable to connect etc.)
                alert(JSON.stringify(result));

                // Re-enable row inputs and button
                disable_row(row, false);

            } else {
                // Add to current status object (prevent duplicate being created when new status object containing this rule is received)
                target_node_status[target.replace(/[0-9]/g, '') + "s"][target]["schedule"][timestamp.value] = rule.value;

                // If successfully added, change add button to delete button, re-enable
                el.classList.remove("btn-success");
                el.classList.add("btn-danger");
                el.innerHTML = "<i class='bi-trash'></i>";
                el.id = el.id.replace("add", "remove");
                el.setAttribute( "onClick", "delete_rule(this);" );

                // If user modified existing rule's timestamp, delete rule with old timestamp
                if (timestamp.dataset.original && timestamp.value != timestamp.dataset.original) {
                    delete_rule(document.getElementById(target + "-remove" + num), false);
                };

                // Replace original values with new values (used to detect change after adding)
                timestamp.dataset.original = timestamp.value;
                rule.dataset.original = rule.value;

                // Allow overwriting
                status_lock = false;

                // Add listeners, changes delete button to add button if user modifies fields (newly added rows don't have listener until add button clicked)
                timestamp.addEventListener("input", schedule_rule_field_handler);
                rule.addEventListener("input", schedule_rule_field_handler);

                // Unhide add rule button so user can continue adding rules if needed
                document.getElementById(target + "-add-rule").style.display = "initial"

                // Re-enable row inputs and button
                disable_row(row, false);
            };
        };

        // Runs when user changes schedule rule fields
        // Existing rules: Delete button changes to add button
        // Modified rules: If changed back to original value, add button reverts back to delete
        function schedule_rule_field_handler(e) {
            const id = e.target.id.split("-")[1];
            const row = e.target.id.split("-")[2].replace("rule", "");
            const time_field = document.getElementById(`schedule-${id}-rule${row}-time`);
            const rule_field = document.getElementById(`schedule-${id}-rule${row}-value`);

            // Function runs on each keystroke, only need to change button once on first change
            // Subsequent changes will throw error when getting button element (ID changed first time)
            try {
                // If user changed an existing rule, replace Delete button with Add button
                if (time_field.value != time_field.dataset.original || rule_field.value != rule_field.dataset.original) {

                    var button = document.getElementById(id + "-remove" + row);

                    // Change to Add button
                    button.classList.remove("btn-danger");
                    button.classList.add("btn-success");
                    button.innerHTML = "<i class='bi-plus-lg'>";
                    button.id = button.id.replace("remove", "add");
                    button.setAttribute( "onClick", "add_rule(this);" );

                // If user modified a rule and then reverted changes, replace Add button with Delete button
                } else {

                    var button = document.getElementById(id + "-add" + row);

                    // Change back to Delete button
                    button.classList.remove("btn-success");
                    button.classList.add("btn-danger");
                    button.innerHTML = "<i class='bi-trash'></i>";
                    button.id = button.id.replace("add", "remove");
                    button.setAttribute( "onClick", "delete_rule(this);" );

                };
            } catch(err) {};
        };

        // Add listeners to existing schedule rule fields, if modified change delete button to upload button
        for (field of document.getElementsByClassName("schedule-rule")) {
            field.addEventListener("input", schedule_rule_field_handler);
        };

        // Request new status object, compare to old, update page contents to reflect changes (if any)
        async function updateStatusObject() {
            // Get status object
            var new_status = await fetch("/get_status/" + target_node);
            new_status = await new_status.json();

            // If unable to connect
            if (selected_node_unreachable == false && new_status == "Error: Unable to connect.") {
                $("#error-modal").modal("show");
                console.log("Unable to connect to target, will retry every 5 seconds.");
                selected_node_unreachable = true;
                return;

            } else if (selected_node_unreachable == true && new_status != "Error: Unable to connect.") {
                $("#error-modal").modal("hide");
                console.log("Re-connected to target.");
                selected_node_unreachable = false;
            } else if (selected_node_unreachable == true) {
                // Prevent iterating error message in loop below
                return;
            };

            // Find changes
            for (let section in new_status) {
                for (let instance in new_status[section]) {
                    for (let param in new_status[section][instance]) {
                        if (JSON.stringify(new_status[section][instance][param]) != JSON.stringify(target_node_status[section][instance][param])) {

                            if (param == "turned_on") {
                                // Get element
                                const button = document.getElementById(instance + "-power-state");

                                // Device turned ON since last status update
                                if (new_status[section][instance][param]) {
                                    button.classList.remove("toggle-off");
                                    button.classList.add("toggle-on");

                                // Device turned OFF since last status update
                                } else {
                                    button.classList.remove("toggle-on");
                                    button.classList.add("toggle-off");
                                };

                            } else if (param == "current_rule" || param == "scheduled_rule") {
                                try {
                                    // TODO shouldn't move slider while user is moving it (currently jumps back to current rule every time this runs)
                                    const slider = document.getElementById(instance + "-rule");

                                    slider.value = new_status[section][instance]["current_rule"];
                                    $('input[type="range"]').rangeslider('update', true);

                                    // Select handle element closest to slider, update current rule displayed
                                    var $handle = $('.rangeslider__handle', document.getElementById(instance + '-rule').nextSibling);
                                    $handle[0].textContent = document.getElementById(instance + '-rule').value;

                                    if (new_status[section][instance]["current_rule"] != new_status[section][instance]["scheduled_rule"]) {
                                        // Show reset button
                                        document.getElementById(instance + "-rule-reset").style.visibility = "visible";
                                    } else {
                                        // Hide reset button
                                        document.getElementById(instance + "-rule-reset").style.visibility = "hidden";
                                    };
                                } catch(err) {};

                            } else if (param == "enabled") {
                                if (new_status[section][instance]["enabled"]) {
                                    // Move toggle, collapse card
                                    document.getElementById(instance + "-enable-toggle").checked = true;
                                    $('#' + instance + '-body').collapse('show')

                                } else {
                                    // Move toggle, collapse card
                                    document.getElementById(instance + "-enable-toggle").checked = false;
                                    $('#' + instance + '-body').collapse('hide')

                                };

                            } else if (param == "temp") {
                                document.getElementById("temperature").innerHTML = new_status[section][instance]["temp"].toFixed(2)

                            } else if (param == "humid") {
                                document.getElementById("humidity").innerHTML = new_status[section][instance]["humid"].toFixed(2)

                            } else if (param == "schedule") {
                                updateScheduleRules(instance, target_node_status[section][instance]["schedule"], new_status[section][instance]["schedule"]);

//                             } else if (param == "") {

                            // TODO Continue adding endpoints here as they are implemented

                            };
                        };
                    };
                };
            };

            // Do not overwrite old config with error (if connection lost, will have nothing to compare against when re-connected)
            if (!selected_node_unreachable && !status_lock) {
                target_node_status = new_status;
            };
        }

        // Called by updateStatusObject, passes instance name, schedule rules from last status object, schedule rules from current status object
        // Finds new, deleted, or modified rules and updates table to reflect
        function updateScheduleRules(instance, old_rules, new_rules) {
            var table = document.getElementById(`${instance}-rules`);
            var rows = Array.from(table.rows);

            // Find deleted rules
            for (let time in old_rules) {
                if (!new_rules[time]) {
                    // Deleted rule found - iterate table rows, find rule, remove
                    for (row of rows) {
                        if (row.cells[0].children[0]?.dataset.original == time) {
                            row.remove();
                            break;
                        };
                    };
                };
            };

            // Find new or modified rules
            for (let time in new_rules) {
                if (!old_rules[time]) {
                    // New rule found (didn't exist in old). Get new row number
                    const row = parseInt(rows[rows.length-1].id.split("-")[2]) + 1

                    // Add row number + instance id + rule vlaues to template
                    var template = `<tr id="${instance}-row-${row}">
                                        <td><input type="time" class="form-control" id="schedule-${instance}-rule${row}-time" placeholder="HH:MM" name="schedule-${instance}-rule${row}-time" value=${time} data-original=${time}></td>
                                        <td><input type="text" class="form-control" id="schedule-${instance}-rule${row}-value" placeholder="" name="schedule-${instance}-rule${row}-value" value=${new_rules[time]} data-original=${new_rules[time]}></td>
                                        <td class="min"><button type="button" class="remove btn btn-sm btn-danger mt-1" id="${instance}-remove${row}" onclick="delete_rule(this)"><i class="bi-trash"></i></button></td>
                                    </tr>`

                    // Add new row
                    table.insertAdjacentHTML('beforeend', template);

                    // Add listeners, changes delete button to add button if user modifies fields (newly added rows don't have listener until add button clicked)
                    document.getElementById(`schedule-${instance}-rule${row}-time`).addEventListener("input", schedule_rule_field_handler);
                    document.getElementById(`schedule-${instance}-rule${row}-value`).addEventListener("input", schedule_rule_field_handler);

                } else if (new_rules[time] != old_rules[time]) {
                    // Timestamp unchanged, rule changed
                    console.log("overwriting rule")
                    for (row of rows) {
                        if (row.cells[0].children[0]?.value == time) {
                            row.cells[1].children[0].value = new_rules[time];
                            row.cells[1].children[0].dataset.original = new_rules[time];
                        };
                    };
                };
            };
        };

        // Query status every 5 seconds
        function monitorSelectedNodeStatus(start) {
            if (start) {
                statusTimer = setInterval(updateStatusObject, 5000);
            } else {
                clearInterval(statusTimer);
            };
        };

        // Start monitoring
        monitorSelectedNodeStatus(true);

        // Listen for system theme changes, switch to dark/light mode to reflect (responsive)
        window.matchMedia('(prefers-color-scheme: dark)').addListener(function (e) {
            if (e.matches) { // Returns True for dark mode, False otherwise
                document.body.classList.add("dark");
                document.getElementById("back_button").classList.remove("btn-light");
                document.getElementById("back_button").classList.add("btn-dark");
                document.getElementById("more_options_button").classList.remove("btn-light");
                document.getElementById("more_options_button").classList.add("btn-dark");
                document.getElementById("more_options_menu").classList.add("dropdown-menu-dark");
            } else {
                document.body.classList.remove("dark");
                document.getElementById("back_button").classList.remove("btn-dark");
                document.getElementById("back_button").classList.add("btn-light");
                document.getElementById("more_options_button").classList.remove("btn-dark");
                document.getElementById("more_options_button").classList.add("btn-light");
                document.getElementById("more_options_menu").classList.remove("dropdown-menu-dark");
            }
        });
    </script>
</body>
</html>
