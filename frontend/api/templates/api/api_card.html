{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
    <title>{{ context.metadata.id }} - Micropython Smarthome API</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="{% static 'node_configuration/bootstrap.min.css' %}">
    <link rel="stylesheet" href="{% static 'node_configuration/bootstrap-icons.css' %}">
    <link rel="stylesheet" href="{% static 'node_configuration/style.css' %}">
    <link rel="stylesheet" href="{% static 'api/sliders.css' %}">
    <link rel="stylesheet" href="{% static 'api/animations.css' %}">
    {% if context.metadata.ir_blaster == True %}
    <link rel="stylesheet" href="{% static 'api/remote.css' %}">
    {% endif %}
    <script src="{% static 'node_configuration/popper.min.js' %}"></script>
    <script src="{% static 'node_configuration/bootstrap.min.js' %}"></script>
    <script src="{% static 'node_configuration/jquery.min.js' %}"></script>
    <script src="{% static 'api/rangeslider.min.js' %}"></script>
    <script src="{% static 'api/smoothscroll.min.js' %}"></script>

    <script>

        function getCookie(name) {
            var cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                var cookies = document.cookie.split(';');
                for (var i = 0; i < cookies.length; i++) {
                    var cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        };

    </script>
    <style>
        /* Limit width for readability on large screen sizes */
        @media (min-width: 1200px) {
            .container {
                width: 960px;
            }
        }

        /* Block double tap zoom on mobile, allows pressing buttons quickly */
        body {
            touch-action: manipulation;
        }

        /* Contrasting background for dropdowns in api rule modal */
        body.dark .modal-dropdown {
            background-color: #1b1e1f !important;
        }
    </style>
</head>

<body>
    <div class="container">
        {% if context %}

            <div class="d-flex justify-content-between">
                <button type="button" class="btn my-auto" id="back_button" onclick="window.location.href = '/api'"><i class="bi-chevron-left"></i></button>
                <h1 class="my-3">{{context.metadata.id}}</h1>
                <div class="dropdown my-auto">
                    <button type="button" class="btn" id="more_options_button" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi-list"></i></button>
                    <ul id="more_options_menu" class="dropdown-menu dropdown-menu-end" aria-labelledby="more_options_button">
                        <li><a class="dropdown-item" onclick="send_command({'command': 'reboot'});">Reboot</a></li>
                        <li><a class="dropdown-item" onclick="send_command({'command': 'clear_log'});">Clear Log</a></li>
                        <li><a class="dropdown-item" onclick="send_command({'command': 'reset_all_rules'});">Reset all rules</a></li>
                    </ul>
                </div>
            </div>

            <!-- Check if user is in dark mode, change theme (runs here to prevent visual flash) -->
            <script>
                if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                    document.body.classList.add("dark");
                    document.getElementById("back_button").classList.add("btn-dark");
                    document.getElementById("more_options_button").classList.add("btn-dark");
                    console.log("Dark mode");
                } else {
                    document.getElementById("back_button").classList.add("btn-light");
                    document.getElementById("more_options_button").classList.add("btn-light");
                };
            </script>

            <div class="row">

<!--      SENSORS      -->
                <div id="sensor-cards" class="col-sm">

                    {% for sensor, params in context.sensors.items %}

                        <div id="{{sensor}}-card" class="card">
                            <div class="card-body d-flex flex-column">
                                <div class="d-flex justify-content-between">
                                    {% if not params.type in "pir,desktop,dummy" %}
                                    <button class="btn btn-outline-secondary trigger-button my-auto me-auto" id="{{sensor}}-trigger" style="visibility: hidden;" disabled><i class="bi-exclamation-lg"></i></button>
                                    {% elif params.condition_met %}
                                    <button class="btn btn-outline-secondary trigger-button my-auto me-auto trigger-on" id="{{sensor}}-trigger" autocomplete="off" onclick="trigger(this)"><i class="bi-exclamation-lg"></i></button>
                                    {% else %}
                                    <button class="btn btn-outline-secondary trigger-button my-auto me-auto" id="{{sensor}}-trigger" autocomplete="off" onclick="trigger(this)"><i class="bi-exclamation-lg"></i></button>
                                    {% endif %}
<!--                                     <button type="button" class="btn btn-primary my-auto"><i class="bi-exclamation-lg"></i></button> -->
                                    <h4 class="card-title mx-auto my-auto" id="{{sensor}}-title">{{ params.nickname }}</h4>
                                    <div class="dropdown ms-auto my-auto">
                                        <button type="button" class="btn btn-outline-secondary menu-button" id="{{sensor}}-menu-button" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi-list"></i></button>
                                        <ul id="{{sensor}}-menu" class="dropdown-menu dropdown-menu-end" aria-labelledby="{{sensor}}-menu-button">
                                            {% if params.enabled %}
                                                <li><a id="{{sensor}}-enable" class="dropdown-item" onclick="enable_disable_handler(this);">Disable</a></li>
                                            {% else %}
                                                <li><a id="{{sensor}}-enable" class="dropdown-item" onclick="enable_disable_handler(this);">Enable</a></li>
                                            {% endif %}
                                            <li><a id="{{sensor}}-reset" class="dropdown-item" onclick="reset(this);">Reset rule</a></li>
                                            <li><a id="{{sensor}}-targets" class="dropdown-item" onclick="show_targets(this);">Show targets</a></li>
                                        </ul>
                                    </div>
                                </div>

                                {% if params.enabled %}
                                    <div class="collapse show" id="{{sensor}}-body">
                                {% else %}
                                    <div class="collapse" id="{{sensor}}-body">
                                {% endif %}

                                <!-- Rule slider -->
                                {% if params.type == "pir" %}

                                    <div class="d-flex flex-row align-items-center mt-4 mb-4 pb-3">
                                        <button id="{{sensor}}-rule-down" class="btn btn-sm me-1" onclick="rule_slider_increment(this);" data-stepsize="1"><i class="bi-dash-lg"></i></button>
                                        <input id="{{sensor}}-rule" type="range" class="current-rule-slider mx-auto" min="0" max="60" data-displaymin="0" data-displaymax="60" data-displaytype="float" step="0.5" value="{{params.current_rule}}" autocomplete="off">
                                        <button id="{{sensor}}-rule-up" class="btn btn-sm ms-1" onclick="rule_slider_increment(this);" data-stepsize="1"><i class="bi-plus-lg"></i></button>
                                    </div>

                                {% elif params.type == "si7021" %}
                                    <table class="table table-borderless mt-3">
                                        <tbody>
                                            <tr>
                                                <th class="text-center w-50 pb-0">Temperature</th>
                                                <th class="text-center w-50 pb-0">Humidity</th>
                                            </tr>
                                            <tr>
                                                <td class="text-center fs-5" id="temperature">{{params.temp|floatformat:"2"}}</td>
                                                <td class="text-center fs-5" id="humidity">{{params.humid|floatformat:"2"}}</td>
                                            </tr>
                                        </tbody>
                                    </table>

                                    <!-- Close climate data card, start new card for thermostat -->
                                    </div></div></div></br>

                                    <!-- Modal for viewing temperature history chart -->
                                    <div class="modal fade" id="chart-modal" tabindex="-1">
                                        <div class="modal-dialog modal-dialog-centered" style="max-width:750px">
                                            <div class="modal-content">
                                                <div class='d-flex m-3'>
                                                    <button type="button" class="btn-close" style="visibility:hidden"></button>
                                                    <h3 class="mx-auto mb-0" id="error-modal-title">Temperature History</h3>
                                                    <button type="button" class="btn-close my-auto" data-bs-dismiss="modal" aria-label="Close"></button>
                                                </div>
                                                <div class="modal-body">
                                                    <canvas id="chart"></canvas>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
                                    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
                                    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-moment"></script>

                                    <script>
                                        // Change previous card title to "Climate Data", old title will be reused in new card below
                                        document.getElementById("{{sensor}}-title").innerHTML = "Climate Data";

                                        // Prevent collapsed climate data card if page loaded while thermostat disabled
                                        document.getElementById("{{sensor}}-body").classList.add("show");

                                        // Prevent collapsing climate data card when disabling sensor
                                        document.getElementById("{{sensor}}-body").id = "climate-data-body";
                                        document.getElementById("{{sensor}}-card").id = "climate-data-card";

                                        // Remove enable/disable toggle, will be moved to new card below
                                        document.getElementById("{{sensor}}-trigger").remove();
                                        document.getElementById("{{sensor}}-menu-button").parentElement.remove();

                                        // Create arrays to store temp readings, timestamps
                                        var temp_history = [];
                                        var temp_history_labels = [];

                                        // Create chart, displayed in modal created above
                                        const temp_history_chart = new Chart(document.getElementById('chart'), {
                                            type: 'line',
                                            data: {
                                                labels: temp_history_labels,
                                                datasets: [{
                                                    data: temp_history,
                                                    label: "Temp",
                                                    borderColor: '#eee',
                                                    color: '#eee',
                                                    fill: true
                                                }]
                                            },
                                            options: {
                                                plugins: {
                                                    legend: {
                                                        display: false,
//                                                         labels: {
//                                                             color: "#eee",
//                                                             usePointStyle: true,
//                                                             pointStyle: "rectRounded"
//                                                         }
                                                    }
                                                },
                                                scales: {
                                                    x: {
                                                        type: 'timeseries',
                                                        time: {
                                                            unit: 'minute',
                                                            displayFormats: {
                                                                minute: 'H:mm:ss'
                                                            }
                                                        },
                                                        ticks:{
                                                            source: 'data',
                                                            color: "#eee"
                                                        },
                                                    },
                                                    y: {
                                                        suggestedMin: 70,
                                                        suggestedMax: 75,
                                                        ticks:{
                                                            color: "#eee",
                                                            stepSize: 1,
                                                        }
                                                    }
                                                }
                                            }
                                        });
                                    </script>

                                    <div id="{{sensor}}-card" class="card">
                                        <div class="card-body d-flex flex-column">
                                            <div class="d-flex justify-content-between">
                                                <button class="btn btn-outline-secondary trigger-button my-auto me-auto" id="{{sensor}}-trigger" style="visibility: hidden;" disabled><i class="bi-exclamation-lg"></i></button>
                                                <h4 class="card-title mx-auto" id="{{sensor}}-title">{{ params.nickname }}</h4>

                                                <div class="dropdown ms-auto my-auto">
                                                    <button type="button" class="btn btn-outline-secondary menu-button" id="{{sensor}}-menu-button" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi-list"></i></button>
                                                    <ul id="{{sensor}}-menu" class="dropdown-menu dropdown-menu-end" aria-labelledby="{{sensor}}-menu-button">
                                                        {% if params.enabled %}
                                                            <li><a id="{{sensor}}-enable" class="dropdown-item" onclick="enable_disable_handler(this);">Disable</a></li>
                                                        {% else %}
                                                            <li><a id="{{sensor}}-enable" class="dropdown-item" onclick="enable_disable_handler(this);">Enable</a></li>
                                                        {% endif %}
                                                        <li><a id="{{sensor}}-reset" class="dropdown-item" onclick="reset(this);">Reset rule</a></li>
                                                        <li><a id="{{sensor}}-targets" class="dropdown-item" onclick="show_targets(this);">Show targets</a></li>
                                                        <li><a class="dropdown-item" onclick="$('#chart-modal').modal('show');">View history</a></li>
                                                    </ul>
                                                </div>
                                            </div>

                                            {% if params.enabled %}
                                                <div class="collapse show" id="{{sensor}}-body">
                                            {% else %}
                                                <div class="collapse" id="{{sensor}}-body">
                                            {% endif %}

                                            <!-- Range slider -->
                                            <div class="d-flex flex-row align-items-center mt-4 mb-4 pb-3">
                                                <button id="{{sensor}}-rule-down" class="btn btn-sm me-1" onclick="rule_slider_increment(this);" data-stepsize="0.5"><i class="bi-dash-lg"></i></button>
                                                <input id="{{sensor}}-rule" type="range" class="current-rule-slider mx-auto" min="65" max="80" data-displaymin="65" data-displaymax="80" data-displaytype="float" step="0.1" value="{{params.current_rule}}" autocomplete="off">
                                                <button id="{{sensor}}-rule-up" class="btn btn-sm ms-1" onclick="rule_slider_increment(this);" data-stepsize="0.5"><i class="bi-plus-lg"></i></button>
                                            </div>

                                {% endif %}
                                <!-- End rule slider -->

                                <!-- Schedule rules section, collapsed by default -->
                                <p class="text-center mt-3">
                                    <button id="{{sensor}}-open-rules" class="btn btn-sm btn-primary" type="button" data-bs-toggle="collapse" data-bs-target="#{{sensor}}-schedule-rules" aria-expanded="false" aria-controls="{{sensor}}-schedule-rules" onclick="open_rules(this)">
                                        Schedule rules
                                    </button>
                                </p>
                                <div class="collapse" id="{{sensor}}-schedule-rules">

                                    <table id="{{sensor}}-rules" class="table table-borderless">
                                        <tr>
                                            <th style="text-align: left;">Time</th>
                                            <th style="text-align: left;">Rule</th>
                                        </tr>

                                        {% if params.schedule.items|length > 0 %}
                                            {% for time, rule in params.schedule.items %}
                                                <tr id="{{sensor}}-row-{{forloop.counter}}">
                                                    {# Add time field #}
                                                    <td><input type="time" class="form-control schedule-rule" id="{{sensor}}-rule{{forloop.counter}}-time" placeholder="HH:MM" name="{{sensor}}-rule{{forloop.counter}}-time" value="{{ time }}" data-original="{{ time }}" data-bs-toggle="tooltip" data-bs-trigger="manual" title="Rule at this time already exists" autocomplete="off"></td>

                                                    {# Add correct input for each sensor type #}
                                                    {% if params.type == "pir" %}
                                                        <td style="width: 100%">
                                                            <div class="d-flex flex-row align-items-center mt-2 pt-1">
                                                                <input id="{{sensor}}-rule{{forloop.counter}}" name="{{sensor}}-rule{{forloop.counter}}" type="range" class="schedule-rule mx-auto" min="0" max="60" data-displaymin="0" data-displaymax="60" data-displaytype="float" step="0.5" value="{{ rule }}" data-original="{{ rule }}" data-bs-toggle="tooltip" data-bs-trigger="manual" title="Invalid rule" autocomplete="off">
                                                            </div>
                                                        </td>

                                                    {% elif params.type == "switch" or params.type == "desktop" %}
                                                        <td><select id="{{sensor}}-rule{{forloop.counter}}" name="{{sensor}}-rule{{forloop.counter}}" class="form-select schedule-rule" value="{{ rule }}" data-original="{{ rule }}" data-bs-toggle="tooltip" data-bs-trigger="manual" title="Invalid rule" autocomplete="off">
                                                            <option disabled>Select rule</option>
                                                            <option value="enabled" {% if rule|lower == "enabled" %} selected {% endif %}>Enabled</option>
                                                            <option value="disabled" {% if rule|lower == "disabled" %} selected {% endif %}>Disabled</option>
                                                        </select></td>

                                                    {% elif params.type == "dummy" %}
                                                        <td><select id="{{sensor}}-rule{{forloop.counter}}" name="{{sensor}}-rule{{forloop.counter}}" class="form-select schedule-rule" value="{{ rule }}" data-original="{{ rule }}" data-bs-toggle="tooltip" data-bs-trigger="manual" title="Invalid rule" autocomplete="off">
                                                            <option disabled>Select rule</option>
                                                            <option value="enabled" {% if rule|lower == "enabled" %} selected {% endif %}>Enabled</option>
                                                            <option value="disabled" {% if rule|lower == "disabled" %} selected {% endif %}>Disabled</option>
                                                            <option value="on" {% if rule|lower == "on" %} selected {% endif %}>On</option>
                                                            <option value="off" {% if rule|lower == "off" %} selected {% endif %}>Off</option>
                                                        </select></td>

                                                    {% elif params.type == "si7021" %}
                                                        <td><input id="{{sensor}}-rule{{forloop.counter}}" name="{{sensor}}-rule{{forloop.counter}}" type="range" class="schedule-rule mx-auto" min="65" max="80" data-displaymin="65" data-displaymax="80" data-displaytype="float" step="0.5" value="{{ rule }}" data-original="{{ rule }}" data-bs-toggle="tooltip" data-bs-trigger="manual" title="Invalid rule" autocomplete="off"></td>
                                                    {% endif %}

                                                    {# Add delete button #}
                                                    <td class="min"><button type="button" class="remove btn btn-sm btn-danger mt-1" id="{{sensor}}-remove{{forloop.counter}}"  onclick="delete_rule(this)"><i class="bi-trash"></i></button></td>
                                                </tr>
                                            {% endfor %}
                                        {% else %}
                                            <tr id="{{sensor}}-row-1">
                                                {# Add time field #}
                                                <td><input type="time" class="form-control" id="{{sensor}}-rule1-time" placeholder="HH:MM" name="{{sensor}}-rule1-time" data-bs-toggle="tooltip" data-bs-trigger="manual" title="Rule at this time already exists"></td>

                                                {# Add correct input for each sensor type #}
                                                {% if params.type == "pir" %}
                                                    <td style="width: 100%">
                                                        <div class="d-flex flex-row align-items-center mt-2 pt-1">
                                                            <input id="{{sensor}}-rule1" name="{{sensor}}-rule1" type="range" class="schedule-rule mx-auto" min="0" max="60" data-displaymin="0" data-displaymax="60" data-displaytype="float" step="0.5" data-bs-toggle="tooltip" data-bs-trigger="manual" title="Invalid rule" autocomplete="off">
                                                        </div>
                                                    </td>

                                                {% elif params.type == "switch" or params.type == "desktop" %}
                                                    <td><select id="{{sensor}}-rule1" name="{{sensor}}-rule1" class="form-select schedule-rule" data-bs-toggle="tooltip" data-bs-trigger="manual" title="Invalid rule" autocomplete="off">
                                                        <option>Select rule</option>
                                                        <option value="enabled">Enabled</option>
                                                        <option value="disabled">Disabled</option>
                                                    </select></td>

                                                {% elif params.type == "dummy" %}
                                                    <td><select id="{{sensor}}-rule1" name="{{sensor}}-rule1" class="form-select schedule-rule" data-bs-toggle="tooltip" data-bs-trigger="manual" title="Invalid rule" autocomplete="off">
                                                        <option>Select rule</option>
                                                        <option value="enabled">Enabled</option>
                                                        <option value="disabled">Disabled</option>
                                                        <option value="on">On</option>
                                                        <option value="off">Off</option>
                                                    </select></td>

                                                {% elif params.type == "si7021" %}
                                                    <td><input id="{{sensor}}-rule1" name="{{sensor}}-rule1" type="range" class="schedule-rule mx-auto" min="65" max="80" data-displaymin="65" data-displaymax="80" data-displaytype="float" step="0.5" data-bs-toggle="tooltip" data-bs-trigger="manual" title="Invalid rule" autocomplete="off"></td>
                                                {% endif %}

                                                {# Add add_rule button #}
                                                <td class="min"><button type="button" class="remove btn btn-sm btn-success mt-1" id="{{sensor}}-add1" onclick="add_rule(this)"><i class="bi-plus-lg"></i></button></td>
                                            </tr>
                                        {% endif %}
                                    </table>

                                    <div class="text-center mx-3 mb-3">
                                        <button type="button" class="btn btn-secondary btn-sm add" id="{{sensor}}-add-rule" onclick="add_rule_row(this)"><i class="bi-plus-lg"></i></button>
                                    </div>

                                    <!-- If no rules exist, hide add rule button (blank row above already has add button) -->
                                    {% if params.schedule.items|length == 0 %}
                                        <script>
                                            document.getElementById("{{sensor}}-add-rule").style.display = "none";
                                        </script>
                                    {% endif %}

                                </div>
                                <!-- End schedule rules section -->
                            </div>
                        </div>
                        </div></br>
                    {% endfor %}
                </div>

<!--      DEVICES      -->
                <div id="device-cards" class="col-sm">

                    {% for device, params in context.devices.items %}

                        <div id="{{device}}-card" class="card">
                            <div class="card-body d-flex flex-column">
                                <div class="d-flex justify-content-between">
                                    {% if params.turned_on %}
                                        <button class="btn btn-outline-secondary power-button my-auto me-auto toggle-on" id="{{device}}-power-state" autocomplete="off" onclick="power(this)"><i class="bi-lightbulb"></i></button>
                                    {% else %}
                                        <button class="btn btn-outline-secondary power-button my-auto me-auto" id="{{device}}-power-state" autocomplete="off" onclick="power(this)"><i class="bi-lightbulb"></i></button>
                                    {% endif %}
<!--                                     <button type="button" class="btn btn-primary my-auto"><i class="bi-exclamation-lg"></i></button> -->
                                    <h4 class="card-title mx-auto my-auto" id="{{device}}-title">{{ params.nickname }}</h4>

                                    <div class="dropdown my-auto ms-auto">
                                        <button type="button" class="btn btn-outline-secondary menu-button" id="{{device}}-menu-button" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi-list"></i></button>
                                        <ul id="{{device}}-menu" class="dropdown-menu dropdown-menu-end" aria-labelledby="{{device}}-menu-button">
                                            {% if params.enabled %}
                                                <li><a id="{{device}}-enable" class="dropdown-item" onclick="enable_disable_handler(this);">Disable</a></li>
                                            {% else %}
                                                <li><a id="{{device}}-enable" class="dropdown-item" onclick="enable_disable_handler(this);">Enable</a></li>
                                            {% endif %}
                                            <li><a id="{{device}}-reset" class="dropdown-item" onclick="reset(this);">Reset rule</a></li>
                                            {% if params.type == "api-target" %}
                                                <li><a id="{{device}}-current_rule-button" class="dropdown-item" onclick="open_rule_modal(this);">Change rule</a></li>
                                            {% endif %}
                                        </ul>
                                    </div>
                                </div>

                                {% if params.enabled %}
                                    <div class="collapse show" id="{{device}}-body">
                                {% else %}
                                    <div class="collapse" id="{{device}}-body">
                                {% endif %}

                                <!-- Rule slider -->
                                {% if params.type in "dimmer,bulb" %}

                                    <div class="d-flex flex-row align-items-center mt-4 mb-4 pb-3">
                                        <button id="{{device}}-rule-down" class="btn btn-sm me-1" onclick="rule_slider_increment(this);" data-stepsize="1"><i class="bi-dash-lg"></i></button>
                                        <input id="{{device}}-rule" type="range" class="current-rule-slider mx-auto" min="1" max="100" data-displaymin="1" data-displaymax="100" data-displaytype="int" value="{{params.current_rule}}" autocomplete="off">
                                        <button id="{{device}}-rule-up" class="btn btn-sm ms-1" onclick="rule_slider_increment(this);" data-stepsize="1"><i class="bi-plus-lg"></i></button>
                                    </div>
                                {% elif params.type == "pwm" %}

                                    <div class="d-flex flex-row align-items-center mt-4 mb-4 pb-3">
                                        <button id="{{device}}-rule-down" class="btn btn-sm me-1" onclick="rule_slider_increment(this);" data-stepsize="10"><i class="bi-dash-lg"></i></button>
                                        <input id="{{device}}-rule" type="range" class="current-rule-slider mx-auto" min="0" max="1023" data-displaymin="0" data-displaymax="100" data-displaytype="int" value="{{params.current_rule}}" autocomplete="off">
                                        <button id="{{device}}-rule-up" class="btn btn-sm ms-1" onclick="rule_slider_increment(this);" data-stepsize="10"><i class="bi-plus-lg"></i></button>
                                    </div>

                                {% endif %}

                                <!-- End rule slider -->

                                {% if params.type == "api-target" %}
                                    <div style="display:none;">
                                        <input id="{{device}}-current_rule" type="text" autocomplete="off" value="{{params.current_rule}}" onchange="change_api_target_rule(this);">
                                    </div>
                                {% endif %}

                                <!-- Schedule rules section, collapsed by default -->
                                <p class="text-center mt-3">
                                    <button id="{{device}}-open-rules" class="btn btn-sm btn-primary" type="button" data-bs-toggle="collapse" data-bs-target="#{{device}}-schedule-rules" aria-expanded="false" aria-controls="{{device}}-schedule-rules" onclick="open_rules(this)">
                                        Schedule rules
                                    </button>
                                </p>
                                <div class="collapse" id="{{device}}-schedule-rules">

                                    <table id="{{device}}-rules" class="table table-borderless">
                                        <tr>
                                            <th style="text-align: left;">Time</th>
                                            <th style="text-align: left;">Rule</th>
                                        </tr>

                                        {% if params.schedule.items|length > 0 %}
                                            {% for time, rule in params.schedule.items %}
                                                <tr id="{{device}}-row-{{forloop.counter}}">
                                                    {# Add time field #}
                                                    <td><input type="time" class="form-control schedule-rule" id="{{device}}-rule{{forloop.counter}}-time" placeholder="HH:MM" name="{{device}}-rule{{forloop.counter}}-time" value="{{ time }}" data-original="{{ time }}" data-bs-toggle="tooltip" data-bs-trigger="manual" title="Rule at this time already exists" autocomplete="off"></td>

                                                    {# Add correct input for each device type #}
                                                    {% if params.type == "dimmer" or params.type == "bulb" %}
                                                        <td><input type="text" class="form-control schedule-rule" id="{{device}}-rule{{forloop.counter}}" placeholder="" name="{{device}}-rule{{forloop.counter}}" value="{{ rule }}" data-original="{{ rule }}" data-bs-toggle="tooltip" data-bs-trigger="manual" title="Invalid rule" autocomplete="off"></td>

                                                    {% elif params.type == "relay" or params.type == "dumb-relay" or params.type == "desktop" or params.type == "mosfet" %}
                                                        <td><select id="{{device}}-rule{{forloop.counter}}" name="{{device}}-rule{{forloop.counter}}" class="form-select schedule-rule" value="{{ rule }}" data-original="{{ rule }}" data-bs-toggle="tooltip" data-bs-trigger="manual" title="Invalid rule" autocomplete="off">
                                                            <option disabled>Select rule</option>
                                                            <option value="enabled" {% if rule|lower == "enabled" %} selected {% endif %}>Enabled</option>
                                                            <option value="disabled" {% if rule|lower == "disabled" %} selected {% endif %}>Disabled</option>
                                                        </select></td>

                                                    {% elif params.type == "pwm" %}
                                                        <td style="width: 100%">
                                                            <div class="d-flex flex-row align-items-center mt-2 pt-1">
                                                                <input id="{{device}}-rule{{forloop.counter}}" name="{{device}}-rule{{forloop.counter}}" type="range" class="schedule-rule mx-auto" min="0" max="1023" data-displaymin="0" data-displaymax="100" data-displaytype="int" step="1" value="{{ rule }}" data-original="{{ rule }}" data-bs-toggle="tooltip" data-bs-trigger="manual" title="Invalid rule" autocomplete="off">
                                                            </div>
                                                        </td>

                                                    {% elif params.type == "api-target" %}
                                                        <td style="width: 100%"><button id="{{device}}-rule{{forloop.counter}}-button" class="form-control" onclick="open_rule_modal(this);" type="button" data-bs-toggle="tooltip" data-bs-trigger="manual" title="Invalid rule">Set rule</button>
                                                        <input type="text" class="form-control rule {{device}}" id="{{device}}-rule{{forloop.counter}}" value="{{ rule }}" data-original="{{ rule }}" style="display:none;"></td>

                                                    {% endif %}

                                                    {# Add delete button #}
                                                    <td class="min"><button type="button" class="remove btn btn-sm btn-danger mt-1" id="{{device}}-remove{{forloop.counter}}"  onclick="delete_rule(this)"><i class="bi-trash"></i></button></td>
                                                </tr>
                                            {% endfor %}
                                        {% else %}
                                            <tr id="{{device}}-row-1">
                                                {# Add time field #}
                                                <td><input type="time" class="form-control" id="{{device}}-rule1-time" placeholder="HH:MM" name="{{device}}-rule1-time" data-bs-toggle="tooltip" data-bs-trigger="manual" title="Rule at this time already exists"></td>

                                                {# Add correct input for each device type #}
                                                {% if params.type == "dimmer" or params.type == "bulb" %}
                                                    <td><input type="text" class="form-control" id="{{device}}-rule1" placeholder="" name="{{device}}-rule1" data-bs-toggle="tooltip" data-bs-trigger="manual" title="Invalid rule"></td>

                                                {% elif params.type == "relay" or params.type == "dumb-relay" or params.type == "desktop" or params.type == "mosfet" %}
                                                    <td><select id="{{device}}-rule1" name="{{device}}-rule1" class="form-select schedule-rule" data-bs-toggle="tooltip" data-bs-trigger="manual" title="Invalid rule" autocomplete="off">
                                                        <option>Select rule</option>
                                                        <option value="enabled">Enabled</option>
                                                        <option value="disabled">Disabled</option>
                                                    </select></td>

                                                {% elif params.type == "pwm" %}
                                                    <td style="width: 100%">
                                                        <div class="d-flex flex-row align-items-center mt-2 pt-1">
                                                            <input id="{{device}}-rule1" name="{{device}}-rule1" type="range" class="schedule-rule mx-auto" min="0" max="1023" data-displaymin="0" data-displaymax="100" data-displaytype="int" step="1" data-bs-toggle="tooltip" data-bs-trigger="manual" title="Invalid rule" autocomplete="off">
                                                        </div>
                                                    </td>

                                                {% elif params.type == "api-target" %}
                                                    <td style="width: 100%"><button id="{{device}}-rule1-button" class="form-control" onclick="open_rule_modal(this);" type="button">Set rule</button>
                                                    <input type="text" class="form-control rule {{device}}" id="{{device}}-rule1" value="" style="display:none;"></td>

                                                {% endif %}

                                                {# Add add_rule button #}
                                                <td class="min"><button type="button" class="remove btn btn-sm btn-success mt-1" id="{{device}}-add1" onclick="add_rule(this)"><i class="bi-plus-lg"></i></button></td>
                                            </tr>
                                        {% endif %}
                                    </table>

                                    {# Add add button #}
                                    <div class="text-center mx-3 mb-3">
                                        <button type="button" class="btn btn-secondary btn-sm add" id="{{device}}-add-rule" onclick="add_rule_row(this)"><i class="bi-plus-lg"></i></button>
                                    </div>

                                    <!-- If no rules exist, hide add rule button (blank row above already has add button) -->
                                    {% if params.schedule.items|length == 0 %}
                                        <script>
                                            document.getElementById("{{device}}-add-rule").style.display = "none";
                                        </script>
                                    {% endif %}

                                </div>
                                <!-- End schedule rules section -->

                                </div>

                            </div>
                        </div></br>

                    {% endfor %}

                    {% if context.metadata.ir_blaster == True %}

                        {% if context.sensors|length == 0 and context.devices|length == 0 %}
                            <!-- If target node ONLY has IR blaster, close device column, start new column for remotes -->
                            </div>
                            <div id="remote-cards">
                        {% endif %}

                        <div class="d-flex flex-column pb-4">
                            <div class="row text-center remote remote-top mx-auto" style="position: relative;">
                                <!-- Title is narrower than body due to mx-auto - add invisible buttons to reserve correct width -->
                                <button class="col m-3 btn btn-lg btn-primary" type="button" style="visibility: hidden;height: 0px;"><i class="bi-question"></i></button>
                                <button class="col m-3 btn btn-lg btn-primary" type="button" style="visibility: hidden;height: 0px;"><i class="bi-question"></i></button>
                                <button class="col m-3 btn btn-lg btn-primary" type="button" style="visibility: hidden;height: 0px;"><i class="bi-question"></i></button>
                                <!-- Position title on top of invisible buttons -->
                                <h4 class="mt-2" style="position: absolute;align: center;">TV Remote</h4>
                            </div>
                            <div class="row pb-3 remote mx-auto" id="width-test" style="position: relative;">
                                <button class="col m-3 btn btn-lg btn-primary" type="button" onclick="send_command({'command': 'ir', 'ir_target': 'tv', 'key': 'power'});" title="Power"><i class="bi-power"></i></button>
                                <button class="col m-3 btn btn-lg btn-primary" type="button" style="visibility: hidden;"><i class="bi-question"></i></button>
                                <button class="col m-3 btn btn-lg btn-primary" type="button" onclick="send_command({'command': 'ir', 'ir_target': 'tv', 'key': 'source'});" title="Source"><i class="bi-upload"></i></button>
                            </div>
                            <div class="row remote mx-auto" style="width: auto;">
                                <button class="col m-3 btn btn-lg btn-primary" type="button" style="visibility: hidden;"><i class="bi-question"></i></button>
                                <button class="col m-3 btn btn-lg btn-primary" type="button" onclick="send_command({'command': 'ir', 'ir_target': 'tv', 'key': 'up'});" title="Up"><i class="bi bi-arrow-up"></i></button>
                                <button class="col m-3 btn btn-lg btn-primary" type="button" style="visibility: hidden;"><i class="bi-question"></i></button>
                            </div>
                            <div class="row remote mx-auto" style="width: auto;">
                                <button class="col m-3 btn btn-lg btn-primary" type="button" onclick="send_command({'command': 'ir', 'ir_target': 'tv', 'key': 'left'});" title="Left"><i class="bi bi-arrow-left"></i></button>
                                <button class="col m-3 btn btn-lg btn-primary" type="button" onclick="send_command({'command': 'ir', 'ir_target': 'tv', 'key': 'enter'});" title="Enter"><i class="bi bi-app"></i></button>
                                <button class="col m-3 btn btn-lg btn-primary" type="button" onclick="send_command({'command': 'ir', 'ir_target': 'tv', 'key': 'right'});" title="right"><i class="bi bi-arrow-right"></i></button>
                            </div>
                            <div class="row pb-3 remote mx-auto" style="width: auto;">
                                <button class="col m-3 btn btn-lg btn-primary" type="button" style="visibility: hidden;"><i class="bi-question"></i></button>
                                <button class="col m-3 btn btn-lg btn-primary" type="button" onclick="send_command({'command': 'ir', 'ir_target': 'tv', 'key': 'down'});" title="Down"><i class="bi bi-arrow-down"></i></button>
                                <button class="col m-3 btn btn-lg btn-primary" type="button" style="visibility: hidden;"><i class="bi-question"></i></button>
                            </div>
                            <div class="row remote mx-auto" style="width: auto;">
                                <button class="col m-3 btn btn-lg btn-primary" type="button" onclick="send_command({'command': 'ir', 'ir_target': 'tv', 'key': 'vol_down'});" title="Volume Down"><i class="bi-volume-down-fill"></i></button>
                                <button class="col m-3 btn btn-lg btn-primary" type="button" onclick="send_command({'command': 'ir', 'ir_target': 'tv', 'key': 'mute'});" title="Mute"><i class="bi-volume-mute-fill"></i></button>
                                <button class="col m-3 btn btn-lg btn-primary" type="button" onclick="send_command({'command': 'ir', 'ir_target': 'tv', 'key': 'vol_up'});" title="Volume Up"><i class="bi-volume-up-fill"></i></button>
                            </div>
                            <div class="row remote remote-bottom mx-auto" style="width: auto;">
                                <button class="col m-3 btn btn-lg btn-secondary" type="button" onclick="send_command({'command': 'ir', 'ir_target': 'tv', 'key': 'settings'});" title="Settings"><i class="bi-gear-fill"></i></button>
                                <button class="col m-3 btn btn-lg btn-secondary" type="button" style="visibility: hidden;"><i class="bi-question"></i></button>
                                <button class="col m-3 btn btn-lg btn-secondary" type="button" onclick="send_command({'command': 'ir', 'ir_target': 'tv', 'key': 'exit'});" title="Exit"><i class="bi-arrow-return-left"></i></button>
                            </div>
                        </div>

                        <div class="d-flex flex-column" style="width: auto;">
                            <div class="row text-center remote remote-top mx-auto" style="position: relative;">
                                <!-- Title is narrower than body due to mx-auto - add invisible buttons to reserve correct width -->
                                <button class="col m-3 btn btn-lg btn-primary" type="button" style="visibility: hidden;height: 1px;"><i class="bi-question"></i></button>
                                <button class="col m-3 btn btn-lg btn-primary" type="button" style="visibility: hidden;height: 1px;"><i class="bi-question"></i></button>
                                <button class="col m-3 btn btn-lg btn-primary" type="button" style="visibility: hidden;height: 1px;"><i class="bi-question"></i></button>
                                <!-- Position title on top of invisible buttons -->
                                <h4 class="mt-2" style="position: absolute;align: center;">AC Remote</h4>
                            </div>
                            <div class="row mb-3 py-2 remote remote-bottom mx-auto">
                                <button class="col m-3 btn btn-lg btn-primary" type="button" onclick="send_command({'command': 'ir', 'ir_target': 'ac', 'key': 'stop'});" title="Stop cooling"><i class="bi-wind"></i></button>
                                <button class="col m-3 btn btn-lg btn-primary" type="button" onclick="send_command({'command': 'ir', 'ir_target': 'ac', 'key': 'off'});" title="Turn off fan"><i class="bi-x-octagon-fill"></i></button>
                                <button class="col m-3 btn btn-lg btn-primary" type="button" onclick="send_command({'command': 'ir', 'ir_target': 'ac', 'key': 'start'});" title="Start cooling"><i class="bi-snow"></i></i></button>
                            </div>
                        </div>
                    {% endif %}
                </div>
            </div>

        {% else %}
            <p>FATAL ERROR</p>
        {% endif %}
    </div>

    <!-- Error modal displayed when unable to connect to target node -->

    <div class="modal fade" id="error-modal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header pb-0" style="border-bottom: 0px;">
                    <h3 class="mx-auto mb-0" id="error-modal-title">Connection Error</h3>
                </div>
                <div class="modal-body" id="error-modal-body">
                    <p class="text-center mb-0">Attempting to reestablish connection...</p>
                    <div class="d-flex justify-content-center">
                        <div id="spinner" class="loading-animation loading-animation-show"><div></div><div></div><div></div><div></div></div>
                    </div>
                    <div class="d-flex justify-content-center">
                        <button type="button" id="ok-button" class="btn btn-success" data-bs-dismiss="modal" onclick="window.location.href = '/api'">Back to Overview</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    {% if context.api_target_options %}
    <!-- Api-target set rule modal -->
    <div class="modal fade" id="api-rule-modal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered" style="max-width:750px">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Api Target Rule</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body d-flex flex-column">

                    <button class="btn btn-sm btn-secondary mx-auto mb-3" type="button" data-bs-toggle="collapse" data-bs-target="#api-rule-modal-help" aria-expanded="false" aria-controls="api-rule-modal-help">
                        Help
                    </button>

                    <div class="collapse" id="api-rule-modal-help">
                        <p class="text-center">Just like other devices, ApiTargets can be turned on/off by sensors or manually. Instead of effecting a physical device they fire API commands.</p>

                        <p class="text-center">Commands are sent to the target node, which is selected when creating a config file. This can only be changed by <a href="/edit_config/{{context.metadata.id}}">editing</a> the config file.</p>

                        <p class="text-center">The dropdowns below contain all available options for the current target node. Select a command to fire when this device is turned on, and another for when it is turned off.</p>

                        <p class="text-center">
                            <button class="btn btn-sm btn-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#api-rule-modal-examples" aria-expanded="false" aria-controls="api-rule-modal-examples">
                                Examples
                            </button>
                        </p>

                        <div class="collapse" id="api-rule-modal-examples">
                            <ul>
                                <li>Two nodes with motion sensors can work together to cover a large room. Set Sensor1 to target the lights, then set Sensor2 to activate Sensor1 with the <b>trigger_sensor</b> option.</li>
                                <li>The thermostat can change when a door is open or closed. Set up a door sensor targeting this ApiTarget, then select the thermostat and <b>set_rule</b> command below.</li>
                                <li>Any sensor can turn a TV or Air Conditioner on/off by triggering an ApiTarget targeting an <b>Ir Blaster</b>.</li>
                            </ul>

                            <p class="text-center">
                                <button class="btn btn-sm btn-secondary mb-3" type="button" data-bs-toggle="collapse" data-bs-target="#api-rule-modal-help" aria-expanded="false" aria-controls="api-rule-modal-help">
                                    Close
                                </button>
                            </p>
                        </div>

                    </div>

                    <form name="api_rule_form" id="api_rule_form">
                        <div id="on-action">
                            <select name="instance-on" id="instance-on" class="form-select mb-3 modal-dropdown api-instance">
                                <option value="" selected="selected">Select target instance</option>
                            </select>

                            <select name="command-on" id="command-on" class="form-select mb-3 modal-dropdown api-command">
                                <option value="" selected="selected">Please select instance first</option>
                            </select>

                            <select name="sub-command-on" id="sub-command-on" class="form-select mb-3 modal-dropdown api-command" style="display:none" disabled>
                                <option value="" selected="selected">Please select command first</option>
                            </select>

                            <input name="command-arg-on" id="command-arg-on" class="form-control mb-3 modal-dropdown api-command-arg" style="display:none" disabled>
                        </div>

                        <div id="off-action" style="display:none;">
                            <select name="instance-off" id="instance-off" class="form-select mb-3 modal-dropdown api-instance">
                                <option value="" selected="selected">Select target instance</option>
                            </select>

                            <select name="command-off" id="command-off" class="form-select mb-3 modal-dropdown api-command">
                                <option value="" selected="selected">Please select instance first</option>
                            </select>

                            <select name="sub-command-off" id="sub-command-off" class="form-select mb-3 modal-dropdown api-command" style="display:none" disabled>
                                <option value="" selected="selected">Please select command first</option>
                            </select>

                            <input name="command-arg-off" id="command-arg-off" class="form-control mb-3 modal-dropdown api-command-arg" style="display:none" disabled>
                        </div>
                    </form>

                    <div class="btn-group mx-auto" role="group" aria-label="Basic radio toggle button group">
                        <input type="radio" class="btn-check" name="btnradio" id="on-button" autocomplete="off" onclick="switch_page(this)" checked>
                        <label class="btn btn-outline-secondary ms-auto" for="on-button">On Action</label>

                        <input type="radio" class="btn-check" name="btnradio" id="off-button" autocomplete="off" onclick="switch_page(this)">
                        <label class="btn btn-outline-secondary me-auto" for="off-button">Off Action</label>
                    </div>

                </div>
                <div class="modal-footer">
                    <button type="button" id="submit-api-rule" class="btn btn-success mx-auto" data-bs-dismiss="modal" onclick="submit_api_rule(this)">Submit</button>
                </div>
            </div>
        </div>
    </div>
    <script src="{% static 'node_configuration/apiTargetOptions.js' %}"></script>
    {% endif %}

    <!-- Toast notification shown when schedule rules added/removed -->
    <div class="fixed-bottom">
        <div id="save_rules_toast" class="toast text-center mx-auto mb-3" role="alert" aria-live="assertive" aria-atomic="true" data-bs-delay="10000">
            <div class="toast-body">
                <div id="toast-text" class="mb-2">Should this rule change persist after reboot?</div>
                <button class="btn btn-sm btn-primary me-2" data-bs-dismiss="toast" onclick="send_command({'command': 'save_rules'});">Yes</button>
                <button class="btn btn-sm btn-secondary" data-bs-dismiss="toast">No</button>
            </div>
        </div>
    </div>

    <!-- Save context for later use -->
    {{ context|json_script:"context" }}

    <script>
        const target_node = "{{ context.metadata.ip }}";

        var target_node_status = JSON.parse(document.getElementById("context").textContent);

        if (target_node_status["api_target_options"]) {
            var ApiTargetOptions = target_node_status["api_target_options"];
        };

        // Initial value, used to detect change (lose connection, re-establish connection)
        selected_node_unreachable = false;

        // Prevent multiple functions modifying status object at the same time
        var status_lock = false;

        // Darkmode for elements generated after initial check
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            // Dropdown menus
            Array.from(document.getElementsByClassName("dropdown-menu")).forEach(menu => menu.classList.add("dropdown-menu-dark"));

            // Top-right menu buttons
            Array.from(document.querySelectorAll(".btn-outline-secondary")).forEach(function(button) {
                button.classList.remove('btn-outline-secondary');
                button.classList.add('btn-outline-dark');
            });
        };

        // Listen for system theme changes, switch to dark/light mode to reflect (responsive)
        window.matchMedia('(prefers-color-scheme: dark)').addListener(function (e) {
            if (e.matches) { // Returns True for dark mode, False otherwise
                document.body.classList.add("dark");
                document.getElementById("back_button").classList.remove("btn-light");
                document.getElementById("back_button").classList.add("btn-dark");
                document.getElementById("more_options_button").classList.remove("btn-light");
                document.getElementById("more_options_button").classList.add("btn-dark");
                Array.from(document.getElementsByClassName("dropdown-menu")).forEach(menu => menu.classList.add("dropdown-menu-dark"));

                // Top-right menu buttons + ApiTarget rule modal tab buttons
                Array.from(document.querySelectorAll(".btn-outline-secondary")).forEach(function(button) {
                    button.classList.remove('btn-outline-secondary');
                    button.classList.add('btn-outline-dark');
                });

                {% if context.api_target_options %}
                // Buttons in ApiTarget rule modal
                modal = document.getElementById('api-rule-modal');
                Array.from(modal.querySelectorAll('button')).forEach(function(button) {
                    if (button.classList.contains("btn-secondary")) {
                        button.classList.remove("btn-secondary");
                        button.classList.add("btn-dark");
                    };
                });
                {% endif %}

            } else {
                document.body.classList.remove("dark");
                document.getElementById("back_button").classList.remove("btn-dark");
                document.getElementById("back_button").classList.add("btn-light");
                document.getElementById("more_options_button").classList.remove("btn-dark");
                document.getElementById("more_options_button").classList.add("btn-light");
                Array.from(document.getElementsByClassName("dropdown-menu")).forEach(menu => menu.classList.remove("dropdown-menu-dark"));

                // Top-right menu buttons + ApiTarget rule modal tab buttons
                Array.from(document.querySelectorAll(".btn-outline-dark")).forEach(function(button) {
                    button.classList.remove('btn-outline-dark');
                    button.classList.add('btn-outline-secondary');
                });

                {% if context.api_target_options %}
                // Buttons in ApiTarget rule modal
                modal = document.getElementById('api-rule-modal');
                Array.from(modal.querySelectorAll('button')).forEach(function(button) {
                    if (button.classList.contains("btn-dark")) {
                        button.classList.remove("btn-dark");
                        button.classList.add("btn-secondary");
                    };
                });
                {% endif %}
            }
        });
    </script>
    <script src="{% static 'api/rule_sliders.js' %}"></script>
    <script src="{% static 'api/schedule_rules.js' %}"></script>
    <script src="{% static 'api/update_status.js' %}"></script>
    <script src="{% static 'api/api_card.js' %}"></script>
</body>
</html>
